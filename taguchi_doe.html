<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taguchi DOE Calculator & Analyzer | Orthogonal Array Generator</title>
    <link rel="canonical" href="https://sigmaexacta.com/taguchi_doe" />
    <meta name="description"
        content="Free online Taguchi DOE calculator to create and analyze robust experiments. Generate L4, L8, L9, L16 orthogonal arrays, calculate S/N ratios, find optimal factor levels, and perform ANOVA. An essential tool for quality engineering, process optimization, and robust design.">
    <meta name="keywords"
        content="open source, free software, SigmaExacta, taguchi calculator, doe calculator, taguchi method, taguchi, design of experiments, doe, orthogonal array, L4, L8, L9, L16, s/n ratio, signal to noise, robust design, anova, process optimization, quality engineering, ANOVA, Analysis of Variance">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" href="sigma-exacta-icon.jpg" type="image/jpeg">

    <!-- KaTeX para renderizar f√≥rmulas matem√°ticas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>

    <link rel="stylesheet" href="styles.css">

    <!-- Carga de la l√≥gica de c√°lculo externa -->
    <script src="taguchi_calculator.js"></script>

    <style>
        /* Estilos base (Manteniendo los originales) */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --success-bg-color: #e8f8f5;
            font-size: 16px;
            --professional-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --professional-border: 1px solid #e1e5e9;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Nunito', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f5f7fa;
            line-height: 1.6;
        }

        img,
        canvas {
            max-width: 100%;
            height: auto;
        }

        .main-content-wrapper {
            padding: 1.25rem;
        }

        .main-content-wrapper>.header,
        .main-content-wrapper>.container {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .header {
            text-align: center;
            padding: 1rem 0;
            margin-bottom: 1.25rem;
            border-bottom: 1px solid #ddd;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: clamp(1.5rem, 4vw, 1.8rem);
            margin: 0.5rem 0;
            font-weight: 800;
        }

        .header p {
            color: #7f8c8d;
            max-width: 700px;
            margin: 0 auto;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: var(--primary-color);
            margin-top: 0;
            font-weight: 800;
        }

        h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 800;
        }

        .container ol,
        .container ul {
            padding-left: 1.25rem;
            line-height: 1.8;
        }

        /* ===== ESTILOS DE TABS (WIZARD) - IMPORTADOS DE TRIZ ===== */
        .tabs-nav {
            display: flex;
            background-color: #f1f5f9;
            border-radius: 8px 8px 0 0;
            overflow-x: auto;
            border-bottom: 2px solid var(--secondary-color);
            margin-bottom: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .tabs-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 700;
            color: #64748b;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
        }

        @media (min-width: 992px) {
            .tabs-nav {
                overflow-x: hidden;
            }

            .tab-btn {
                flex: 1;
                justify-content: center;
                padding: 1rem 0.5rem;
            }
        }

        .tab-btn:hover {
            background-color: #e2e8f0;
            color: var(--primary-color);
        }

        .tab-btn.active {
            background-color: #fff;
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
            border-radius: 8px 8px 0 0;
            margin-bottom: -2px;
            border-left: 1px solid #e1e5e9;
            border-right: 1px solid #e1e5e9;
            border-top: 1px solid #e1e5e9;
        }

        .tab-content {
            display: none;
            padding: 2rem;
            background: #fff;
            border: 1px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 8px 8px;
            animation: fadeIn 0.3s ease;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-nav-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .btn-next-tab {
            background-color: var(--primary-color);
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-next-tab:hover {
            background-color: #34495e;
        }

        /* ===== FIN ESTILOS TABS ===== */

        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        input,
        select,
        button,
        textarea {
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
            font-family: 'Nunito', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
            padding: 0.75rem 1.25rem;
            margin-top: 1rem;
            font-weight: 600;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:focus-visible,
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }

        button.danger {
            background-color: var(--accent-color);
        }

        button.danger:hover {
            background-color: #c0392b;
        }

        button.add-factor {
            background-color: var(--success-color);
        }

        button.add-factor:hover {
            background-color: #27ae60;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
            display: block;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        th,
        td {
            border: 1px solid #e0e0e0;
            padding: 0.75rem;
            text-align: center;
            white-space: normal;
        }

        th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #f1f7fd;
        }

        .hidden {
            display: none;
        }

        .factor-inputs {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .factor-inputs input {
            flex: 1;
        }

        .remove-factor {
            background-color: var(--accent-color);
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-top: 0;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .button-group button {
            flex: 1;
            min-width: 150px;
            margin-top: 0;
        }

        .snr-type-selector label {
            display: inline-block;
            margin-right: 1rem;
            cursor: pointer;
        }

        .snr-type-selector input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }

        .interpretation {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            border-left: 4px solid var(--secondary-color);
        }

        .optimal-levels,
        .conclusion-box {
            background-color: var(--success-bg-color);
            padding: 1rem;
            border-radius: 6px;
            margin: 1.25rem 0;
            border-left: 4px solid var(--success-color);
        }

        .charts-parent-container {
            display: flex;
            gap: 1.25rem;
            flex-wrap: wrap;
            justify-content: center;
            margin: 2rem 0;
        }

        .chart-wrapper {
            flex: 1;
            min-width: 300px;
            max-width: 450px;
            position: relative;
            height: 350px;
            border: 1px solid #ddd;
            padding: 0.8rem;
            border-radius: 8px;
            background-color: #fdfdfd;
        }

        .factor-table th {
            background-color: var(--primary-color);
        }

        .highlight {
            background-color: #fffacd;
            font-weight: bold;
        }

        .info-icon {
            cursor: help;
            color: var(--secondary-color);
            margin-left: 8px;
            font-size: 0.9em;
        }

        .anova-table th.significant {
            background-color: var(--success-color);
        }

        .anova-table td.significant {
            background-color: var(--success-bg-color);
            font-weight: bold;
        }

        .conclusion-box ul {
            list-style-type: none;
            padding-left: 0;
        }

        .conclusion-box li {
            margin-bottom: 0.6rem;
            display: flex;
            align-items: flex-start;
        }

        .conclusion-box li .fas {
            margin-right: 10px;
            color: var(--success-color);
            font-size: 1.2rem;
            padding-top: 4px;
        }

        .conclusion-box li .summary-text {
            word-break: break-word;
            min-width: 0;
        }

        .analysis-run-report {
            border: 1px solid #ddd;
            padding: 1.5rem;
            margin-top: 2rem;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        footer {
            padding: 2rem 1.25rem;
            text-align: center;
        }

        .disclaimer-note {
            margin-top: 2rem;
            padding: 0 1rem;
            font-size: 0.8rem;
            color: #777;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .formula-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            text-align: center;
            margin-top: 1.5rem;
        }

        .formula-item {
            padding: 1.5rem 1rem;
            border: 1px solid #eee;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 120px;
            font-size: 1.1em;
        }

        .formula-item h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .legend {
            margin-top: 2rem;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fdfdfd;
        }

        .legend h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .legend ul {
            list-style: none;
            padding: 0;
        }

        .legend li {
            margin-bottom: 0.5rem;
        }

        .legend code {
            background-color: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .katex {
            font-size: 1.1rem !important;
        }

        .katex-display {
            margin: 1rem 0 !important;
        }

        @media (max-width: 768px) {
            .factor-inputs {
                flex-direction: column;
                align-items: stretch;
            }

            .remove-factor {
                width: 100%;
                margin-top: 0.5rem;
            }

            .formula-grid {
                grid-template-columns: 1fr;
            }

            .katex {
                font-size: 1rem !important;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <!-- Contenedor para cargar el header din√°micamente -->
    <div id="header-container"></div>

    <noscript>
        <nav>
            <a href="/">Home</a> |
            <a href="/taguchi_doe">Taguchi DOE</a>
            <!-- Links b√°sicos -->
        </nav>
    </noscript>

    <main class="main-content-wrapper">
        <header class="header">
            <h1><span
                    style="display: inline-flex; justify-content: center; align-items: center; width: 42px; height: 42px; background-color: #673ab7; border-radius: 8px; margin-right: 12px; vertical-align: middle;"><i
                        class="fas fa-flask" style="color: white; font-size: 22px;"></i></span> Free Online Robust
                Design (Taguchi Method) Tool</h1>
            <p>Plan and analyze robust experiments using Orthogonal Arrays to optimize product and process quality.</p>
        </header>

        <!-- Navegaci√≥n por pesta√±as (Estilo TRIZ) -->
        <nav class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('tab-start')"><i class="fas fa-info-circle"></i> Start &
                Info</button>
            <button class="tab-btn" onclick="switchTab('tab-setup')"><i class="fas fa-cogs"></i> Setup
                Experiment</button>
            <button class="tab-btn" onclick="switchTab('tab-data')"><i class="fas fa-table"></i> Design & Data</button>
            <button class="tab-btn" onclick="switchTab('tab-analysis')"><i class="fas fa-chart-bar"></i> Analysis &
                Report</button>
            <button class="tab-btn" onclick="switchTab('tab-formulas')"><i class="fas fa-calculator"></i>
                Formulas</button>
        </nav>

        <!-- TAB 1: Start & Info -->
        <div id="tab-start" class="tab-content active">
            <div style="margin-bottom: 2rem;">
                <h2><i class="fas fa-question-circle"></i> What is the Taguchi Method?</h2>
                <p>The <strong>Taguchi Method</strong>, developed by Japanese engineer and statistician Genichi Taguchi,
                    is
                    a systematic approach to improving product and process quality through robust design. Unlike
                    traditional
                    experimental design methods that focus primarily on optimizing mean performance, the Taguchi Method
                    emphasizes minimizing the effects of uncontrollable factors (noise) to create products and processes
                    that perform consistently under varying conditions.</p>
                <p>The core principles of the Taguchi Method include:</p>
                <ul>
                    <li><strong>Robust Design:</strong> Designing products and processes that are insensitive to
                        variations
                        in manufacturing, environmental conditions, and component aging.</li>
                    <li><strong>Quality Loss Function:</strong> Quantifying the economic loss when a product deviates
                        from
                        its target value, even if it remains within specification limits.</li>
                    <li><strong>Orthogonal Arrays:</strong> Using specially designed fractional factorial experiments
                        that
                        allow testing multiple factors simultaneously with a minimal number of experimental runs.</li>
                    <li><strong>Signal-to-Noise (S/N) Ratios:</strong> Metrics that simultaneously consider both the
                        mean
                        performance and variability, helping identify factor settings that maximize performance while
                        minimizing variation.</li>
                </ul>
            </div>

            <div style="margin-bottom: 2rem;">
                <h2><i class="fas fa-history"></i> Brief History of the Taguchi Method</h2>
                <p>The Taguchi Method was developed by <strong>Genichi Taguchi</strong> in the 1950s while he was
                    working at
                    the Electrical Communications Laboratory (ECL) of Nippon Telegraph and Telephone (NTT) in Japan. His
                    early work focused on improving telephone switching systems, where he recognized that traditional
                    quality control methods were insufficient for preventing quality loss throughout the product
                    lifecycle.
                </p>
                <p>Taguchi's key insight was that <strong>quality should be measured by the deviation from a target
                        value</strong>, not just by conformance to specification limits. He introduced the concept of
                    the
                    <strong>Quality Loss Function</strong>, which mathematically represents the economic loss incurred
                    when
                    a product characteristic deviates from its ideal value.
                </p>
            </div>

            <div style="margin-bottom: 2rem;">
                <h2><i class="fas fa-list-ol"></i> How to Use This Tool</h2>
                <ol>
                    <li>Go to the <strong>Setup Experiment</strong> tab.</li>
                    <li><strong>Load Data or Start Fresh:</strong> Use "Load Example Data" for a quick demo or fill in
                        the
                        setup fields yourself.</li>
                    <li><strong>Experiment Setup:</strong> Give your experiment a name and objective.</li>
                    <li><strong>Define Factors and Levels:</strong> Add factors (variables) and their levels (settings).
                    </li>
                    <li><strong>Generate Design:</strong> Click "Generate Taguchi Design". This will take you to the
                        <strong>Design & Data</strong> tab.
                    </li>
                    <li><strong>Enter Data:</strong> Enter your measured results for each run.</li>
                    <li><strong>Calculate:</strong> Click "Calculate Full Analysis". This will take you to the
                        <strong>Analysis & Report</strong> tab.
                    </li>
                </ol>
            </div>

            <div class="tab-nav-buttons">
                <button class="btn-next-tab" onclick="switchTab('tab-setup')">Next Step: Setup Experiment <i
                        class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- TAB 2: Setup Experiment -->
        <div id="tab-setup" class="tab-content">
            <button type="button" id="load-example-btn" class="add-factor"
                style="margin-top: 0; margin-bottom: 1.5rem;">üìã Load Example Data & Auto-Fill Results</button>

            <h2>Experiment Setup</h2>
            <div class="form-group">
                <label for="experiment-name">Experiment Name:</label>
                <input type="text" id="experiment-name" placeholder="E.g., Coffee Brewing Optimization" value="">
            </div>
            <div class="form-group">
                <label for="objective">Experiment Objective:</label>
                <textarea id="objective" placeholder="Describe the goal, e.g., to maximize coffee flavor"></textarea>
            </div>

            <h3>Factors and Levels</h3>
            <div id="factors-container"></div>
            <button type="button" id="add-factor" class="add-factor">‚ûï Add Factor</button>

            <div class="form-group">
                <label for="response-variable">Response Variable:</label>
                <input type="text" id="response-variable" placeholder="E.g., Flavor Score (1-10)" value="">
            </div>

            <div class="form-group">
                <label for="array-select">Select Taguchi Array
                    <i class="fas fa-info-circle info-icon"
                        title="An Orthogonal Array allows studying many factors with a small number of experiments, saving time and resources. 'Automatic' selects the most efficient array for your setup."></i>
                </label>
                <select id="array-select">
                    <option value="">-- Automatic selection (recommended) --</option>
                    <option value="L4">L4 (up to 3 factors, 2 levels)</option>
                    <option value="L8">L8 (up to 7 factors, 2 levels)</option>
                    <option value="L9">L9 (up to 4 factors, 3 levels)</option>
                    <option value="L16">L16 (up to 15 factors, 2 levels)</option>
                </select>
            </div>

            <div class="form-group snr-type-selector">
                <label>Signal-to-Noise Ratio Type
                    <i class="fas fa-info-circle info-icon"
                        title="S/N ratio measures robustness. Choose 'Smaller' to minimize things like defects or cost. Choose 'Larger' to maximize things like strength or yield. Choose 'Nominal' to hit a specific target value, like a dimension."></i>
                </label>
                <div>
                    <label><input type="radio" name="snr-type" value="smaller" checked> Smaller is better
                        (Minimize)</label>
                    <label><input type="radio" name="snr-type" value="larger"> Larger is better (Maximize)</label>
                    <label><input type="radio" name="snr-type" value="nominal"> Nominal is best (Target)</label>
                </div>
                <div id="nominal-target-group" class="form-group hidden" style="margin-top: 1rem;">
                    <label for="nominal-target">Target Value (for Nominal is best):</label>
                    <input type="number" id="nominal-target" step="any" placeholder="Enter target value">
                </div>
            </div>

            <div class="button-group">
                <button type="button" id="reset-form-btn" class="danger">‚ùå Reset Form</button>
            </div>

            <button type="button" id="generate-design" style="width: 100%; margin-top: 2rem; font-size: 1.1em;">üîß
                Generate Taguchi Design</button>
        </div>

        <!-- TAB 3: Design & Data -->
        <div id="tab-data" class="tab-content">
            <div id="results-container-data">
                <div id="design-and-data-section">
                    <h2><i class="fas fa-table"></i> Design & Data Entry</h2>
                    <p style="margin-bottom: 1rem;">The Orthogonal Array below shows the experiments you need to
                        perform. Enter your measured results in the rightmost column.</p>
                    <div id="experiment-info"></div>
                    <div id="orthogonal-array"></div>
                    <button type="button" id="calculate-analysis" style="width: 100%; font-size: 1.1em;">üìä Calculate
                        Full Analysis</button>
                </div>
            </div>
        </div>

        <!-- TAB 4: Analysis & Report -->
        <div id="tab-analysis" class="tab-content">
            <div id="results-container-analysis">
                <div id="analysis-output-section" class="hidden">
                    <div id="analysis-history-container"></div>
                    <hr style="margin: 2rem 0;">
                    <div class="button-group">
                        <button type="button" id="export-excel">üìã Export to Excel</button>
                    </div>
                    <div id="success-message" class="success-message"
                        style="display:none; background-color: var(--success-bg-color); color: var(--success-color); border: 1px solid var(--success-color); padding: 1rem; border-radius: 6px; margin-top: 1rem; text-align: center;">
                        Excel file generated successfully!
                    </div>
                </div>
                <div id="no-analysis-msg" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                    <p><i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem;"></i></p>
                    <p>No analysis generated yet. Please enter data in the "Design & Data" tab and click "Calculate Full
                        Analysis".</p>
                </div>
            </div>
        </div>

        <!-- TAB 5: Formulas -->
        <div id="tab-formulas" class="tab-content">
            <h2><i class="fas fa-calculator"></i> Mathematical Formulas</h2>
            <div class="formula-grid">
                <div class="formula-item">
                    <h3>Signal-to-Noise Ratio (Smaller is Better)</h3>
                    <div>$$ S/N = -10 \log_{10} \left( \frac{1}{n} \sum_{i=1}^{n} y_i^2 \right) $$</div>
                    <p>Where \( y_i \) are the measured responses and \( n \) is the number of observations.</p>
                </div>
                <div class="formula-item">
                    <h3>Signal-to-Noise Ratio (Larger is Better)</h3>
                    <div>$$ S/N = -10 \log_{10} \left( \frac{1}{n} \sum_{i=1}^{n} \frac{1}{y_i^2} \right) $$</div>
                    <p>Where \( y_i \) are the measured responses and \( n \) is the number of observations.</p>
                </div>
                <div class="formula-item">
                    <h3>Signal-to-Noise Ratio (Nominal is Best)</h3>
                    <div>$$ S/N = -10 \log_{10} \left( \frac{1}{n} \sum_{i=1}^{n} (y_i - T)^2 \right) $$</div>
                    <p>Where \( T \) is the target value, \( y_i \) are the measured responses, and \( n \) is the
                        number of observations.</p>
                </div>
                <div class="formula-item">
                    <h3>Mean Response</h3>
                    <div>$$ \bar{y} = \frac{1}{n} \sum_{i=1}^{n} y_i $$</div>
                    <p>Where \( y_i \) are the measured responses and \( n \) is the number of observations.</p>
                </div>
                <div class="formula-item">
                    <h3>Main Effect</h3>
                    <div>$$ ME = \frac{\sum \text{Responses at Level } i}{\text{Number of observations at Level } i} $$
                    </div>
                    <p>Where \( i \) represents a specific factor level.</p>
                </div>
                <div class="formula-item">
                    <h3>ANOVA Sum of Squares</h3>
                    <div>$$ SS = \sum_{i=1}^{k} n_i (\bar{y}_i - \bar{y})^2 $$</div>
                    <p>Where \( n_i \) is the number of observations at level \( i \), \( \bar{y}_i \) is the mean at
                        level \( i \), and \( \bar{y} \) is the overall mean.</p>
                </div>
            </div>
            <div class="legend">
                <h3>Taguchi Method Legend</h3>
                <ul>
                    <li><code>S/N</code>: Signal-to-Noise Ratio - measures robustness against noise factors</li>
                    <li><code>\( y_i \)</code>: Individual measured response value</li>
                    <li><code>\( T \)</code>: Target value for nominal-is-best characteristics</li>
                    <li><code>\( n \)</code>: Number of observations or experimental runs</li>
                    <li><code>ME</code>: Main Effect - average response at a specific factor level</li>
                    <li><code>SS</code>: Sum of Squares - measures variation attributed to a factor</li>
                    <li><code>ANOVA</code>: Analysis of Variance - statistical method to determine factor significance
                    </li>
                </ul>
            </div>
        </div>
    </main>

    <footer>
        <div class="disclaimer-note">
            <p><strong>Disclaimer:</strong> The tools and information provided on Sigma Exacta are for informational and
                educational purposes only. The tools on this site are independent implementations and are not affiliated
                with, sponsored by, or endorsed by the original creators of these methodologies. While we strive for
                accuracy, we make no warranty or guarantee regarding the results. All calculations and decisions based
                on the output of these tools are the sole responsibility of the user.</p>
        </div>
    </footer>

    <script>
        // Cargar el header din√°micamente
        fetch('header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
                initializeMenu();
            })
            .catch(error => console.error('Error loading header:', error));

        function initializeMenu() {
            const navToggle = document.getElementById('nav-toggle');
            const navMenu = document.getElementById('nav-menu');
            const toolsDropdownToggle = document.getElementById('tools-dropdown-toggle');
            const toolsDropdownMenu = document.getElementById('tools-dropdown-menu');
            const toolsDropdownContainer = document.getElementById('tools-dropdown-container');

            if (navToggle && navMenu) {
                navToggle.addEventListener('click', () => {
                    navMenu.classList.toggle('show-menu');
                    const icon = navToggle.querySelector('i');
                    icon.classList.toggle('fa-bars');
                    icon.classList.toggle('fa-times');
                    if (!navMenu.classList.contains('show-menu')) {
                        toolsDropdownMenu.classList.remove('show-submenu');
                        toolsDropdownContainer.classList.remove('active');
                    }
                });
            }

            if (toolsDropdownToggle && toolsDropdownMenu && toolsDropdownContainer) {
                toolsDropdownToggle.addEventListener('click', (event) => {
                    if (window.innerWidth <= 992) {
                        event.preventDefault();
                        toolsDropdownMenu.classList.toggle('show-submenu');
                        toolsDropdownContainer.classList.toggle('active');
                    }
                });
            }
        }

        // L√≥gica de Tabs
        function switchTab(tabId) {
            // Quitar clase active de todos los botones y contenidos
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Activar el seleccionado
            document.getElementById(tabId).classList.add('active');

            // Activar bot√≥n correspondiente
            const activeBtn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Scroll al top suavemente
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        const DOM = {
            addFactorBtn: document.getElementById('add-factor'),
            generateDesignBtn: document.getElementById('generate-design'),
            calculateAnalysisBtn: document.getElementById('calculate-analysis'),
            exportExcelBtn: document.getElementById('export-excel'),
            loadExampleBtn: document.getElementById('load-example-btn'),
            resetFormBtn: document.getElementById('reset-form-btn'),
            // Removed global resultsContainer reference since we split it
            designAndDataSection: document.getElementById('design-and-data-section'),
            analysisOutputSection: document.getElementById('analysis-output-section'),
            factorsContainer: document.getElementById('factors-container'),
            orthogonalArrayDiv: document.getElementById('orthogonal-array'),
            experimentInfoDiv: document.getElementById('experiment-info'),
            analysisHistoryContainer: document.getElementById('analysis-history-container'),
            successMessage: document.getElementById('success-message'),
            noAnalysisMsg: document.getElementById('no-analysis-msg'),
        };

        let experimentData = {}, allCharts = [], calculationCount = 0;

        const logoImage = new Image();
        const logoPlugin = {
            id: 'sigmaExactaLogo',
            afterDraw: (chart) => {
                if (logoImage.complete) {
                    const ctx = chart.ctx;
                    const logoSize = 30;
                    const margin = 10;
                    ctx.drawImage(logoImage, margin, margin, logoSize, logoSize);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            Chart.register(logoPlugin);
            logoImage.src = 'sigma-exacta-icon.jpg';

            resetForm();
            DOM.addFactorBtn.addEventListener('click', () => addFactorInput());
            DOM.generateDesignBtn.addEventListener('click', generateDesign);
            DOM.calculateAnalysisBtn.addEventListener('click', runFullAnalysis);
            DOM.exportExcelBtn.addEventListener('click', exportToExcel);
            DOM.loadExampleBtn.addEventListener('click', loadExampleData);
            DOM.resetFormBtn.addEventListener('click', resetForm);

            document.querySelectorAll('input[name="snr-type"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    experimentData.snrType = this.value;
                    const targetGroup = document.getElementById('nominal-target-group');
                    if (this.value === 'nominal') {
                        targetGroup.classList.remove('hidden');
                    } else {
                        targetGroup.classList.add('hidden');
                    }
                });
            });
        });

        function resetExperimentData() {
            experimentData = {
                name: '', objective: '', factors: [], responseVariable: '',
                selectedArray: null, results: [], snrType: 'smaller', nominalTarget: null,
                factorEffects: {}, anova: {}, predictedResult: null, optimalSettings: {}
            };
        }

        function resetForm() {
            document.getElementById('experiment-name').value = '';
            document.getElementById('objective').value = '';
            document.getElementById('response-variable').value = '';
            document.getElementById('array-select').value = '';
            document.querySelector('input[name="snr-type"][value="smaller"]').checked = true;
            document.getElementById('nominal-target-group').classList.add('hidden');
            document.getElementById('nominal-target').value = '';
            DOM.factorsContainer.innerHTML = '';

            DOM.analysisOutputSection.classList.add('hidden');
            DOM.noAnalysisMsg.style.display = 'block';
            DOM.orthogonalArrayDiv.innerHTML = '<p class="text-center" style="color:#7f8c8d; padding: 2rem;">No design generated yet. Please complete setup in the "Setup Experiment" tab.</p>';
            DOM.experimentInfoDiv.innerHTML = '';

            DOM.analysisHistoryContainer.innerHTML = '';
            resetExperimentData();
            if (allCharts.length > 0) { allCharts.forEach(c => c.destroy()); allCharts = []; }
            calculationCount = 0;
            switchTab('tab-start');
        }

        function loadExampleData() {
            // 1. Resetear el formulario para empezar limpio
            document.getElementById('reset-form-btn').click();

            // 2. Rellenar datos b√°sicos
            document.getElementById('experiment-name').value = 'Process Optimization Study';
            document.getElementById('objective').value = 'Minimize defects in the production process while maintaining quality standards';
            document.getElementById('response-variable').value = 'Defect rate (%)';

            // 3. A√±adir factores
            addFactorInput('Temperature', '100¬∞C, 120¬∞C');
            addFactorInput('Pressure', '50 psi, 60 psi');
            addFactorInput('Speed', 'Low, High');
            addFactorInput('Material', 'Type A, Type B');

            // 4. Generar el dise√±o autom√°ticamente
            generateDesign();

            // 5. Rellenar los resultados de "Defect Rate %" autom√°ticamente
            // Como usamos 4 factores de 2 niveles, se generar√° un L8 (normalmente)
            const inputs = document.querySelectorAll('.response-input');
            const dummyData = [5.2, 4.8, 2.1, 2.5, 4.9, 5.1, 1.8, 2.0]; // Datos de ejemplo para L8

            inputs.forEach((input, index) => {
                // Si hay m√°s inputs que dummyData, repetimos o generamos aleatorio
                const val = dummyData[index] !== undefined ? dummyData[index] : (Math.random() * 5).toFixed(1);
                input.value = val;
                // Disparar evento change para que se guarde en experimentData
                input.dispatchEvent(new Event('change'));
            });

            // 6. Cambiar a la pesta√±a de datos para que el usuario vea lo ocurrido
            switchTab('tab-data');

            // Opcional: Podr√≠amos ejecutar calculateAnalysis autom√°ticamente, 
            // pero es mejor dejar que el usuario haga clic para ver el flujo.
        }

        function addFactorInput(name = '', levels = '') {
            const factorDiv = document.createElement('div');
            factorDiv.className = 'factor-inputs';
            factorDiv.innerHTML = `<input type="text" class="factor-name" placeholder="Factor name" value="${name}" required><input type="text" class="factor-levels" placeholder="Levels (comma separated)" value="${levels}" required><button type="button" class="remove-factor danger" title="Remove factor">‚àí</button>`;
            DOM.factorsContainer.appendChild(factorDiv);
            factorDiv.querySelector('.remove-factor').addEventListener('click', () => factorDiv.remove());
        }

        function generateDesign() {
            DOM.analysisHistoryContainer.innerHTML = '';
            if (allCharts.length > 0) { allCharts.forEach(c => c.destroy()); allCharts = []; }
            calculationCount = 0;
            DOM.analysisOutputSection.classList.add('hidden');
            DOM.noAnalysisMsg.style.display = 'block';

            resetExperimentData();

            experimentData.name = document.getElementById('experiment-name').value;
            experimentData.objective = document.getElementById('objective').value;
            experimentData.responseVariable = document.getElementById('response-variable').value;
            experimentData.snrType = document.querySelector('input[name="snr-type"]:checked').value;
            experimentData.factors = [];

            document.querySelectorAll('.factor-inputs').forEach(input => {
                const name = input.querySelector('.factor-name').value;
                const levelsStr = input.querySelector('.factor-levels').value;
                if (name && levelsStr) {
                    const levels = levelsStr.split(',').map(level => level.trim()).filter(Boolean);
                    if (levels.length >= 2) experimentData.factors.push({ name, levels });
                }
            });

            if (!experimentData.name || !experimentData.objective || !experimentData.responseVariable || experimentData.factors.length === 0) {
                alert('Please fill in all experiment information and add at least one factor.');
                return;
            }

            const selectedArray = document.getElementById('array-select').value;
            let arrayKey = selectedArray;
            if (!arrayKey) {
                const maxLevels = Math.max(...experimentData.factors.map(f => f.levels.length));
                const numFactors = experimentData.factors.length;
                if (maxLevels <= 2) {
                    if (numFactors <= 3) arrayKey = 'L4';
                    else if (numFactors <= 7) arrayKey = 'L8';
                    else if (numFactors <= 15) arrayKey = 'L16';
                } else if (maxLevels === 3 && numFactors <= 4) arrayKey = 'L9';
                if (!arrayKey) {
                    alert('Could not automatically select an array for your combination of factors and levels. Please choose a suitable one manually.');
                    return;
                }
            }

            experimentData.selectedArray = TaguchiCalculator.orthogonalArrays[arrayKey];
            generateDesignTable();

            // Cambiar autom√°ticamente a la pesta√±a de datos
            switchTab('tab-data');
        }

        function generateDesignTable() {
            DOM.experimentInfoDiv.innerHTML = `<p><strong>Experiment Name:</strong> ${experimentData.name}</p><p><strong>Objective:</strong> ${experimentData.objective}</p>`;
            let tableHTML = `<table><thead><tr><th>Run</th>${experimentData.factors.map(f => `<th>${f.name}</th>`).join('')}<th>${experimentData.responseVariable}</th></tr></thead><tbody>`;
            experimentData.selectedArray.array.forEach((run, index) => {
                tableHTML += `<tr><td>${index + 1}</td>`;
                for (let i = 0; i < experimentData.factors.length; i++) {
                    const factor = experimentData.factors[i];
                    const levelIndex = Math.min(run[i] - 1, factor.levels.length - 1);
                    tableHTML += `<td>${factor.levels[levelIndex]}</td>`;
                }
                tableHTML += `<td><input type="number" class="response-input" step="any" placeholder="Enter value"></td></tr>`;
            });
            tableHTML += '</tbody></table>';
            DOM.orthogonalArrayDiv.innerHTML = tableHTML;
            experimentData.results = Array(experimentData.selectedArray.runs).fill(null);
            document.querySelectorAll('.response-input').forEach((input, index) => {
                input.addEventListener('change', () => {
                    experimentData.results[index] = parseFloat(input.value);
                });
            });
        }

        function runFullAnalysis() {
            if (experimentData.results.some(val => val === null || isNaN(val))) {
                alert('Please fill in all response values before running the analysis.');
                return;
            }

            let target = null;
            if (experimentData.snrType === 'nominal') {
                const targetInput = document.getElementById('nominal-target');
                if (!targetInput.value || isNaN(parseFloat(targetInput.value))) {
                    alert('"Nominal is best" S/N ratio requires a Target Value. Please enter a target value before calculating.');
                    targetInput.focus();
                    return;
                }
                target = parseFloat(targetInput.value);
            }

            calculationCount++;
            experimentData = TaguchiCalculator.runAnalysis(experimentData, target);

            // Cambiar a la pesta√±a de an√°lisis PRIMERO para que los gr√°ficos se rendericen bien
            switchTab('tab-analysis');
            DOM.noAnalysisMsg.style.display = 'none';
            DOM.analysisOutputSection.classList.remove('hidden');

            createAndDisplayReportBlock(calculationCount);

            // Renderizar f√≥rmulas matem√°ticas en el nuevo contenido
            renderMathInElement(document.getElementById(`analysis-run-${calculationCount}`));

            document.getElementById(`analysis-run-${calculationCount}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function createAndDisplayReportBlock(runId) {
            const reportWrapper = document.createElement('div');
            reportWrapper.id = `analysis-run-${runId}`;
            reportWrapper.className = 'analysis-run-report';
            reportWrapper.innerHTML = ` 
            <div id="executive-summary-${runId}"></div> 
            <hr style="margin: 2rem 0;"> 
            <div class="effects-analysis"> 
                <h3><i class="fas fa-chart-bar"></i> Effects Analysis (Run #${runId})</h3> 
                <h4>Factor Influence (Pareto Chart)</h4> 
                <p>This chart sorts factors from most to least influential, helping you focus on what truly matters.</p> 
                <div style="position: relative; height:400px; margin: 2rem auto; max-width: 800px;"> 
                    <canvas id="pareto-chart-${runId}"></canvas> 
                </div> 
                <h4>Main Effects Plots</h4> 
                <p>These plots show how each factor level affects the response. Look for steep lines, which indicate a strong effect.</p> 
                <div id="charts-parent-container-${runId}" class="charts-parent-container"></div> 
                <h4>Factor Effects Tables</h4> 
                <div id="factor-effects-content-${runId}"></div> 
                <h4>Analysis of Variance (ANOVA) <i class="fas fa-info-circle info-icon" title="ANOVA determines if a factor's effect is statistically significant or just random noise. Factors with 'Significance = Yes' have a proven impact."></i> </h4> 
                <p>This table provides statistical evidence for factor influence. Factors marked as significant have a real, measurable effect on the outcome.</p> 
                <div id="anova-table-container-${runId}"></div> 
            </div> 
            <hr style="margin: 2rem 0;"> 
            <div id="snr-section-${runId}"> 
                <div class="snr-results"> 
                    <h3><i class="fas fa-wave-square"></i> Signal-to-Noise Ratio Analysis</h3> 
                    <div id="snr-results-content-${runId}"></div> 
                    <div id="optimal-levels-${runId}" class="optimal-levels"></div> 
                    <div class="interpretation" id="snr-interpretation-${runId}"> 
                        <h4>Interpretation Guide:</h4> 
                        <p>The S/N ratio helps find the most robust process settings (those least affected by noise). The optimal levels are always those that **maximize the S/N ratio**, regardless of whether you are minimizing, maximizing, or targeting a nominal value for your response.</p> 
                    </div> 
                </div> 
            </div> 
        `;
            // Insertar al principio para ver el m√°s reciente primero (opcional, o appendChild)
            DOM.analysisHistoryContainer.innerHTML = ''; // Limpiar anteriores si se quiere solo el √∫ltimo
            DOM.analysisHistoryContainer.appendChild(reportWrapper);

            displayExecutiveSummary(runId);
            displayFactorEffectsTables(runId);
            displayAnovaTable(runId);
            displaySnrResults(runId);
            createParetoChart(runId);
            createMainEffectsCharts(runId);
        }

        function displayExecutiveSummary(runId) {
            const calculationDate = new Date().toLocaleString();
            const sortedFactors = Object.entries(experimentData.factorEffects).sort((a, b) => b[1].range - a[1].range);
            const mostInfluential = sortedFactors.length > 0 ? sortedFactors[0][0] : 'N/A';
            const settingsList = Object.entries(experimentData.optimalSettings).map(([name, setting]) => `<li><i class="fas fa-check-circle"></i><strong>${name}:</strong> ${setting.level}</li>`).join('');
            const summaryDiv = document.getElementById(`executive-summary-${runId}`);
            summaryDiv.innerHTML = `
            <div class="conclusion-box" style="border-left-color: var(--primary-color); background-color: #f8f9fa;">
                <h3><i class="fas fa-bullseye"></i> Executive Summary (Run #${runId})</h3>
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 1rem;">
                    <img src="sigma-exacta-icon.jpg" alt="Sigma Exacta Logo" style="width: 40px; height: 40px; border-radius: 5px;">
                    <p style="margin: 0; font-weight: 600; color: #555;">Calculation Time: ${calculationDate}</p>
                </div>
                <ul>
                    <li><i class="fas fa-chart-line"></i><div class="summary-text">The most influential factor on '<strong>${experimentData.responseVariable}</strong>' is <strong>${mostInfluential}</strong>.</div></li>
                    <li><i class="fas fa-cogs"></i><div class="summary-text">To achieve a <strong>robust process</strong> (maximized S/N Ratio), the recommended optimal settings are: <ul style="margin-left: 20px; margin-top: 10px; list-style-type: none; padding-left: 0;">${settingsList}</ul></div></li>
                    <li><i class="fas fa-calculator"></i><div class="summary-text">With these settings, the predicted result for '<strong>${experimentData.responseVariable}</strong>' is approximately <strong>${experimentData.predictedResult.toFixed(3)}</strong>.</div></li>
                </ul>
            </div>`;
        }

        function displayFactorEffectsTables(runId) {
            const container = document.getElementById(`factor-effects-content-${runId}`);
            let html = '';
            const sortedFactors = Object.keys(experimentData.factorEffects).sort((a, b) => experimentData.factorEffects[b].range - experimentData.factorEffects[a].range);
            sortedFactors.forEach(factorName => {
                const factor = experimentData.factorEffects[factorName];
                html += `<div class="factor-table"><table><thead><tr><th colspan="2">${factorName} (Effect Range: ${factor.range.toFixed(3)})</th></tr>`;
                html += '<tr><th>Level</th><th>Average Response</th></tr></thead><tbody>';
                Object.entries(factor.levels).forEach(([level, avg]) => {
                    const isOptimal = level === experimentData.optimalSettings[factorName].level;
                    html += `<tr class="${isOptimal ? 'highlight' : ''}"><td>${level}</td><td>${avg.toFixed(3)}</td></tr>`;
                });
                html += '</tbody></table></div>';
            });
            container.innerHTML = html;
        }

        function displayAnovaTable(runId) {
            const container = document.getElementById(`anova-table-container-${runId}`);
            let html = `<table class="anova-table"><thead><tr><th>Source</th><th>Sum of Squares (SS)</th><th>DF</th><th>Mean Square (MS)</th><th>F-Value</th><th>Significant?</th></tr></thead><tbody>`;
            Object.keys(experimentData.anova).filter(k => k !== 'error' && k !== 'total').forEach(factorName => {
                const d = experimentData.anova[factorName];
                const sigText = typeof d.isSignificant === 'boolean' ? (d.isSignificant ? 'Yes' : 'No') : d.isSignificant;
                const sigClass = d.isSignificant === true ? 'significant' : '';
                html += `<tr class="${sigClass}"><td class="${sigClass}">${factorName}</td><td>${d.ss.toFixed(3)}</td><td>${d.df}</td><td>${(d.ms || 0).toFixed(3)}</td><td>${(d.f === Infinity ? '‚àû' : (d.f || 0).toFixed(3))}</td><td>${sigText}</td></tr>`;
            });
            const e = experimentData.anova.error;
            html += `<tr><td>Error</td><td>${(e.ss || 0).toFixed(3)}</td><td>${e.df}</td><td>${(e.ms || 0).toFixed(3)}</td><td></td><td></td></tr>`;
            const t = experimentData.anova.total;
            html += `<tr><td><strong>Total</strong></td><td><strong>${(t.ss || 0).toFixed(3)}</strong></td><td><strong>${t.df}</strong></td><td></td><td></td><td></td></tr>`;
            html += '</tbody></table>';
            if (e.df <= 0) {
                html += `<p class="interpretation">Note: ANOVA could not be fully calculated because there are no degrees of freedom for the error term (the design is "saturated"). F-values and significance cannot be determined.</p>`;
            }
            container.innerHTML = html;
        }

        function displaySnrResults(runId) {
            const overallSnr = experimentData.snrEffects.perRun.reduce((a, b) => a + b, 0) / experimentData.snrEffects.perRun.length;
            document.getElementById(`snr-results-content-${runId}`).innerHTML = `<p><strong>Overall S/N Ratio (${getSnrTypeName(experimentData.snrType)}):</strong> <span class="snr-value" style="font-weight: bold; color: var(--primary-color);">${(overallSnr || 0).toFixed(2)} dB</span></p>`;
            const optimalDiv = document.getElementById(`optimal-levels-${runId}`);
            let html = `<h4>Optimal Levels for Robustness</h4><p>These are the settings that maximize the Signal-to-Noise ratio, making your process less sensitive to variation.</p><ul>`;
            html += Object.entries(experimentData.optimalSettings).map(([name, setting]) => `<li><strong>${name}:</strong> ${setting.level} (Avg S/N: ${setting.snr_avg.toFixed(2)} dB)</li>`).join('');
            html += '</ul>';
            optimalDiv.innerHTML = html;
        }

        function createParetoChart(runId) {
            const sortedFactors = Object.entries(experimentData.factorEffects).sort((a, b) => b[1].range - a[1].range);
            const labels = sortedFactors.map(f => f[0]);
            const data = sortedFactors.map(f => f[1].range);
            const paretoChart = new Chart(document.getElementById(`pareto-chart-${runId}`).getContext('2d'), {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Factor Effect (Range)', data, backgroundColor: 'rgba(52, 152, 219, 0.7)' }] },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'x',
                    plugins: { title: { display: true, text: `Impact of Factors on ${experimentData.responseVariable}` } },
                    layout: { padding: { top: 45 } }
                }
            });
            allCharts.push(paretoChart);
        }

        function createMainEffectsCharts(runId) {
            const container = document.getElementById(`charts-parent-container-${runId}`);
            container.innerHTML = '';
            Object.keys(experimentData.factorEffects).forEach(factorName => {
                const factorData = experimentData.factorEffects[factorName];
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'chart-wrapper';
                const canvas = document.createElement('canvas');
                chartWrapper.appendChild(canvas);
                container.appendChild(chartWrapper);
                const chart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: { labels: Object.keys(factorData.levels), datasets: [{ label: 'Average Response', data: Object.values(factorData.levels), borderColor: getRandomColor(), tension: 0.1 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { title: { display: true, text: `Main Effect: ${factorName}` } }
                    }
                });
                allCharts.push(chart);
            });
        }

        function getSnrTypeName(type) {
            const names = { 'smaller': 'Smaller is Better', 'larger': 'Larger is Better', 'nominal': 'Nominal is Best' };
            let name = names[type] || type;
            if (type === 'nominal' && experimentData.nominalTarget !== null) {
                name += ` (Target: ${experimentData.nominalTarget})`;
            }
            return name;
        }

        function getRandomColor() {
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#d35400', '#34495e'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function exportToExcel() {
            if (!experimentData.predictedResult) {
                alert("Please run at least one analysis before exporting.");
                return;
            }

            const wb = XLSX.utils.book_new();

            // Summary Sheet
            const summaryData = [
                ['Taguchi Analysis Report (Last Run)'],
                ['Calculation Date', new Date().toLocaleString()],
                ['Experiment Name', experimentData.name],
                ['Objective', experimentData.objective],
                [],
                ['Executive Summary'],
                ['Most Influential Factor', Object.entries(experimentData.factorEffects).sort((a, b) => b[1].range - a[1].range)[0][0]],
                ['Predicted Result', experimentData.predictedResult.toFixed(4)],
                [''],
                ['Optimal Settings (for Robustness):'],
                ['Factor', 'Optimal Level', 'Avg. S/N (dB)'],
                ...Object.entries(experimentData.optimalSettings).map(([name, setting]) => [name, setting.level, setting.snr_avg.toFixed(2)])
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), 'Summary');

            // Design Data Sheet
            const designData = [
                ['Experiment Design & Data'],
                ['Run', ...experimentData.factors.map(f => f.name), experimentData.responseVariable, `S/N Ratio (${getSnrTypeName(experimentData.snrType)})`],
                ...experimentData.selectedArray.array.map((run, index) => {
                    const row = [index + 1];
                    for (let i = 0; i < experimentData.factors.length; i++) {
                        const factor = experimentData.factors[i];
                        row.push(factor.levels[Math.min(run[i] - 1, factor.levels.length - 1)]);
                    }
                    row.push(experimentData.results[index] || '');
                    row.push(experimentData.snrEffects.perRun[index].toFixed(2));
                    return row;
                })
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(designData), 'Design Data');

            // ANOVA Sheet
            const anovaData = [
                ['ANOVA Table'],
                ['Source', 'SS', 'DF', 'MS', 'F-Value', 'Significant?'],
                ...Object.keys(experimentData.anova).filter(k => k !== 'total' && k !== 'error').map(key => {
                    const val = experimentData.anova[key];
                    const sigText = typeof val.isSignificant === 'boolean' ? (val.isSignificant ? 'Yes' : 'No') : val.isSignificant;
                    return [key, val.ss, val.df, val.ms, val.f === Infinity ? 'N/A' : val.f, sigText];
                }),
                ['Error', experimentData.anova.error.ss, experimentData.anova.error.df, experimentData.anova.error.ms, '', ''],
                ['Total', experimentData.anova.total.ss, experimentData.anova.total.df, '', '', '']
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(anovaData), 'ANOVA');

            const fileName = `Taguchi_Analysis_${experimentData.name.replace(/[^a-z0-9]/gi, '_')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            DOM.successMessage.style.display = 'block';
            setTimeout(() => { DOM.successMessage.style.display = 'none'; }, 3000);
        }
    </script>
</body>

</html>