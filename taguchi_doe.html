<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taguchi DOE Calculator & Analyzer | Orthogonal Array Generator</title>
    <link rel="canonical" href="https://sigmaexacta.com/taguchi_doe" />
    <meta name="description"
        content="Free online Taguchi DOE calculator to create and analyze robust experiments. Generate L4, L8, L9, L16 orthogonal arrays, calculate S/N ratios, find optimal factor levels, and perform ANOVA. An essential tool for quality engineering, process optimization, and robust design.">
    <meta name="keywords"
        content="open source, free software, SigmaExacta, taguchi calculator, doe calculator, taguchi method, taguchi, design of experiments, doe, orthogonal array, L4, L8, L9, L16, s/n ratio, signal to noise, robust design, anova, process optimization, quality engineering, ANOVA, Analysis of Variance">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" href="sigma-exacta-icon.jpg" type="image/jpeg">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>

    <link rel="stylesheet" href="styles.css">

    <style>
        /* ESTILOS IDÉNTICOS A KANO.HTML */
        :root {
            --primary-color: #2c3e50;
            --attractive-color: #3498db;
            --performance-color: #2ecc71;
            --must-be-color: #f1c40f;
            --reverse-color: #9b59b6;
            --indifferent-color: #95a5a6;
            --questionable-color: #e74c3c;
            --light-color: #ecf0f1;
            --danger-color: #c0392b;
            --cs-plus-color: #27ae60;
            --cs-minus-color: #e74c3c;
            font-size: 16px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Nunito', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f5f7fa;
            line-height: 1.6;
        }

        .main-content-wrapper {
            margin: 0 auto;
            padding: 1.25rem;
            max-width: 1400px;
            width: 100%;
            box-sizing: border-box;
        }

        .main-header {
            text-align: center;
            padding: 1rem 1.25rem;
            margin-bottom: 0;
            border-bottom: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
        }

        .main-header h1 {
            color: #2c3e50;
            font-size: clamp(1.5rem, 4vw, 1.8rem);
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tool-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.8rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background-color: #673ab7;
        }

        .main-header p {
            color: #7f8c8d;
            font-weight: 400;
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
        }

        /* --- BOTONES PRINCIPALES IDÉNTICOS A KANO --- */
        .main-action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem auto;
            flex-wrap: wrap;
            max-width: 800px;
        }

        .main-action-buttons button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .main-action-buttons .btn-example {
            background-color: var(--performance-color);
            color: white;
        }

        .main-action-buttons .btn-example:hover {
            background-color: #27ad60;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .main-action-buttons .btn-reset {
            background-color: var(--danger-color);
            color: white;
        }

        .main-action-buttons .btn-reset:hover {
            background-color: #a5281c;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        /* ===== ESTILOS DEL SISTEMA DE PESTAÑAS (WIZARD) IDÉNTICOS ===== */
        .tabs-nav {
            display: flex;
            background-color: #f1f5f9;
            border-radius: 8px 8px 0 0;
            overflow-x: auto;
            border-bottom: 2px solid #3498db;
            margin-bottom: 0;
            margin-top: 0.5rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
            width: 100%;
        }

        .tabs-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 700;
            color: #64748b;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            flex: 1;
            justify-content: center;
        }

        .tab-btn:hover {
            background-color: #e2e8f0;
            color: #2c3e50;
        }

        .tab-btn.active {
            background-color: #fff;
            color: #3498db;
            border-bottom-color: #3498db;
            border-radius: 8px 8px 0 0;
            margin-bottom: -2px;
            border-left: 1px solid #e1e5e9;
            border-right: 1px solid #e1e5e9;
            border-top: 1px solid #e1e5e9;
        }

        .tabs-container {
            background: #fff;
            border: 1px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            position: relative;
            margin-bottom: 2rem;
            box-sizing: border-box;
        }

        .wizard-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }

        .wizard-tab-content.active {
            display: block;
            width: 100%;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content-wrapper {
            padding: 2rem;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }

        @media (max-width: 768px) {
            .tab-content-wrapper {
                padding: 1rem;
            }

            .tab-btn {
                padding: 0.75rem 0.5rem;
                font-size: 0.9rem;
            }

            .main-action-buttons {
                gap: 0.75rem;
                margin: 1rem auto;
            }

            .main-action-buttons button {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .tab-content-wrapper {
                padding: 0.75rem;
            }

            .tab-btn {
                padding: 0.6rem 0.3rem;
                font-size: 0.8rem;
            }

            .main-action-buttons {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .main-action-buttons button {
                width: 100%;
                justify-content: center;
            }
        }

        /* ESTILOS DE CONTENIDO COMO KANO */
        .content-block {
            margin-bottom: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .content-block h2 {
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 1.25rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--attractive-color);
            padding-bottom: 0.6rem;
            font-weight: 800;
        }

        .content-block h2 .fas {
            margin-right: 0.75rem;
        }

        label {
            display: block;
            margin-bottom: 0.6rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border 0.3s, box-shadow 0.3s;
            font-family: 'Nunito', sans-serif;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        input:focus,
        select:focus,
        textarea:focus,
        button:focus-visible {
            outline: none;
            border-color: var(--attractive-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* BOTONES ESTILO KANO */
        button {
            color: white;
            padding: 0.7rem 1.25rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 1rem;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--attractive-color);
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-success {
            background-color: var(--performance-color);
        }

        .btn-success:hover {
            background-color: #27ad60;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #a5281c;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-calculate {
            background-color: #9b59b6;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            font-size: 1.1rem;
            padding: 0.8rem 1.5rem;
        }

        .btn-calculate:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-export {
            background-color: #3498db;
            margin-top: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            padding: 0.8rem 1.5rem;
        }

        .btn-export:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* BOTONES DE FACTORES */
        .factor-inputs {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .factor-inputs input {
            flex: 1;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .remove-factor {
            background-color: var(--danger-color);
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border-radius: 4px;
        }

        .remove-factor:hover {
            background-color: #a5281c;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .button-group button {
            flex: 1;
            min-width: 150px;
        }

        /* BOTÓN GENERATE DESIGN - MÁS CORTO COMO LOS OTROS */
        #generate-design {
            background-color: #9b59b6;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            font-size: 1rem;
            padding: 0.7rem 1.5rem;
            width: auto;
        }

        #generate-design:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        /* TABLA */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            display: block;
        }

        th,
        td {
            border: 1px solid #e0e0e0;
            padding: 0.75rem;
            text-align: center;
        }

        th {
            background-color: var(--attractive-color);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #f1f7fd;
        }

        /* BOTONES DE NAVEGACIÓN */
        .tab-nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-next-tab {
            background-color: #3498db;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1.25rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Nunito', sans-serif;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn-next-tab:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-next-tab.btn-prev {
            background-color: #95a5a6;
        }

        .btn-next-tab.btn-prev:hover {
            background-color: #7f8c8d;
        }

        /* ESTILOS ESPECÍFICOS TAGUCHI */
        .snr-type-selector label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .snr-type-selector input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }

        .interpretation {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            border-left: 4px solid var(--attractive-color);
        }

        .optimal-levels,
        .conclusion-box {
            background-color: #e8f8f5;
            padding: 1rem;
            border-radius: 6px;
            margin: 1.25rem 0;
            border-left: 4px solid var(--performance-color);
        }

        .charts-parent-container {
            display: flex;
            gap: 1.25rem;
            flex-wrap: wrap;
            justify-content: center;
            margin: 2rem 0;
        }

        .chart-wrapper {
            flex: 1;
            min-width: 300px;
            max-width: 450px;
            position: relative;
            height: 350px;
            border: 1px solid #ddd;
            padding: 0.8rem;
            border-radius: 8px;
            background-color: #fdfdfd;
        }

        .highlight {
            background-color: #fffacd;
            font-weight: bold;
        }

        .info-icon {
            cursor: help;
            color: var(--attractive-color);
            margin-left: 8px;
            font-size: 0.9em;
        }

        .hidden {
            display: none;
        }

        /* ESTILOS PARA EL ANÁLISIS COMPLETO */
        .analysis-run-report {
            border: 1px solid #ddd;
            padding: 1.5rem;
            margin-top: 2rem;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .factor-table {
            margin-bottom: 1.5rem;
        }

        .anova-table th.significant {
            background-color: var(--performance-color);
        }

        .anova-table td.significant {
            background-color: #e8f8f5;
            font-weight: bold;
        }

        .export-section {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px dashed #ddd;
        }

        footer {
            padding: 2rem 1.25rem;
            text-align: center;
        }

        .disclaimer-note {
            margin-top: 2rem;
            padding: 0 1rem;
            font-size: 0.8rem;
            color: #777;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .formula-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            text-align: center;
            margin-top: 1.5rem;
        }

        .formula-item {
            padding: 1.5rem 1rem;
            border: 1px solid #eee;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 120px;
            font-size: 1.1em;
        }

        .formula-item h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
    </style>
</head>

<body>
    <div id="header-container"></div>

    <noscript>
        <nav>
            <a href="/">Home</a> |
            <a href="/taguchi_doe">Taguchi DOE</a>
        </nav>
    </noscript>

    <main class="main-content-wrapper">
        <header class="main-header">
            <h1>
                <div class="tool-logo" title="Taguchi DOE">
                    <i class="fas fa-flask"></i>
                </div>
                Free Online Robust Design (Taguchi Method) Tool
            </h1>
            <p>Plan and analyze robust experiments using Orthogonal Arrays to optimize product and process quality.</p>

            <div class="main-action-buttons">
                <button id="globalLoadExampleBtn" class="btn-example">
                    <i class="fas fa-play-circle"></i> Load Example
                </button>
                <button id="globalResetBtn" class="btn-reset">
                    <i class="fas fa-sync-alt"></i> Reset All
                </button>
            </div>
        </header>

        <div class="tabs-container">
            <nav class="tabs-nav">
                <button class="tab-btn active" onclick="switchWizardTab('tab-start')">
                    <i class="fas fa-info-circle"></i> Start & Info
                </button>
                <button class="tab-btn" onclick="switchWizardTab('tab-setup')">
                    <i class="fas fa-cogs"></i> Setup Experiment
                </button>
                <button class="tab-btn" onclick="switchWizardTab('tab-data')">
                    <i class="fas fa-table"></i> Design & Data
                </button>
                <button class="tab-btn" onclick="switchWizardTab('tab-analysis')">
                    <i class="fas fa-chart-bar"></i> Analysis & Report
                </button>
                <button class="tab-btn" onclick="switchWizardTab('tab-formulas')">
                    <i class="fas fa-calculator"></i> Formulas
                </button>
            </nav>

            <div id="tab-start" class="wizard-tab-content active">
                <div class="tab-content-wrapper">
                    <div class="content-block">
                        <h2><i class="fas fa-question-circle"></i> What is the Taguchi Method?</h2>
                        <p>The <strong>Taguchi Method</strong>, developed by Japanese engineer and statistician Genichi
                            Taguchi,
                            is a systematic approach to improving product and process quality through robust design.
                            Unlike
                            traditional experimental design methods that focus primarily on optimizing mean performance,
                            the Taguchi Method
                            emphasizes minimizing the effects of uncontrollable factors (noise) to create products and
                            processes
                            that perform consistently under varying conditions.</p>
                        <p>The core principles of the Taguchi Method include:</p>
                        <ul>
                            <li><strong>Robust Design:</strong> Designing products and processes that are insensitive to
                                variations in manufacturing, environmental conditions, and component aging.</li>
                            <li><strong>Quality Loss Function:</strong> Quantifying the economic loss when a product
                                deviates
                                from its target value, even if it remains within specification limits.</li>
                            <li><strong>Orthogonal Arrays:</strong> Using specially designed fractional factorial
                                experiments
                                that allow testing multiple factors simultaneously with a minimal number of experimental
                                runs.</li>
                            <li><strong>Signal-to-Noise (S/N) Ratios:</strong> Metrics that simultaneously consider both
                                the
                                mean performance and variability, helping identify factor settings that maximize
                                performance while
                                minimizing variation.</li>
                        </ul>
                    </div>

                    <div class="content-block">
                        <h2><i class="fas fa-history"></i> Brief History of the Taguchi Method</h2>
                        <p>The Taguchi Method was developed by <strong>Genichi Taguchi</strong> in the 1950s while he
                            was
                            working at the Electrical Communications Laboratory (ECL) of Nippon Telegraph and Telephone
                            (NTT) in Japan. His
                            early work focused on improving telephone switching systems, where he recognized that
                            traditional
                            quality control methods were insufficient for preventing quality loss throughout the product
                            lifecycle.
                        </p>
                        <p>Taguchi's key insight was that <strong>quality should be measured by the deviation from a
                                target
                                value</strong>, not just by conformance to specification limits. He introduced the
                            concept of
                            the <strong>Quality Loss Function</strong>, which mathematically represents the economic
                            loss incurred
                            when a product characteristic deviates from its ideal value.</p>
                    </div>

                    <div class="content-block">
                        <h2><i class="fas fa-list-ol"></i> How to Use This Tool</h2>
                        <ol>
                            <li>Go to the <strong>Setup Experiment</strong> tab.</li>
                            <li><strong>Load Data or Start Fresh:</strong> Use "Load Example Data" for a quick demo or
                                fill in
                                the setup fields yourself.</li>
                            <li><strong>Experiment Setup:</strong> Give your experiment a name and objective.</li>
                            <li><strong>Define Factors and Levels:</strong> Add factors (variables) and their levels
                                (settings).
                            </li>
                            <li><strong>Generate Design:</strong> Click "Generate Taguchi Design". This will take you to
                                the
                                <strong>Design & Data</strong> tab.
                            </li>
                            <li><strong>Enter Data:</strong> Enter your measured results for each run.</li>
                            <li><strong>Calculate:</strong> Go to the <strong>Analysis & Report</strong> tab and click
                                "Calculate Full Analysis".</li>
                        </ol>
                    </div>

                    <div class="tab-nav-buttons">
                        <button class="btn-next-tab" onclick="switchWizardTab('tab-setup')">
                            Next Step: Setup Experiment <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="tab-setup" class="wizard-tab-content">
                <div class="tab-content-wrapper">
                    <div class="content-block">
                        <h2><i class="fas fa-cogs"></i> Experiment Setup</h2>

                        <div class="form-group">
                            <label for="experiment-name">Experiment Name:</label>
                            <input type="text" id="experiment-name" placeholder="E.g., Coffee Brewing Optimization"
                                value="">
                        </div>

                        <div class="form-group">
                            <label for="objective">Experiment Objective:</label>
                            <textarea id="objective"
                                placeholder="Describe the goal, e.g., to maximize coffee flavor"></textarea>
                        </div>

                        <h3>Factors and Levels</h3>
                        <div id="factors-container"></div>

                        <div style="text-align: center; margin: 1rem 0;">
                            <button type="button" id="add-factor" class="btn-primary">
                                <i class="fas fa-plus"></i> Add Factor
                            </button>
                        </div>

                        <div class="form-group">
                            <label for="response-variable">Response Variable:</label>
                            <input type="text" id="response-variable" placeholder="E.g., Flavor Score (1-10)" value="">
                        </div>

                        <div class="form-group">
                            <label for="array-select">Select Taguchi Array</label>
                            <select id="array-select">
                                <option value="">-- Automatic selection --</option>
                                <option value="L4">L4 (up to 3 factors, 2 levels)</option>
                                <option value="L8">L8 (up to 7 factors, 2 levels)</option>
                                <option value="L9">L9 (up to 4 factors, 3 levels)</option>
                                <option value="L16">L16 (up to 15 factors, 2 levels)</option>
                            </select>
                        </div>

                        <div class="form-group snr-type-selector">
                            <label>Signal-to-Noise Ratio Type</label>
                            <div>
                                <label><input type="radio" name="snr-type" value="smaller" checked> Smaller is
                                    better</label>
                                <label><input type="radio" name="snr-type" value="larger"> Larger is better</label>
                                <label><input type="radio" name="snr-type" value="nominal"> Nominal is best</label>
                            </div>
                            <div id="nominal-target-group" class="form-group hidden" style="margin-top: 1rem;">
                                <label for="nominal-target">Target Value:</label>
                                <input type="number" id="nominal-target" step="any" placeholder="Enter target value">
                            </div>
                        </div>
                    </div>

                    <div class="tab-nav-buttons">
                        <button class="btn-next-tab btn-prev" onclick="switchWizardTab('tab-start')">
                            <i class="fas fa-arrow-left"></i> Back to Start & Info
                        </button>
                        <button class="btn-next-tab" onclick="switchWizardTab('tab-data')">
                            Go to Design & Data <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="tab-data" class="wizard-tab-content">
                <div class="tab-content-wrapper">
                    <div class="content-block">
                        <h2><i class="fas fa-table"></i> Design & Data Entry</h2>
                        <p>Enter your measured results in the rightmost column.</p>
                        <div id="experiment-info"></div>

                        <div style="text-align: center; margin: 1.5rem 0;">
                            <button type="button" id="generate-design" class="btn-calculate">
                                <i class="fas fa-cogs"></i> Generate Taguchi Design
                            </button>
                        </div>

                        <div id="orthogonal-array"></div>
                    </div>

                    <div class="tab-nav-buttons">
                        <button class="btn-next-tab btn-prev" onclick="switchWizardTab('tab-setup')">
                            <i class="fas fa-arrow-left"></i> Back to Setup
                        </button>
                        <button class="btn-next-tab" onclick="switchWizardTab('tab-analysis')">
                            Go to Analysis & Report <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="tab-analysis" class="wizard-tab-content">
                <div class="tab-content-wrapper">
                    <div class="content-block">
                        <h2><i class="fas fa-chart-bar"></i> Analysis & Report</h2>

                        <div id="results-container-analysis">
                            <div id="analysis-output-section" class="hidden">
                                <div id="analysis-history-container"></div>
                            </div>

                            <div id="no-analysis-msg" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                                <p><i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem;"></i></p>
                                <p>No analysis generated yet. Please enter data in the "Design & Data" tab and then
                                    click the button below to calculate.</p>

                                <div style="text-align: center; margin-top: 2rem;">
                                    <button type="button" id="calculate-analysis" class="btn-calculate">
                                        <i class="fas fa-calculator"></i> Calculate Full Analysis
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-nav-buttons">
                        <button class="btn-next-tab btn-prev" onclick="switchWizardTab('tab-data')">
                            <i class="fas fa-arrow-left"></i> Back to Design & Data
                        </button>
                        <button class="btn-next-tab" onclick="switchWizardTab('tab-formulas')">
                            Go to Formulas <i class="fas fa-calculator"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="tab-formulas" class="wizard-tab-content">
                <div class="tab-content-wrapper">
                    <div class="content-block">
                        <h2><i class="fas fa-calculator"></i> Mathematical Formulas</h2>
                        <div class="formula-grid">
                            <div class="formula-item">
                                <h3>Signal-to-Noise Ratio (Smaller is Better)</h3>
                                <div>$$ S/N = -10 \log_{10} \left( \frac{1}{n} \sum_{i=1}^{n} y_i^2 \right) $$</div>
                                <p>Where \( y_i \) are the measured responses and \( n \) is the number of observations.
                                </p>
                            </div>
                            <div class="formula-item">
                                <h3>Signal-to-Noise Ratio (Larger is Better)</h3>
                                <div>$$ S/N = -10 \log_{10} \left( \frac{1}{n} \sum_{i=1}^{n} \frac{1}{y_i^2} \right) $$
                                </div>
                                <p>Where \( y_i \) are the measured responses and \( n \) is the number of observations.
                                </p>
                            </div>
                            <div class="formula-item">
                                <h3>Signal-to-Noise Ratio (Nominal is Best)</h3>
                                <div>$$ S/N = -10 \log_{10} \left( \frac{1}{n} \sum_{i=1}^{n} (y_i - T)^2 \right) $$
                                </div>
                                <p>Where \( T \) is the target value, \( y_i \) are the measured responses, and \( n \)
                                    is the
                                    number of observations.</p>
                            </div>
                            <div class="formula-item">
                                <h3>Mean Response</h3>
                                <div>$$ \bar{y} = \frac{1}{n} \sum_{i=1}^{n} y_i $$</div>
                                <p>Where \( y_i \) are the measured responses and \( n \) is the number of observations.
                                </p>
                            </div>
                            <div class="formula-item">
                                <h3>Main Effect</h3>
                                <div>$$ ME = \frac{\sum \text{Responses at Level } i}{\text{Number of observations at
                                    Level } i} $$
                                </div>
                                <p>Where \( i \) represents a specific factor level.</p>
                            </div>
                            <div class="formula-item">
                                <h3>ANOVA Sum of Squares</h3>
                                <div>$$ SS = \sum_{i=1}^{k} n_i (\bar{y}_i - \bar{y})^2 $$</div>
                                <p>Where \( n_i \) is the number of observations at level \( i \), \( \bar{y}_i \) is
                                    the mean at
                                    level \( i \), and \( \bar{y} \) is the overall mean.</p>
                            </div>
                        </div>
                    </div>

                    <div class="tab-nav-buttons">
                        <button class="btn-next-tab btn-prev" onclick="switchWizardTab('tab-analysis')">
                            <i class="fas fa-arrow-left"></i> Back to Analysis
                        </button>
                        <button class="btn-next-tab" onclick="switchWizardTab('tab-start')">
                            Back to Start <i class="fas fa-home"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="disclaimer-note">
            <p><strong>Disclaimer:</strong> The tools and information provided on Sigma Exacta are for informational and
                educational purposes only. The tools on this site are independent implementations and are not affiliated
                with, sponsored by, or endorsed by the original creators of these methodologies. While we strive for
                accuracy, we make no warranty or guarantee regarding the results. All calculations and decisions based
                on the output of these tools are the sole responsibility of the user.</p>
        </div>
    </footer>

    <script src="taguchi_calculator.js"></script>

    <script>
        // Código JavaScript que funcionará con el header
        document.addEventListener('DOMContentLoaded', function () {
            // Función para cambiar entre tabs (IDÉNTICA A KANO)
            window.switchWizardTab = function (tabId) {
                // Quitar clase active de todos los botones y contenidos
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.wizard-tab-content').forEach(content => content.classList.remove('active'));

                // Activar el contenido seleccionado
                const tabElement = document.getElementById(tabId);
                if (tabElement) {
                    tabElement.classList.add('active');
                }

                // Activar botón correspondiente
                const activeBtn = document.querySelector(`button[onclick="switchWizardTab('${tabId}')"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }

                // Scroll al top suavemente
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // Cargar el header dinámicamente - MISMO CÓDIGO QUE EN KANO.HTML
            fetch('header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                    // Inicializar el menú después de cargar el header
                    initNavigationMenu();
                })
                .catch(error => console.error('Error loading header:', error));

            // Función para inicializar el menú de navegación - MISMA QUE EN KANO.HTML
            function initNavigationMenu() {
                const navToggle = document.getElementById('nav-toggle');
                const navMenu = document.getElementById('nav-menu');
                const toolsDropdownToggle = document.getElementById('tools-dropdown-toggle');
                const toolsDropdownMenu = document.getElementById('tools-dropdown-menu');
                const toolsDropdownContainer = document.getElementById('tools-dropdown-container');

                if (navToggle && navMenu) {
                    navToggle.addEventListener('click', () => {
                        navMenu.classList.toggle('show-menu');
                        const icon = navToggle.querySelector('i');
                        icon.classList.toggle('fa-bars');
                        icon.classList.toggle('fa-times');

                        if (!navMenu.classList.contains('show-menu') && toolsDropdownContainer) {
                            toolsDropdownMenu.classList.remove('show-submenu');
                            toolsDropdownContainer.classList.remove('active');
                        }
                    });
                }
                if (toolsDropdownToggle && toolsDropdownMenu && toolsDropdownContainer) {
                    toolsDropdownToggle.addEventListener('click', (event) => {
                        if (window.innerWidth <= 992) {
                            event.preventDefault();
                            toolsDropdownMenu.classList.toggle('show-submenu');
                            toolsDropdownContainer.classList.toggle('active');
                        }
                    });
                }
            }

            // Variables globales - RESTAURADAS DEL ORIGINAL
            let experimentData = {}, allCharts = [], calculationCount = 0;

            // Elementos del DOM - RESTAURADOS DEL ORIGINAL
            const DOM = {
                addFactorBtn: document.getElementById('add-factor'),
                generateDesignBtn: document.getElementById('generate-design'),
                calculateAnalysisBtn: document.getElementById('calculate-analysis'),
                exportExcelBtn: document.getElementById('export-excel'),
                globalLoadExampleBtn: document.getElementById('globalLoadExampleBtn'),
                globalResetBtn: document.getElementById('globalResetBtn'),
                factorsContainer: document.getElementById('factors-container'),
                orthogonalArrayDiv: document.getElementById('orthogonal-array'),
                experimentInfoDiv: document.getElementById('experiment-info'),
                analysisOutputSection: document.getElementById('analysis-output-section'),
                analysisHistoryContainer: document.getElementById('analysis-history-container'),
                successMessage: document.getElementById('success-message'),
                noAnalysisMsg: document.getElementById('no-analysis-msg')
            };

            // Inicializar
            function init() {
                // Añadir primer factor por defecto
                addFactorInput();

                // Event listeners
                DOM.addFactorBtn.addEventListener('click', () => addFactorInput());
                DOM.generateDesignBtn.addEventListener('click', generateDesign);
                DOM.calculateAnalysisBtn.addEventListener('click', runFullAnalysis);
                DOM.globalLoadExampleBtn.addEventListener('click', loadExampleData);
                DOM.globalResetBtn.addEventListener('click', resetForm);

                // Manejar cambio en tipo S/N
                document.querySelectorAll('input[name="snr-type"]').forEach(radio => {
                    radio.addEventListener('change', function () {
                        const targetGroup = document.getElementById('nominal-target-group');
                        if (this.value === 'nominal') {
                            targetGroup.classList.remove('hidden');
                        } else {
                            targetGroup.classList.add('hidden');
                        }
                    });
                });
            }

            // Funciones básicas
            function addFactorInput(name = '', levels = '') {
                const factorDiv = document.createElement('div');
                factorDiv.className = 'factor-inputs';
                factorDiv.innerHTML = `
                    <input type="text" class="factor-name" placeholder="Factor name" value="${name}" required>
                    <input type="text" class="factor-levels" placeholder="Levels (comma separated)" value="${levels}" required>
                    <button type="button" class="remove-factor btn-danger" title="Remove factor">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                DOM.factorsContainer.appendChild(factorDiv);

                factorDiv.querySelector('.remove-factor').addEventListener('click', () => {
                    factorDiv.remove();
                });
            }

            function generateDesign() {
                // MODIFICADO: Capturar datos previos antes de resetear
                let previousResults = [];
                const existingInputs = document.querySelectorAll('.response-input');
                if (existingInputs.length > 0) {
                    existingInputs.forEach(input => {
                        const val = parseFloat(input.value);
                        // Guardamos null si está vacío o no es número válido
                        previousResults.push((input.value === "" || isNaN(val)) ? null : val);
                    });
                }

                // Limpiar análisis anterior
                DOM.analysisHistoryContainer.innerHTML = '';
                if (allCharts.length > 0) {
                    allCharts.forEach(c => c.destroy());
                    allCharts = [];
                }
                calculationCount = 0;
                DOM.analysisOutputSection.classList.add('hidden');
                DOM.noAnalysisMsg.style.display = 'block';

                // Reiniciar datos del experimento
                resetExperimentData();

                // Obtener datos del formulario
                experimentData.name = document.getElementById('experiment-name').value;
                experimentData.objective = document.getElementById('objective').value;
                experimentData.responseVariable = document.getElementById('response-variable').value;
                experimentData.snrType = document.querySelector('input[name="snr-type"]:checked').value;
                experimentData.factors = [];

                // Obtener factores
                document.querySelectorAll('.factor-inputs').forEach(input => {
                    const name = input.querySelector('.factor-name').value;
                    const levelsStr = input.querySelector('.factor-levels').value;
                    if (name && levelsStr) {
                        const levels = levelsStr.split(',').map(level => level.trim()).filter(Boolean);
                        if (levels.length >= 2) {
                            experimentData.factors.push({ name, levels });
                        }
                    }
                });

                if (!experimentData.name || !experimentData.objective || !experimentData.responseVariable || experimentData.factors.length === 0) {
                    alert('Please fill in all experiment information and add at least one factor.');
                    return;
                }

                const selectedArray = document.getElementById('array-select').value;
                let arrayKey = selectedArray;
                if (!arrayKey) {
                    const maxLevels = Math.max(...experimentData.factors.map(f => f.levels.length));
                    const numFactors = experimentData.factors.length;
                    if (maxLevels <= 2) {
                        if (numFactors <= 3) arrayKey = 'L4';
                        else if (numFactors <= 7) arrayKey = 'L8';
                        else if (numFactors <= 15) arrayKey = 'L16';
                    } else if (maxLevels === 3 && numFactors <= 4) arrayKey = 'L9';
                    if (!arrayKey) {
                        alert('Could not automatically select an array for your combination of factors and levels. Please choose a suitable one manually.');
                        return;
                    }
                }

                experimentData.selectedArray = TaguchiCalculator.orthogonalArrays[arrayKey];
                generateDesignTable();

                // MODIFICADO: Restaurar datos si la longitud del array coincide
                if (previousResults.length === experimentData.selectedArray.runs) {
                    const newInputs = document.querySelectorAll('.response-input');
                    newInputs.forEach((input, index) => {
                        const val = previousResults[index];
                        if (val !== null) {
                            input.value = val;
                            experimentData.results[index] = val;
                        }
                    });
                }

                showNotification('Taguchi design generated successfully!');
            }

            function resetExperimentData() {
                experimentData = {
                    name: '', objective: '', factors: [], responseVariable: '',
                    selectedArray: null, results: [], snrType: 'smaller', nominalTarget: null,
                    factorEffects: {}, anova: {}, predictedResult: null, optimalSettings: {}
                };
            }

            function generateDesignTable() {
                DOM.experimentInfoDiv.innerHTML = `<p><strong>Experiment Name:</strong> ${experimentData.name}</p><p><strong>Objective:</strong> ${experimentData.objective}</p>`;
                let tableHTML = `<table><thead><tr><th>Run</th>${experimentData.factors.map(f => `<th>${f.name}</th>`).join('')}<th>${experimentData.responseVariable}</th></tr></thead><tbody>`;
                experimentData.selectedArray.array.forEach((run, index) => {
                    tableHTML += `<tr><td>${index + 1}</td>`;
                    for (let i = 0; i < experimentData.factors.length; i++) {
                        const factor = experimentData.factors[i];
                        const levelIndex = Math.min(run[i] - 1, factor.levels.length - 1);
                        tableHTML += `<td>${factor.levels[levelIndex]}</td>`;
                    }
                    tableHTML += `<td><input type="number" class="response-input" step="any" placeholder="Enter value"></td></tr>`;
                });
                tableHTML += '</tbody></table>';
                DOM.orthogonalArrayDiv.innerHTML = tableHTML;
                experimentData.results = Array(experimentData.selectedArray.runs).fill(null);
                document.querySelectorAll('.response-input').forEach((input, index) => {
                    input.addEventListener('change', () => {
                        experimentData.results[index] = parseFloat(input.value);
                    });
                });
            }

            function runFullAnalysis() {
                // MODIFICADO: Forzar la sincronización de los inputs del DOM al objeto experimentData
                // Esto es crucial para móviles donde el evento 'change' podría no dispararse si el teclado sigue abierto
                const currentInputs = document.querySelectorAll('.response-input');
                if (currentInputs.length > 0) {
                    currentInputs.forEach((input, index) => {
                        const val = input.value.trim();
                        if (val !== "") {
                            experimentData.results[index] = parseFloat(val);
                        } else {
                            experimentData.results[index] = null;
                        }
                    });
                }

                if (experimentData.results.some(val => val === null || isNaN(val))) {
                    alert('Please fill in all response values before running the analysis.');
                    return;
                }

                let target = null;
                if (experimentData.snrType === 'nominal') {
                    const targetInput = document.getElementById('nominal-target');
                    if (!targetInput.value || isNaN(parseFloat(targetInput.value))) {
                        alert('"Nominal is best" S/N ratio requires a Target Value. Please enter a target value before calculating.');
                        targetInput.focus();
                        return;
                    }
                    target = parseFloat(targetInput.value);
                }

                calculationCount++;
                experimentData = TaguchiCalculator.runAnalysis(experimentData, target);

                // Cambiar a la pestaña de análisis
                switchWizardTab('tab-analysis');
                DOM.noAnalysisMsg.style.display = 'none';
                DOM.analysisOutputSection.classList.remove('hidden');

                createAndDisplayReportBlock(calculationCount);

                // Renderizar fórmulas matemáticas en el nuevo contenido
                renderMathInElement(document.getElementById(`analysis-run-${calculationCount}`));

                document.getElementById(`analysis-run-${calculationCount}`).scrollIntoView({ behavior: 'smooth', block: 'start' });

                showNotification('Analysis completed successfully!');
            }

            // FUNCIONES DE ANÁLISIS COMPLETO - RESTAURADAS DEL ORIGINAL
            function createAndDisplayReportBlock(runId) {
                const reportWrapper = document.createElement('div');
                reportWrapper.id = `analysis-run-${runId}`;
                reportWrapper.className = 'analysis-run-report';
                reportWrapper.innerHTML = ` 
                <div id="executive-summary-${runId}"></div> 
                <hr style="margin: 2rem 0;"> 
                <div class="effects-analysis"> 
                    <h3><i class="fas fa-chart-bar"></i> Effects Analysis (Run #${runId})</h3> 
                    <h4>Factor Influence (Pareto Chart)</h4> 
                    <p>This chart sorts factors from most to least influential, helping you focus on what truly matters.</p> 
                    <div style="position: relative; height:400px; margin: 2rem auto; max-width: 800px;"> 
                        <canvas id="pareto-chart-${runId}"></canvas> 
                    </div> 
                    <h4>Main Effects Plots</h4> 
                    <p>These plots show how each factor level affects the response. Look for steep lines, which indicate a strong effect.</p> 
                    <div id="charts-parent-container-${runId}" class="charts-parent-container"></div> 
                    <h4>Factor Effects Tables</h4> 
                    <div id="factor-effects-content-${runId}"></div> 
                    <h4>Analysis of Variance (ANOVA) <i class="fas fa-info-circle info-icon" title="ANOVA determines if a factor's effect is statistically significant or just random noise. Factors with 'Significance = Yes' have a proven impact."></i> </h4> 
                    <p>This table provides statistical evidence for factor influence. Factors marked as significant have a real, measurable effect on the outcome.</p> 
                    <div id="anova-table-container-${runId}"></div> 
                </div> 
                <hr style="margin: 2rem 0;"> 
                <div id="snr-section-${runId}"> 
                    <div class="snr-results"> 
                        <h3><i class="fas fa-wave-square"></i> Signal-to-Noise Ratio Analysis</h3> 
                        <div id="snr-results-content-${runId}"></div> 
                        <div id="optimal-levels-${runId}" class="optimal-levels"></div> 
                        <div class="interpretation" id="snr-interpretation-${runId}"> 
                            <h4>Interpretation Guide:</h4> 
                            <p>The S/N ratio helps find the most robust process settings (those least affected by noise). The optimal levels are always those that **maximize the S/N ratio**, regardless of whether you are minimizing, maximizing, or targeting a nominal value for your response.</p> 
                        </div> 
                    </div> 
                </div> 
                <hr style="margin: 2rem 0;">
                <div class="export-section">
                    <h3><i class="fas fa-file-export"></i> Export Complete Analysis</h3>
                    <p>Download a comprehensive report of your Taguchi analysis including all data, calculations, and visualizations for offline use or sharing with your team.</p>
                    <button onclick="exportToExcelTaguchi(${runId})" class="btn-export">
                        <i class="fas fa-file-excel"></i> Export Full Analysis to Excel
                    </button>
                </div>
            `;
                // Insertar al principio para ver el más reciente primero
                DOM.analysisHistoryContainer.innerHTML = ''; // Limpiar anteriores si se quiere solo el último
                DOM.analysisHistoryContainer.appendChild(reportWrapper);

                displayExecutiveSummary(runId);
                displayFactorEffectsTables(runId);
                displayAnovaTable(runId);
                displaySnrResults(runId);
                createParetoChart(runId);
                createMainEffectsCharts(runId);
            }

            function displayExecutiveSummary(runId) {
                const calculationDate = new Date().toLocaleString();
                const sortedFactors = Object.entries(experimentData.factorEffects).sort((a, b) => b[1].range - a[1].range);
                const mostInfluential = sortedFactors.length > 0 ? sortedFactors[0][0] : 'N/A';
                const settingsList = Object.entries(experimentData.optimalSettings).map(([name, setting]) => `<li><i class="fas fa-check-circle"></i><strong>${name}:</strong> ${setting.level}</li>`).join('');
                const summaryDiv = document.getElementById(`executive-summary-${runId}`);
                summaryDiv.innerHTML = `
                <div class="conclusion-box" style="border-left-color: var(--primary-color); background-color: #f8f9fa;">
                    <h3><i class="fas fa-bullseye"></i> Executive Summary (Run #${runId})</h3>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 1rem;">
                        <img src="sigma-exacta-icon.jpg" alt="Sigma Exacta Logo" style="width: 40px; height: 40px; border-radius: 5px;">
                        <p style="margin: 0; font-weight: 600; color: #555;">Calculation Time: ${calculationDate}</p>
                    </div>
                    <ul>
                        <li><i class="fas fa-chart-line"></i><div class="summary-text">The most influential factor on '<strong>${experimentData.responseVariable}</strong>' is <strong>${mostInfluential}</strong>.</div></li>
                        <li><i class="fas fa-cogs"></i><div class="summary-text">To achieve a <strong>robust process</strong> (maximized S/N Ratio), the recommended optimal settings are: <ul style="margin-left: 20px; margin-top: 10px; list-style-type: none; padding-left: 0;">${settingsList}</ul></div></li>
                        <li><i class="fas fa-calculator"></i><div class="summary-text">With these settings, the predicted result for '<strong>${experimentData.responseVariable}</strong>' is approximately <strong>${experimentData.predictedResult.toFixed(3)}</strong>.</div></li>
                    </ul>
                </div>`;
            }

            function displayFactorEffectsTables(runId) {
                const container = document.getElementById(`factor-effects-content-${runId}`);
                let html = '';
                const sortedFactors = Object.keys(experimentData.factorEffects).sort((a, b) => experimentData.factorEffects[b].range - experimentData.factorEffects[a].range);
                sortedFactors.forEach(factorName => {
                    const factor = experimentData.factorEffects[factorName];
                    html += `<div class="factor-table"><table><thead><tr><th colspan="2">${factorName} (Effect Range: ${factor.range.toFixed(3)})</th></tr>`;
                    html += '<tr><th>Level</th><th>Average Response</th></tr></thead><tbody>';
                    Object.entries(factor.levels).forEach(([level, avg]) => {
                        const isOptimal = level === experimentData.optimalSettings[factorName].level;
                        html += `<tr class="${isOptimal ? 'highlight' : ''}"><td>${level}</td><td>${avg.toFixed(3)}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                });
                container.innerHTML = html;
            }

            function displayAnovaTable(runId) {
                const container = document.getElementById(`anova-table-container-${runId}`);
                let html = `<table class="anova-table"><thead><tr><th>Source</th><th>Sum of Squares (SS)</th><th>DF</th><th>Mean Square (MS)</th><th>F-Value</th><th>Significant?</th></tr></thead><tbody>`;
                Object.keys(experimentData.anova).filter(k => k !== 'error' && k !== 'total').forEach(factorName => {
                    const d = experimentData.anova[factorName];
                    const sigText = typeof d.isSignificant === 'boolean' ? (d.isSignificant ? 'Yes' : 'No') : d.isSignificant;
                    const sigClass = d.isSignificant === true ? 'significant' : '';
                    html += `<tr class="${sigClass}"><td class="${sigClass}">${factorName}</td><td>${d.ss.toFixed(3)}</td><td>${d.df}</td><td>${(d.ms || 0).toFixed(3)}</td><td>${(d.f === Infinity ? '∞' : (d.f || 0).toFixed(3))}</td><td>${sigText}</td></tr>`;
                });
                const e = experimentData.anova.error;
                html += `<tr><td>Error</td><td>${(e.ss || 0).toFixed(3)}</td><td>${e.df}</td><td>${(e.ms || 0).toFixed(3)}</td><td></td><td></td></tr>`;
                const t = experimentData.anova.total;
                html += `<tr><td><strong>Total</strong></td><td><strong>${(t.ss || 0).toFixed(3)}</strong></td><td><strong>${t.df}</strong></td><td></td><td></td><td></td></tr>`;
                html += '</tbody></table>';
                if (e.df <= 0) {
                    html += `<p class="interpretation">Note: ANOVA could not be fully calculated because there are no degrees of freedom for the error term (the design is "saturated"). F-values and significance cannot be determined.</p>`;
                }
                container.innerHTML = html;
            }

            function displaySnrResults(runId) {
                const overallSnr = experimentData.snrEffects.perRun.reduce((a, b) => a + b, 0) / experimentData.snrEffects.perRun.length;
                document.getElementById(`snr-results-content-${runId}`).innerHTML = `<p><strong>Overall S/N Ratio (${getSnrTypeName(experimentData.snrType)}):</strong> <span class="snr-value" style="font-weight: bold; color: var(--primary-color);">${(overallSnr || 0).toFixed(2)} dB</span></p>`;
                const optimalDiv = document.getElementById(`optimal-levels-${runId}`);
                let html = `<h4>Optimal Levels for Robustness</h4><p>These are the settings that maximize the Signal-to-Noise ratio, making your process less sensitive to variation.</p><ul>`;
                html += Object.entries(experimentData.optimalSettings).map(([name, setting]) => `<li><strong>${name}:</strong> ${setting.level} (Avg S/N: ${setting.snr_avg.toFixed(2)} dB)</li>`).join('');
                html += '</ul>';
                optimalDiv.innerHTML = html;
            }

            function createParetoChart(runId) {
                const sortedFactors = Object.entries(experimentData.factorEffects).sort((a, b) => b[1].range - a[1].range);
                const labels = sortedFactors.map(f => f[0]);
                const data = sortedFactors.map(f => f[1].range);
                const paretoChart = new Chart(document.getElementById(`pareto-chart-${runId}`).getContext('2d'), {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Factor Effect (Range)', data, backgroundColor: 'rgba(52, 152, 219, 0.7)' }] },
                    options: {
                        responsive: true, maintainAspectRatio: false, indexAxis: 'x',
                        plugins: { title: { display: true, text: `Impact of Factors on ${experimentData.responseVariable}` } },
                        layout: { padding: { top: 45 } }
                    }
                });
                allCharts.push(paretoChart);
            }

            function createMainEffectsCharts(runId) {
                const container = document.getElementById(`charts-parent-container-${runId}`);
                container.innerHTML = '';
                Object.keys(experimentData.factorEffects).forEach(factorName => {
                    const factorData = experimentData.factorEffects[factorName];
                    const chartWrapper = document.createElement('div');
                    chartWrapper.className = 'chart-wrapper';
                    const canvas = document.createElement('canvas');
                    chartWrapper.appendChild(canvas);
                    container.appendChild(chartWrapper);
                    const chart = new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: { labels: Object.keys(factorData.levels), datasets: [{ label: 'Average Response', data: Object.values(factorData.levels), borderColor: getRandomColor(), tension: 0.1 }] },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { title: { display: true, text: `Main Effect: ${factorName}` } }
                        }
                    });
                    allCharts.push(chart);
                });
            }

            function getSnrTypeName(type) {
                const names = { 'smaller': 'Smaller is Better', 'larger': 'Larger is Better', 'nominal': 'Nominal is Best' };
                let name = names[type] || type;
                if (type === 'nominal' && experimentData.nominalTarget !== null) {
                    name += ` (Target: ${experimentData.nominalTarget})`;
                }
                return name;
            }

            function getRandomColor() {
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#d35400', '#34495e'];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            // Función de exportación restaurada del original
            window.exportToExcelTaguchi = function (runId) {
                if (!experimentData.predictedResult) {
                    alert("Please run at least one analysis before exporting.");
                    return;
                }

                const wb = XLSX.utils.book_new();

                // Summary Sheet
                const summaryData = [
                    ['Taguchi Analysis Report (Last Run)'],
                    ['Calculation Date', new Date().toLocaleString()],
                    ['Experiment Name', experimentData.name],
                    ['Objective', experimentData.objective],
                    [],
                    ['Executive Summary'],
                    ['Most Influential Factor', Object.entries(experimentData.factorEffects).sort((a, b) => b[1].range - a[1].range)[0][0]],
                    ['Predicted Result', experimentData.predictedResult.toFixed(4)],
                    [''],
                    ['Optimal Settings (for Robustness):'],
                    ['Factor', 'Optimal Level', 'Avg. S/N (dB)'],
                    ...Object.entries(experimentData.optimalSettings).map(([name, setting]) => [name, setting.level, setting.snr_avg.toFixed(2)])
                ];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), 'Summary');

                // Design Data Sheet
                const designData = [
                    ['Experiment Design & Data'],
                    ['Run', ...experimentData.factors.map(f => f.name), experimentData.responseVariable, `S/N Ratio (${getSnrTypeName(experimentData.snrType)})`],
                    ...experimentData.selectedArray.array.map((run, index) => {
                        const row = [index + 1];
                        for (let i = 0; i < experimentData.factors.length; i++) {
                            const factor = experimentData.factors[i];
                            row.push(factor.levels[Math.min(run[i] - 1, factor.levels.length - 1)]);
                        }
                        row.push(experimentData.results[index] || '');
                        row.push(experimentData.snrEffects.perRun[index].toFixed(2));
                        return row;
                    })
                ];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(designData), 'Design Data');

                // ANOVA Sheet
                const anovaData = [
                    ['ANOVA Table'],
                    ['Source', 'SS', 'DF', 'MS', 'F-Value', 'Significant?'],
                    ...Object.keys(experimentData.anova).filter(k => k !== 'total' && k !== 'error').map(key => {
                        const val = experimentData.anova[key];
                        const sigText = typeof val.isSignificant === 'boolean' ? (val.isSignificant ? 'Yes' : 'No') : val.isSignificant;
                        return [key, val.ss, val.df, val.ms, val.f === Infinity ? 'N/A' : val.f, sigText];
                    }),
                    ['Error', experimentData.anova.error.ss, experimentData.anova.error.df, experimentData.anova.error.ms, '', ''],
                    ['Total', experimentData.anova.total.ss, experimentData.anova.total.df, '', '', '']
                ];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(anovaData), 'ANOVA');

                const fileName = `Taguchi_Analysis_${experimentData.name.replace(/[^a-z0-9]/gi, '_')}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showNotification('Excel file exported successfully!');
            }

            function loadExampleData() {
                // Limpiar factores existentes
                DOM.factorsContainer.innerHTML = '';

                // Agregar factores de ejemplo
                addFactorInput('Temperature', '100°C, 120°C');
                addFactorInput('Pressure', '50 psi, 60 psi');
                addFactorInput('Speed', 'Low, High');
                addFactorInput('Material', 'Type A, Type B');

                // Llenar otros campos
                document.getElementById('experiment-name').value = 'Process Optimization Study';
                document.getElementById('objective').value = 'Minimize defects in the production process while maintaining quality standards';
                document.getElementById('response-variable').value = 'Defect rate (%)';
                document.querySelector('input[name="snr-type"][value="smaller"]').checked = true;

                // Generar diseño automáticamente
                generateDesign();

                // Rellenar datos de ejemplo después de un breve retraso
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.response-input');
                    const exampleData = [5.2, 4.8, 2.1, 2.5, 4.9, 5.1, 1.8, 2.0];

                    inputs.forEach((input, index) => {
                        const val = exampleData[index] !== undefined ? exampleData[index] : (Math.random() * 5).toFixed(1);
                        input.value = val;
                        // Disparar evento change para que se guarde en experimentData
                        const event = new Event('change');
                        input.dispatchEvent(event);
                    });

                    showNotification('Example data loaded successfully with defect rates!');
                }, 300);
            }

            function resetForm() {
                if (confirm('Are you sure you want to reset all data?')) {
                    // Limpiar formulario
                    document.getElementById('experiment-name').value = '';
                    document.getElementById('objective').value = '';
                    document.getElementById('response-variable').value = '';
                    document.querySelector('input[name="snr-type"][value="smaller"]').checked = true;
                    document.getElementById('nominal-target-group').classList.add('hidden');
                    document.getElementById('nominal-target').value = '';

                    // Limpiar factores
                    DOM.factorsContainer.innerHTML = '';
                    addFactorInput(); // Agregar uno vacío

                    // Limpiar resultados
                    DOM.experimentInfoDiv.innerHTML = '';
                    DOM.orthogonalArrayDiv.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 2rem;">No design generated yet.</p>';

                    // Limpiar análisis
                    DOM.analysisOutputSection.classList.add('hidden');
                    DOM.noAnalysisMsg.style.display = 'block';
                    DOM.analysisHistoryContainer.innerHTML = '';

                    // Resetear datos
                    experimentData = {};
                    allCharts = [];
                    calculationCount = 0;

                    // Volver a la primera pestaña
                    switchWizardTab('tab-start');

                    showNotification('All data reset successfully!');
                }
            }

            function showNotification(message) {
                // Crear elemento de notificación
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: var(--performance-color);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                    max-width: 300px;
                    font-weight: 600;
                `;

                // Animación CSS
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);

                notification.textContent = message;
                document.body.appendChild(notification);

                // Remover después de 3 segundos
                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.5s ease';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 3000);
            }

            // Inicializar la aplicación
            init();
        });
    </script>
</body>

</html>