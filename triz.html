<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRIZ Problem Solving Tool & 40 Principles | Sigma Exacta</title>
    <meta name="description"
        content="Free online TRIZ tool to solve complex problems with a structured methodology. Identify contradictions, use the 40 inventive principles, and apply Su-Field analysis for innovation.">
    <meta name="keywords"
        content="Open Source, Free Software,TRIZ, Theory of Inventive Problem Solving, contradiction matrix, 40 inventive principles, Genrich Altshuller, Su-Field analysis, problem solving, innovation tool, technical contradiction, physical contradiction, contradiction matrix, 76 standard solutions">
    <link rel="canonical" href="https://sigmaexacta.com/triz" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles.css">

    <!-- Include Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        /* ===== ESTILOS ORIGINALES (MANTENIDOS) ===== */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #222;
        }

        .logo-text,
        .navigation .nav-link,
        .nav-toggle {
            color: #fff;
        }

        .nav-toggle {
            display: none;
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
        }

        .navigation .nav-menu {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            align-items: center;
        }

        .navigation .nav-link {
            padding: 10px 15px;
            text-decoration: none;
            font-weight: 600;
            display: block;
        }

        .navigation .nav-link i {
            margin-left: 5px;
            transition: transform 0.3s ease;
        }

        .nav-item-dropdown {
            position: relative;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #fff;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border-radius: 5px;
            z-index: 1000;
            min-width: 600px;
            padding: 20px;
        }

        .dropdown-menu a,
        .dropdown-menu h4 {
            color: #333;
        }

        .dropdown-link:hover {
            background-color: #f1f1f1;
        }

        .dropdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .nav-item-dropdown:hover>.dropdown-menu {
            display: block;
        }

        @media (max-width: 992px) {
            .nav-toggle {
                display: block;
            }

            .navigation .nav-menu {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: #fff;
                border-top: 1px solid #eee;
            }

            .navigation .nav-menu.show-menu {
                display: flex;
            }

            .navigation .nav-item {
                width: 100%;
                text-align: left;
            }

            .nav-item-dropdown>.nav-link {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .dropdown-menu {
                display: none;
                position: static;
                width: 100%;
                box-shadow: none;
                border-top: 1px solid #f0f0f0;
                padding: 10px 0 10px 30px;
                min-width: unset;
                background-color: #f9f9f9;
            }

            .dropdown-menu.show-submenu {
                display: block;
            }

            .nav-item-dropdown:hover>.dropdown-menu {
                display: none;
            }

            .nav-item-dropdown.active:hover>.dropdown-menu {
                display: block;
            }

            .nav-item-dropdown.active>.nav-link i {
                transform: rotate(180deg);
            }
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            font-size: 16px;
            --professional-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --professional-border: 1px solid #e1e5e9;
        }

        *,
        ::after,
        ::before {
            box-sizing: border-box
        }

        html {
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        /* Evita scroll horizontal global */
        body {
            font-family: 'Nunito', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f8fafc;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .main-content-wrapper {
            padding: 1.25rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: var(--professional-border);
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: clamp(1.5rem, 4vw, 1.8rem);
            margin: .5rem 0;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header .header-subtitle {
            font-size: 1.1rem;
            color: #4a5568;
            margin: 0;
            font-weight: 400;
        }

        /* --- BOTONES PRINCIPALES SOBRE LAS TABS --- */
        .main-action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem auto;
            flex-wrap: wrap;
            max-width: 800px;
        }

        .main-action-buttons button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .main-action-buttons .btn-example {
            background-color: #2ecc71;
            color: white;
        }

        .main-action-buttons .btn-example:hover {
            background-color: #27ad60;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .main-action-buttons .btn-reset {
            background-color: #e74c3c;
            color: white;
        }

        .main-action-buttons .btn-reset:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .content-block {
            border: var(--professional-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #fff;
            box-shadow: var(--professional-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow-wrap: break-word;
        }

        .content-block:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
        }

        .content-block h2 {
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 1.25rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: .6rem;
            font-weight: 800;
        }

        .content-block h2 .fas {
            margin-right: .75rem
        }

        .infographic-flow {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            margin-top: 1.5rem;
            text-align: center;
            flex-wrap: wrap;
            gap: .6rem;
        }

        .flow-step {
            flex: 1;
            min-width: 150px;
            padding: 1rem;
            border: var(--professional-border);
            border-radius: 8px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            transition: transform .2s, box-shadow .2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .flow-step:hover {
            transform: translateY(-5px);
            box-shadow: var(--professional-shadow);
        }

        .flow-step .fas {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: .6rem;
        }

        .flow-step strong {
            display: block;
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .flow-step span {
            font-size: .9em;
            color: #4a5568;
        }

        .flow-arrow {
            font-size: 2rem;
            color: var(--secondary-color);
            margin: auto .6rem;
            flex-grow: 0;
        }

        .instructions-box ul {
            margin: .6rem 0 0 0;
            padding-left: 1.25rem
        }

        .instructions-box li {
            margin-bottom: .5rem;
            line-height: 1.6
        }

        .solver-step {
            border: var(--professional-border);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            background-color: #fdfdfd;
            max-width: 100%;
        }

        .solver-step h3 {
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: .6rem;
            font-weight: 800;
        }

        .form-group {
            margin-bottom: 1.25rem
        }

        label {
            color: var(--primary-color);
            font-weight: 600;
            display: block;
            margin-bottom: .5rem;
        }

        input[type=text],
        select,
        textarea {
            width: 100%;
            padding: .6rem;
            border: var(--professional-border);
            border-radius: 4px;
            transition: border .3s, box-shadow .3s;
            font-size: 1rem;
            font-family: 'Nunito', sans-serif;
            background-color: #fff;
        }

        button:focus-visible,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 0;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, .2);
        }

        textarea {
            min-height: 90px;
            resize: vertical;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 400;
            margin-bottom: .6rem;
            cursor: pointer;
        }

        .radio-group input {
            width: auto;
            margin: 0
        }

        button {
            background-color: var(--secondary-color);
            color: #fff;
            padding: .7rem 1.25rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 1rem;
            transition: background-color .3s, transform 0.2s, box-shadow 0.2s;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-success {
            background-color: var(--success-color)
        }

        .btn-success:hover {
            background-color: #219653
        }

        .btn-warning {
            background-color: var(--warning-color)
        }

        .btn-warning:hover {
            background-color: #d4ac0d
        }

        #solve-button {
            width: 100%;
            padding: 1rem;
            font-size: 1.2em;
            font-weight: 700;
            margin-top: 1.25rem;
        }

        #solve-button:hover {
            background-color: #2980b9
        }

        .hidden {
            display: none
        }

        #results-container {
            border: 2px solid var(--success-color);
            background-color: #f8fef8;
            border-radius: 8px;
            padding: 1.25rem;
            margin-top: 1.5rem;
            box-shadow: var(--professional-shadow);
            overflow-x: hidden;
        }

        #results-container h3 {
            color: var(--success-color);
            font-weight: 800;
        }

        .principle-item {
            border-left: 3px solid var(--secondary-color);
            padding-left: 1rem;
            margin-bottom: 1rem;
        }

        .principle-item strong {
            color: var(--dark-color);
            font-size: 1.05em;
            font-weight: 600;
        }

        .results-actions {
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid #eee;
        }

        footer {
            padding: 2rem 1.25rem;
            text-align: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .disclaimer-note {
            margin-top: 2rem;
            padding: 0 1rem;
            font-size: .8rem;
            color: #777;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
            line-height: 1.6;
        }

        /* ===== MEJORAS PARA M칍VILES EN RESULTADOS ===== */
        @media (max-width: 992px) {
            .infographic-flow {
                flex-direction: column;
                align-items: center
            }

            .flow-arrow {
                transform: rotate(90deg);
                margin: 1rem 0
            }
        }

        @media (max-width: 768px) {
            #results-container {
                padding: 1rem !important;
                width: 100%;
                overflow-wrap: break-word;
                word-wrap: break-word;
                word-break: break-word;
                /* Asegura ruptura de palabras largas */
            }

            /* Contenedores de diagramas adaptables */
            .sufield-svg-container {
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                aspect-ratio: 4/3;
                margin: 0 auto;
            }

            /* Ajuste del flujo de soluci칩n (Antes -> Despu칠s) */
            .solution-transformation {
                flex-direction: column;
                gap: 1.5rem;
                width: 100%;
            }

            .transition-arrow {
                transform: rotate(90deg);
                margin: 0.5rem 0;
            }

            .before-state,
            .after-state {
                width: 100% !important;
                max-width: 100%;
            }

            /* Ajustes de espaciado interno en m칩viles */
            #results-container .solver-step,
            #results-container .principle-card,
            #results-container .solution-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }

            .sufield-system-fields {
                grid-template-columns: 1fr !important;
                gap: 0.5rem !important;
            }

            .sufield-system {
                padding: 1rem !important;
            }

            /* Tablas con scroll horizontal para evitar desborde */
            .matrix-container,
            .table-responsive-wrapper {
                overflow-x: auto;
                font-size: 0.75rem;
                display: block;
                width: 100%;
            }

            .matrix-table th,
            .matrix-table td {
                padding: 4px 2px !important;
                font-size: 0.7rem;
                min-width: 60px;
                /* Evita colapso total */
            }

            /* Forzar scroll en tablas generadas */
            #results-container table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .infographic-flow {
                gap: 0.5rem;
            }

            .flow-step {
                min-width: 120px;
                padding: 0.8rem;
            }

            .flow-step .fas {
                font-size: 1.4rem;
            }

            .flow-step strong {
                font-size: 1rem;
            }

            .flow-step span {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .main-content-wrapper {
                padding: 0.5rem !important;
            }

            .content-block {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }

            .solver-step {
                padding: 0.75rem !important;
            }

            .header {
                padding: 1rem !important;
            }

            /* Texto m치s peque침o en diagramas para m칩viles muy peque침os */
            .sufield-svg-container .node-type {
                font-size: 0.55rem !important;
            }

            .sufield-svg-container .node-label {
                font-size: 0.65rem !important;
            }

            button {
                padding: 0.8rem 1rem !important;
                margin: 3px !important;
                font-size: 0.9rem !important;
            }

            #solve-button {
                padding: 0.9rem !important;
                font-size: 1.1rem !important;
            }

            /* Ajuste cr칤tico para evitar scroll horizontal en el cuerpo */
            #results-container {
                padding: 0.5rem !important;
                border-width: 1px;
            }
        }

        .triz-h1-icon-style {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 35px;
            height: 35px;
            border-radius: 6px;
            background-color: #fc6d26;
            color: #fff;
            font-size: 1.2rem;
            margin-right: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .physical-strategy-guide {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 5px solid var(--secondary-color);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .strategy-title {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .strategy-description {
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .strategy-example {
            background: rgba(255, 255, 255, 0.7);
            padding: 1rem;
            border-radius: 5px;
            font-style: italic;
            border-left: 3px solid var(--accent-color);
        }

        .physical-principle-card {
            border: var(--professional-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .physical-principle-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .principle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .principle-number {
            background: var(--secondary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .principle-name {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
            flex: 1;
            margin-left: 10px;
        }

        .principle-description {
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .principle-example {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            border-left: 3px solid var(--warning-color);
        }

        .example-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .sufield-triangle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: var(--professional-border);
            position: relative;
            overflow: hidden;
        }

        .sufield-svg-container {
            width: 320px;
            height: 280px;
            position: relative;
        }

        .sufield-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .triangle-path {
            fill: rgba(255, 255, 255, 0.8);
            stroke: #dee2e6;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
        }

        .interaction-line {
            stroke: #3498db;
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }

        .problem-interaction {
            stroke: #e74c3c;
            stroke-width: 3;
        }

        .sufield-node {
            cursor: default;
            transition: none;
        }

        .sufield-node:hover {
            transform: none;
            filter: none;
        }

        .s1-node {
            fill: #3498db;
        }

        .s2-node {
            fill: #e74c3c;
        }

        .f-node {
            fill: #f39c12;
        }

        .node-label {
            font-weight: bold;
            font-size: 0.75rem;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
            fill: #1a5632;
            filter: url(#text-background);
        }

        .node-type {
            font-size: 0.65rem;
            text-anchor: middle;
            fill: #4a5568;
            font-weight: 600;
        }

        .problem-indicator-icon {
            font-size: 1.8rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            animation: subtle-pulse 3s infinite;
        }

        @keyframes subtle-pulse {
            0% {
                opacity: 0.8;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.8;
            }
        }

        .problem-insufficient .interaction-line {
            stroke-dasharray: 5, 5;
            stroke: #3498db;
        }

        .problem-harmful .interaction-line {
            stroke: #e74c3c;
            stroke-width: 3;
        }

        .problem-difficult .interaction-line {
            stroke-dasharray: 2, 2;
            stroke: #f39c12;
        }

        .problem-missing .interaction-line {
            stroke-dasharray: 10, 5;
            stroke: #9b59b6;
        }

        .problem-excessive .interaction-line {
            stroke: #e67e22;
            stroke-width: 4;
        }

        .problem-inefficient .interaction-line {
            stroke: #1abc9c;
            stroke-width: 2;
            stroke-dasharray: 1, 0;
        }

        .standard-solution-visual {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--secondary-color);
        }

        .solution-transformation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .before-state,
        .after-state {
            text-align: center;
            flex: 1;
        }

        .state-label {
            margin-top: 0.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .transition-arrow {
            font-size: 2rem;
            color: var(--secondary-color);
            margin: 0 1rem;
        }

        .problem-state .triangle-path {
            fill: rgba(255, 230, 230, 0.8);
        }

        .solution-state .triangle-path {
            fill: rgba(230, 255, 230, 0.8);
        }

        .solution-description {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .solution-description h5 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
        }

        .matrix-container {
            margin-top: 1rem;
            overflow-x: auto;
            border: var(--professional-border);
            border-radius: 8px;
            padding: 1rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .matrix-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.75rem;
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid #e0e0e0;
            padding: 6px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .matrix-table th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            min-width: 40px;
            height: 40px;
        }

        .matrix-table th:first-child {
            background: linear-gradient(135deg, #3498db, #2980b9);
            position: sticky;
            left: 0;
            z-index: 3;
        }

        .matrix-table td {
            background-color: #fafafa;
            height: 35px;
            position: relative;
        }

        .matrix-table td:hover {
            background-color: #e3f2fd;
            transform: scale(1.05);
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .matrix-table .selected {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.4);
        }

        .matrix-table .improving {
            background-color: #e8f5e9;
        }

        .matrix-table .worsening {
            background-color: #ffebee;
        }

        .principle-numbers {
            font-size: 0.7rem;
            line-height: 1.2;
            font-weight: bold;
        }

        .matrix-toggle {
            margin-bottom: 1rem;
            text-align: center;
        }

        .principle-icon,
        .solution-icon,
        .class-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 0.9rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .principle-icon {
            background-color: #3498db;
            color: white;
        }

        .solution-icon {
            background-color: #9b59b6;
            color: white;
        }

        .class-icon {
            background-color: #e74c3c;
            color: white;
        }

        .principle-card {
            border: var(--professional-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 4px solid #3498db;
        }

        .principle-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .principle-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .solution-card {
            border: var(--professional-border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .solution-card:hover {
            background: #e9ecef;
        }

        .solution-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .class-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e74c3c;
        }

        .physical-principle-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            margin-right: 12px;
            font-size: 1rem;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .standard-solution-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 28px;
            height: 28px;
            border-radius: 5px;
            margin-right: 10px;
            font-size: 0.9rem;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .icon-segmentation {
            color: #3498db;
        }

        .icon-extraction {
            color: #e74c3c;
        }

        .icon-local-quality {
            color: #2ecc71;
        }

        .icon-asymmetry {
            color: #9b59b6;
        }

        .icon-combining {
            color: #f39c12;
        }

        .icon-universality {
            color: #1abc9c;
        }

        .icon-nesting {
            color: #34495e;
        }

        .icon-counterweight {
            color: #7f8c8d;
        }

        .icon-preliminary {
            color: #d35400;
        }

        .icon-prior-action {
            color: #c0392b;
        }

        .sufield-system {
            border: var(--professional-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: #fdfdfd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .sufield-system-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .sufield-system-title {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .sufield-system-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .sufield-system-fields {
                grid-template-columns: 1fr;
            }
        }

        .matrix-version-selector {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3498db;
        }

        .matrix-version-info {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }

        .solutions-matrix {
            font-size: 0.7rem;
        }

        .solutions-matrix th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 8px 4px;
            text-align: center;
            white-space: nowrap;
        }

        .solutions-matrix td {
            padding: 6px 4px;
            border: 1px solid #e0e0e0;
            vertical-align: top;
        }

        .matrix-applicable {
            background-color: #d4edda;
            color: #155724;
            text-align: center;
            font-weight: bold;
        }

        .solutions-matrix tr:hover td {
            background-color: #e3f2fd;
        }

        .solutions-matrix tr:hover .matrix-applicable {
            background-color: #c3e6cb;
        }

        #principles-toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 1rem 0;
        }

        #principles-toggle-container button {
            margin: 0 auto;
            display: block;
        }

        .tese-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin: 20px 0;
            border: var(--professional-border);
            border-radius: 8px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .tese-svg {
            width: 100%;
            height: 100%;
        }

        .s-curve {
            fill: none;
            stroke: #3498db;
            stroke-width: 3;
        }

        .stage-marker {
            fill: #e74c3c;
            stroke: #fff;
            stroke-width: 2;
            cursor: move;
            transition: all 0.3s ease;
        }

        .stage-marker:hover {
            fill: #c0392b;
            transform: scale(1.2);
        }

        .stage-label {
            font-size: 0.8rem;
            font-weight: bold;
            text-anchor: middle;
            fill: #2c3e50;
        }

        .stage-line {
            stroke: #95a5a6;
            stroke-width: 1;
            stroke-dasharray: 5, 5;
        }

        .tese-info {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .trends-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .trends-table th,
        .trends-table td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
        }

        .trends-table th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: bold;
        }

        .trends-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .trends-table tr:hover {
            background-color: #e3f2fd;
        }

        .recommended-trend {
            background-color: #d4edda !important;
            font-weight: bold;
        }

        .trend-icon-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .trend-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 28px;
            height: 28px;
            border-radius: 5px;
            margin-right: 10px;
            font-size: 0.9rem;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tese-trends-icons {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .tese-trend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-width: 80px;
        }

        .tese-trend-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .tese-trend-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .text-background {
            fill: #f8f9fa;
            fill-opacity: 0.9;
            stroke: #dee2e6;
            stroke-width: 1;
        }

        /* ===== NUEVA ESTRUCTURA DE TABS ===== */
        .tabs-nav {
            display: flex;
            background-color: #f1f5f9;
            border-radius: 8px 8px 0 0;
            overflow-x: auto;
            border-bottom: 2px solid var(--secondary-color);
            margin-bottom: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tabs-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 700;
            color: #64748b;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            flex: 1;
            justify-content: center;
        }

        .tab-btn:hover {
            background-color: #e2e8f0;
            color: var(--primary-color);
        }

        .tab-btn.active {
            background-color: #fff;
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
            border-radius: 8px 8px 0 0;
            margin-bottom: -2px;
            border-left: 1px solid #e1e5e9;
            border-right: 1px solid #e1e5e9;
            border-top: 1px solid #e1e5e9;
        }

        .tab-content {
            display: none;
            padding: 2rem;
            background: #fff;
            border: 1px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 8px 8px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== SUB-TABS NAVIGATION (ESTILOS DE 8D) ===== */
        .sub-tabs-nav {
            display: flex;
            background-color: #e8f4fc;
            border-radius: 8px 8px 0 0;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) #f1f5f9;
            -webkit-overflow-scrolling: touch;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 0;
            padding-bottom: 5px;
        }

        .sub-tabs-nav::-webkit-scrollbar {
            height: 8px;
        }

        .sub-tabs-nav::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .sub-tabs-nav::-webkit-scrollbar-thumb {
            background-color: var(--secondary-color);
            border-radius: 4px;
        }

        .sub-tab-btn {
            padding: 0.8rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-size: 0.9rem;
            flex-shrink: 0;
            min-width: fit-content;
        }

        @media (min-width: 768px) {
            .sub-tabs-nav {
                overflow-x: auto;
            }

            .sub-tab-btn {
                flex: 0 0 auto;
                justify-content: center;
                padding: 0.8rem 0.5rem;
            }
        }

        .sub-tab-btn:hover {
            background-color: #d1e7ff;
            color: var(--primary-color);
        }

        .sub-tab-btn.active {
            background-color: #fff;
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            border-radius: 8px 8px 0 0;
            margin-bottom: -2px;
            border-left: 1px solid #e1e5e9;
            border-right: 1px solid #e1e5e9;
            border-top: 1px solid #e1e5e9;
        }

        .sub-tab-content {
            display: none;
            padding: 1.5rem;
            background: #fff;
            border: 1px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 8px 8px;
            animation: fadeIn 0.3s ease;
        }

        .sub-tab-content.active {
            display: block;
        }

        .sub-tab-nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .btn-next-sub-tab,
        .btn-prev-sub-tab {
            background-color: var(--primary-color);
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }

        .btn-prev-sub-tab {
            background-color: #6c757d;
        }

        .btn-prev-sub-tab:hover {
            background-color: #5a6268;
        }

        /* ===== TOOL CONTENT CONTAINER ===== */
        .tool-content-container {
            display: none;
        }

        .tool-content-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .tab-nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .btn-next-tab {
            background-color: var(--primary-color);
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-next-tab:hover {
            background-color: #1a252f;
        }

        /* ===== ESTILOS ESPEC칈FICOS PARA FUNCTION ANALYSIS ===== */
        .panels-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
        }

        .panel-half {
            flex: 1;
            min-width: 300px;
        }

        .calculation-block {
            border: var(--professional-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #fff;
            box-shadow: var(--professional-shadow);
        }

        .calculation-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }

        .item-list {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 0.5rem;
        }

        .item-entry {
            padding: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .item-entry:last-child {
            border-bottom: none;
        }

        .item-tag {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .mermaid-container {
            width: 100%;
            min-height: 300px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1rem;
            background-color: #f9f9f9;
            overflow: auto;
        }

        .mermaid {
            text-align: center;
        }

        /* Estilos espec칤ficos para los nodos del diagrama Mermaid */
        .mermaid .node.system rect {
            fill: #dceeff !important;
            stroke: #82b6ff !important;
        }

        .mermaid .node.supersystem polygon {
            fill: #ffe6cc !important;
            stroke: #d79b00 !important;
        }

        .mermaid .node.target rect {
            fill: #ffffcc !important;
            stroke: #d6b656 !important;
            rx: 15px !important;
            ry: 15px !important;
        }

        /* Estilos para las l칤neas */
        .mermaid .edgePath path {
            stroke-width: 2px;
        }

        .mermaid .edgeLabel {
            background-color: white;
            padding: 2px 5px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        /* ===== NUEVOS ESTILOS PARA DIAGRAM LEGEND ===== */
        .diagram-legend {
            margin-top: 20px;
            font-size: 0.8rem;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .legend-title {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .legend-color-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-line-sample {
            width: 40px;
            height: 2px;
            flex-shrink: 0;
        }

        .legend-shape-sample {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* ===== ESTILOS PARA 9 WINDOWS ===== */
        .nine-windows-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .nine-windows-table {
            min-width: 600px;
            border-collapse: collapse;
            width: 100%;
            margin: 0 auto;
        }

        .nine-windows-table td {
            border: 1px solid #ddd;
        }

        .nine-windows-table tr:first-child td:first-child {
            border: none;
            background: transparent;
        }

        @media (max-width: 768px) {
            .nine-windows-table {
                font-size: 0.8rem;
            }

            .nine-windows-table textarea {
                height: 70px;
                font-size: 0.8rem;
            }

            .nine-windows-table td {
                padding: 3px !important;
            }
        }

        /* ===== ESTILOS PARA NUEVA FUNCTION ANALYSIS ===== */
        .small-note {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        .interaction-matrix {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .interaction-matrix th,
        .interaction-matrix td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .interaction-matrix th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: bold;
        }

        .interaction-checkbox {
            transform: scale(1.3);
            cursor: pointer;
        }

        /* ===== CORRECCIONES PARA LA TABLA DE INTERACCI칍N (STEP 3) ===== */
        .interaction-matrix tbody tr:hover,
        .interaction-matrix tbody tr:hover td {
            background-color: #e3f2fd;
        }

        /* Resaltar toda la fila y columna al hacer hover en una celda */
        .interaction-matrix td:hover,
        .interaction-matrix th:hover {
            background-color: #e3f2fd !important;
        }

        .interaction-matrix td:hover~td,
        .interaction-matrix th:hover~th {
            background-color: #e3f2fd !important;
        }

        /* Asegurar que los encabezados tengan el mismo color que el step 4 */
        .interaction-matrix thead th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: bold;
            border: 1px solid #ddd;
        }

        .interaction-matrix tbody th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: bold;
            border: 1px solid #ddd;
        }

        /* Clase para resaltar fila y columna */
        .highlight-row,
        .highlight-col {
            background-color: #e3f2fd !important;
        }

        /* ===== NUEVO ESTILO PARA HIGHLIGHT EN TABLA DE PRINCIPIOS ===== */
        .highlighted-principle-row {
            background-color: #d4edda !important;
        }
    </style>
</head>

<body>
    <div id="header-container"></div>

    <main class="main-content-wrapper">
        <header class="header">
            <h1><span class="triz-h1-icon-style"><i class="fas fa-brain"></i></span> Free Online Inventive Problem
                Solving (TRIZ) Tool</h1>
            <p class="header-subtitle">A data-driven method for systematic innovation and invention.</p>

            <div class="main-action-buttons">
                <button id="globalLoadExampleBtn" class="btn-example">
                    <i class="fas fa-play-circle"></i> Load Next Example
                </button>
                <button id="globalResetBtn" class="btn-reset">
                    <i class="fas fa-sync-alt"></i> Reset All
                </button>
            </div>
        </header>

        <nav class="tabs-nav">
            <button class="tab-btn active" onclick="switchMainTab('tab-start')">
                <i class="fas fa-info-circle"></i> Start & Info
            </button>
            <button class="tab-btn" onclick="switchMainTab('tab-tools')">
                <i class="fas fa-tools"></i> TRIZ Tools
            </button>
            <button class="tab-btn" onclick="switchMainTab('tab-solve')">
                <i class="fas fa-calculator"></i> Solve & Report
            </button>
        </nav>

        <div id="tab-start" class="tab-content active">
            <!-- Contenido de la pesta침a Start & Info (sin cambios) -->
            <div class="content-block">
                <h2><i class="fas fa-question-circle"></i> What is TRIZ?</h2>
                <div class="instructions-box">
                    <ul>
                        <li><strong>TRIZ</strong> (햑햣쮐햦혪 햣혣햣햫햦혪 햦향쮏쐄햣혝햟혝햣햩혧혜햨햦혠 향햟햢햟혢), or "Theory of Inventive
                            Problem Solving," is a systematic, data-driven methodology for innovation developed by
                            <strong>Genrich Altshuller</strong> and his colleagues. Unlike traditional brainstorming
                            approaches, TRIZ is based on analyzing patterns in millions of patents to identify universal
                            principles of invention that transcend specific industries and technologies.
                        </li>
                        <li>The core premise of TRIZ is that most inventive problems contain inherent
                            <strong>contradictions</strong> - situations where improving one parameter of a system
                            inevitably worsens another. By systematically identifying and resolving these contradictions
                            breakthrough solutions can be systematically discovered across all technical fields (using
                            the <strong>Contradiction Matrix</strong>). For highly complex challenges, the
                            <strong>ARIZ</strong> (Algorithm of Inventive Problem Solving) provides a detailed,
                            step-by-step procedure for tackling the problem and resolving <strong>physical
                                contradictions</strong> (where a single component requires two opposing properties
                            simultaneously). Furthermore, the <strong>Su-Field Analysis</strong> (Substance-Field)
                            serves as a graphical model to simplify a technical system into interacting components
                            (Substances and Fields), allowing users to systematically apply Inventive Standards to fix
                            or improve ineffective interactions. Finally, the <strong>LDST</strong> (Laws of Development
                            of Technical Systems) is a thinking framework that ensures comprehensive problem resolution
                            by analyzing the evolution of technical systems through fundamental laws of development.
                        </li>
                    </ul>
                </div>
            </div>

            <div class="content-block">
                <h2><i class="fas fa-history"></i> History & Origin</h2>
                <div class="instructions-box">
                    <ul>
                        <li>TRIZ was developed by <strong>Genrich Altshuller</strong> beginning in 1946 while working as
                            a patent examiner in the Soviet Navy. After analyzing thousands of patents across diverse
                            technical fields, he discovered that inventive problems, regardless of their specific
                            domain, were solved using a surprisingly small set of universal principles and patterns.
                        </li>
                        <li>Altshuller's revolutionary insight was that <strong>innovation follows predictable
                                patterns</strong> rather than being random acts of genius. His team systematically
                            analyzed over 200,000 patents to codify these patterns into the foundational TRIZ tools that
                            form the basis of the methodology today.</li>
                        <li><strong>Key Historical Contributions:</strong>
                            <ul>
                                <li><strong>Genrich Altshuller (1946-1985)</strong>: Developed the core TRIZ framework
                                    including the 40 Principles, Contradiction Matrix, and the ARIZ algorithm for
                                    complex problem solving</li>
                                <li><strong>Boris Zlotin & Alla Zusman (1980s-1990s)</strong>: Advanced LDST (Laws of
                                    Development of Technical Systems) and expanded TRIZ applications</li>
                                <li><strong>Vladimir Petrov (1990s-2000s)</strong>: Expanded the 76 Standard Solutions
                                    and refined the Su-Field methodology</li>
                                <li><strong>Victor Fey & Eugene Rivin (1990s)</strong>: Adapted TRIZ for Western
                                    audiences and industrial applications</li>
                                <li><strong>Simon Litvin (2000s)</strong>: Developed modern physical contradiction
                                    resolution methods and separation principles</li>
                                <li><strong>Valeri Souchkov & Michael Orloff (2000s)</strong>: Refined function analysis
                                    and Su-Field modeling techniques</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="content-block">
                <h2><i class="fas fa-toolbox"></i> TRIZ Methodology & Tools</h2>
                <div class="instructions-box">
                    <ul>
                        <li>The TRIZ methodology provides a structured approach to problem solving that guides
                            innovators through a systematic process of analyzing problems, identifying contradictions,
                            and applying proven solution patterns. The methodology integrates several powerful tools
                            that work together to transform seemingly intractable problems into solvable challenges.
                        </li>
                        <li><strong>LDST - Laws of Development of Technical Systems</strong><br>LDST identifies
                            fundamental laws that govern how technical systems evolve over time, helping innovators
                            understand system dynamics and identify natural evolution paths based on Altshuller's
                            original framework.</li>
                        <li><strong>Ideal Final Result (IFR)</strong><br>The IFR is a powerful concept that defines the
                            perfect solution where the system performs its function without any drawbacks, costs, or
                            harmful effects. Formulating the IFR helps innovators break psychological inertia and focus
                            on the essential function rather than being constrained by existing implementations.</li>
                        <li><strong>Technical Contradictions</strong><br>Technical Contradictions occur when improving
                            one parameter of a system causes another parameter to worsen. For example, making a car
                            stronger typically makes it heavier. These contradictions are resolved using the
                            <strong>Contradiction Matrix</strong> and <strong>40 Inventive Principles</strong>, which
                            provide specific guidance on how to overcome the trade-off.
                        </li>
                        <li><strong>40 Inventive Principles</strong><br>The 40 Principles represent the most common
                            patterns of invention found across all technical fields, from Segmentation and Asymmetry to
                            Phase Transitions and Composite Materials. Each principle provides concrete strategies for
                            transforming systems to resolve contradictions and achieve breakthrough improvements.</li>
                        <li><strong>Contradiction Matrix</strong><br>The matrix systematically maps 39 improving
                            parameters against 39 worsening parameters to suggest the most relevant principles for
                            resolving specific technical contradictions. Modern versions (like the 2003 matrix) expand
                            this to 48 parameters for greater precision and applicability to contemporary engineering
                            challenges.</li>
                        <li><strong>Physical Contradictions</strong><br>Physical Contradictions occur when a single
                            parameter requires opposite states or properties. For example, a coffee cup needs to be hot
                            to keep coffee warm but cool to hold comfortably. These are resolved using
                            <strong>Separation Principles</strong> (Separation in Space, Time, Condition, and System
                            Level) that allow the contradictory requirements to be satisfied simultaneously.
                        </li>
                        <li><strong>9 Windows (System Operator)</strong><br>The 9 Windows tool analyzes systems across
                            three time dimensions (past, present, future) and three system levels (sub-system, system,
                            super-system). This structured thinking framework helps identify opportunities for
                            innovation, anticipate future developments, and understand system evolution patterns. By
                            considering all nine perspectives, innovators can break psychological inertia and discover
                            solutions that might be missed when focusing only on the present system state.</li>
                        <li><strong>Function Analysis</strong><br>Function Analysis is a systematic method to map all
                            interactions between components in a system. Each function is analyzed for its usefulness,
                            harmfulness, or neutrality, and evaluated for performance (normal, insufficient, excessive).
                            This creates a comprehensive model of the system that reveals problematic interactions,
                            identifies opportunities for improvement, and provides a foundation for applying TRIZ
                            solution tools effectively.</li>
                        <li><strong>Su-Field Analysis</strong><br>Developed from Altshuller's work on substance-field
                            modeling, Su-Field analysis represents any technical system as interactions between three
                            fundamental elements:
                            <ul>
                                <li><strong>Substance 1 (S1)</strong>: The object being acted upon or transformed</li>
                                <li><strong>Substance 2 (S2)</strong>: The tool performing the action or causing the
                                    transformation</li>
                                <li><strong>Field (F)</strong>: The energy or force causing the interaction between S1
                                    and S2</li>
                            </ul>
                            The <strong>76 Standard Solutions</strong> provide specific transformations for improving or
                            resolving problems in Su-Field systems, categorized into five classes from building complete
                            systems to simplification strategies. This systematic approach ensures that even complex
                            system interactions can be analyzed and improved methodically.
                        </li>
                        <li><strong>Knowledge Effects (Upcoming Feature)</strong><br>This advanced tool will leverage
                            scientific and engineering effects databases to suggest physical, chemical, or biological
                            phenomena that can be applied to solve specific problems. By connecting problems with known
                            scientific effects, innovators can discover breakthrough solutions based on proven
                            principles from physics, chemistry, biology, and other scientific disciplines.</li>
                    </ul>
                </div>
            </div>

            <div class="content-block">
                <h2><i class="fas fa-tools"></i> How to Use This Tool</h2>
                <div class="instructions-box">
                    <ul>
                        <li><strong>Load Example:</strong> Click "Load Example" above to populate all tools with
                            sample data.</li>
                        <li><strong>Go to TRIZ Tools:</strong> Navigate to the "TRIZ Tools" tab to access all
                            problem-solving tools.</li>
                        <li><strong>Step 1 - Define Problem:</strong> Describe the system, its primary useful function,
                            and main drawback in simple, clear terms.</li>
                        <li><strong>Step 2 - LDST Analysis:</strong> Select a fundamental law of technical system
                            development to get strategic guidance.</li>
                        <li><strong>Step 3 - Formulate Ideal Final Result (IFR):</strong> Define the ideal solution
                            where the system performs its function without the drawback, costs, or harmful effects.</li>
                        <li><strong>Step 4 - 9 Windows Analysis:</strong> Analyze the system across three time
                            dimensions (past, present, future) and three system levels (sub-system, system,
                            super-system) to identify innovation opportunities.</li>
                        <li><strong>Step 5 - Function Analysis:</strong> Map all interactions between system components
                            to identify problematic functions and improvement opportunities.</li>
                        <li><strong>Step 6 - Technical Contradiction:</strong> Identify when improving one feature makes
                            another worse. Use the contradiction matrix to find inventive principles.</li>
                        <li><strong>Step 7 - Physical Contradiction:</strong> Identify when one feature needs opposite
                            properties. Use separation principles to resolve.</li>
                        <li><strong>Step 8 - Su-Field Analysis:</strong> Model the problem as interactions between
                            substances (S1, S2) and fields (F). Identify the problem type and get standard solutions.
                        </li>
                        <li><strong>Generate Solutions:</strong> Click "Solve Problem & Generate Report" on the final
                            tab to receive inventive principles tailored to your contradictions.</li>
                        <li><strong>Export:</strong> Once the report is generated, you can export it to Excel for your
                            records and further analysis.</li>
                    </ul>

                    <div class="infographic-flow">
                        <div class="flow-step"><i class="fas fa-tasks"></i><strong>1. Define
                                Problem</strong><span>Analyze the system and its drawback</span></div>
                        <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                        <div class="flow-step"><i class="fas fa-project-diagram"></i><strong>2. LDST
                                Analysis</strong><span>Apply fundamental laws of technical systems</span></div>
                        <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                        <div class="flow-step"><i class="fas fa-rocket"></i><strong>3. Formulate
                                IFR</strong><span>Define the Ideal Final Result</span></div>
                        <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                        <div class="flow-step"><i class="fas fa-window-restore"></i><strong>4. 9 Windows
                            </strong><span>Analyze system across time and levels</span></div>
                        <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                        <div class="flow-step"><i class="fas fa-project-diagram"></i><strong>5. Function
                                Analysis</strong><span>Map all system interactions</span></div>
                        <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                        <div class="flow-step"><i class="fas fa-exchange-alt"></i><strong>6. Technical
                                Contradiction</strong><span>Improving one feature worsens another</span></div>
                        <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                        <div class="flow-step"><i class="fas fa-exchange-alt"></i><strong>7. Physical
                                Contradiction</strong><span>One feature needs opposite properties</span></div>
                        <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                        <div class="flow-step"><i class="fas fa-atom"></i><strong>8. Su-Field
                                Analysis</strong><span>Model system interactions and apply standard solutions</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-nav-buttons">
                <button class="btn-next-tab" onclick="switchMainTab('tab-tools')">Go to TRIZ Tools <i
                        class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div id="tab-tools" class="tab-content">
            <div class="content-block">
                <h2><i class="fas fa-tools"></i> TRIZ Problem-Solving Tools</h2>
                <p>Navigate through the 8-step TRIZ methodology using the tabs below:</p>

                <!-- Sub-tabs para cada herramienta -->
                <nav class="sub-tabs-nav">
                    <button class="sub-tab-btn active" onclick="switchSubTab('sub-tab-define')">
                        <i class="fas fa-tasks"></i> 1. Define Problem
                    </button>
                    <button class="sub-tab-btn" onclick="switchSubTab('sub-tab-ldst')">
                        <i class="fas fa-project-diagram"></i> 2. LDST Analysis
                    </button>
                    <button class="sub-tab-btn" onclick="switchSubTab('sub-tab-ifr')">
                        <i class="fas fa-rocket"></i> 3. Formulate IFR
                    </button>
                    <button class="sub-tab-btn" onclick="switchSubTab('sub-tab-nine-windows')">
                        <i class="fas fa-window-restore"></i> 4. 9 Windows
                    </button>
                    <button class="sub-tab-btn" onclick="switchSubTab('sub-tab-fee')">
                        <i class="fas fa-project-diagram"></i> 5. Function Analysis
                    </button>
                    <button class="sub-tab-btn" onclick="switchSubTab('sub-tab-technical')">
                        <i class="fas fa-exchange-alt"></i> 6. Technical Contradiction
                    </button>
                    <button class="sub-tab-btn" onclick="switchSubTab('sub-tab-physical')">
                        <i class="fas fa-exchange-alt"></i> 7. Physical Contradiction
                    </button>
                    <button class="sub-tab-btn" onclick="switchSubTab('sub-tab-sufield')">
                        <i class="fas fa-atom"></i> 8. Su-Field Analysis
                    </button>
                </nav>

                <!-- Sub-tab 1: Define Problem -->
                <div id="sub-tab-define" class="sub-tab-content active">
                    <div class="solver-step">
                        <h3><i class="fas fa-tasks"></i> 1. Define the Problem</h3>
                        <div class="form-group">
                            <label for="problem-system">System/Object to improve?</label>
                            <input type="text" id="problem-system" placeholder="e.g., A coffee mug">
                        </div>
                        <div class="form-group">
                            <label for="problem-function">Primary useful function?</label>
                            <input type="text" id="problem-function" placeholder="e.g., To hold hot liquid">
                        </div>
                        <div class="form-group">
                            <label for="problem-harm">Main drawback?</label>
                            <input type="text" id="problem-harm" placeholder="e.g., Burns the hand">
                        </div>
                    </div>

                    <div class="sub-tab-nav-buttons">
                        <div></div> <!-- Empty div for spacing -->
                        <button class="btn-next-sub-tab" onclick="switchSubTab('sub-tab-ldst')">Next: LDST Analysis <i
                                class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- Sub-tab 2: LDST Analysis -->
                <div id="sub-tab-ldst" class="sub-tab-content">
                    <div class="solver-step">
                        <h3><i class="fas fa-project-diagram"></i> 2. Laws of Development of Technical Systems (LDST)
                        </h3>
                        <p>Select the life cycle stage of your system to get the most relevant development laws
                            according to
                            Altshuller's classical framework.</p>

                        <div class="form-group">
                            <label for="lifecycle-stage">System Life Cycle Stage:</label>
                            <select id="lifecycle-stage" onchange="updateLDSTRecommendations();">
                                <option value="birth">Birth (Introduction Phase)</option>
                                <option value="growth">Growth Phase</option>
                                <option value="maturity">Maturity Phase</option>
                                <option value="decline">Decline Phase</option>
                                <option value="transition">Transition to New System</option>
                            </select>
                        </div>

                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn-success" onclick="toggleLawsTable()"><i class="fas fa-table"></i>
                                Show/Hide
                                All
                                LDST Laws</button>
                        </div>

                        <div id="laws-table-container" class="hidden">
                            <div class="content-block">
                                <h4><i class="fas fa-graduation-cap"></i> Laws of Development of Technical Systems
                                    (LDST)
                                </h4>
                                <p style="margin-bottom: 1.5rem; font-style: italic; font-weight: bold;">
                                    Source: Altshuller, G. S. (1984). Creativity as an Exact Science: The Theory of the
                                    Solution
                                    of Inventive Problems.
                                </p>
                                <div style="overflow-x: auto;">
                                    <table class="trends-table">
                                        <thead>
                                            <tr>
                                                <th>Law #</th>
                                                <th>Name</th>
                                                <th>Description</th>
                                                <th>Key Principles</th>
                                                <th>Examples</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr id="law-1">
                                                <td><i class="fas fa-cube"></i> 1</td>
                                                <td>System Integrity</td>
                                                <td>System must have all essential parts and minimal connections</td>
                                                <td>Completeness, Conductivity, Coordination</td>
                                                <td>Combustion engine, writing system</td>
                                            </tr>
                                            <tr id="law-2">
                                                <td><i class="fas fa-bolt"></i> 2</td>
                                                <td>Energy Conductivity</td>
                                                <td>Energy must flow unobstructed through all parts</td>
                                                <td>Eliminate intermediaries, Increase conductivity</td>
                                                <td>Copper wires, gears, fiber optics</td>
                                            </tr>
                                            <tr id="law-3">
                                                <td><i class="fas fa-music"></i> 3</td>
                                                <td>Harmony</td>
                                                <td>Parts coordinated in rhythm, frequency and structure</td>
                                                <td>Synchronization, Resonance</td>
                                                <td>4-stroke engine, multi-core processors</td>
                                            </tr>
                                            <tr id="law-4" class="recommended-trend">
                                                <td><i class="fas fa-rocket"></i> 4</td>
                                                <td>Ideality</td>
                                                <td>More functions with fewer resources and complexity</td>
                                                <td>Self-service, Multiple functions</td>
                                                <td>Smartphones, electric vehicles</td>
                                            </tr>
                                            <tr id="law-5">
                                                <td><i class="fas fa-tachometer-alt"></i> 5</td>
                                                <td>Uneven Development</td>
                                                <td>Parts develop at different rates creating contradictions</td>
                                                <td>Identify lagging subsystems</td>
                                                <td>Processors vs memory, batteries vs screens</td>
                                            </tr>
                                            <tr id="law-6">
                                                <td><i class="fas fa-expand-arrows-alt"></i> 6</td>
                                                <td>Transition to Supersystem</td>
                                                <td>Systems integrate into larger supersystems</td>
                                                <td>Integration, Expansion</td>
                                                <td>Internet, integrated transport</td>
                                            </tr>
                                            <tr id="law-7">
                                                <td><i class="fas fa-atom"></i> 7</td>
                                                <td>Transition to Micro-Level</td>
                                                <td>Development moves to microstructural levels and fields</td>
                                                <td>Fragmentation, Field utilization</td>
                                                <td>Transistors  nanochips, tools  nanobots</td>
                                            </tr>
                                            <tr id="law-8">
                                                <td><i class="fas fa-magnet"></i> 8</td>
                                                <td>Increased S-Field Complexity</td>
                                                <td>Evolution toward greater field and substance complexity</td>
                                                <td>Add new fields, Combine fields</td>
                                                <td>Mechanical  electrical  quantum</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sub-tab-nav-buttons">
                        <button class="btn-prev-sub-tab" onclick="switchSubTab('sub-tab-define')"><i
                                class="fas fa-arrow-left"></i>
                            Previous: Define Problem</button>
                        <button class="btn-next-sub-tab" onclick="switchSubTab('sub-tab-ifr')">Next: Formulate IFR <i
                                class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- Sub-tab 3: Formulate IFR -->
                <div id="sub-tab-ifr" class="sub-tab-content">
                    <div class="solver-step">
                        <h3><i class="fas fa-rocket"></i> 3. Formulate Ideal Final Result (IFR)</h3>
                        <div class="form-group">
                            <label for="ifr-formulation">The system <strong>itself</strong> performs the
                                function without the drawback:</label>
                            <textarea id="ifr-formulation"
                                placeholder="e.g., The coffee mug itself holds hot liquid and protects the hand."></textarea>
                        </div>
                    </div>

                    <div class="sub-tab-nav-buttons">
                        <button class="btn-prev-sub-tab" onclick="switchSubTab('sub-tab-ldst')"><i
                                class="fas fa-arrow-left"></i>
                            Previous: LDST Analysis</button>
                        <button class="btn-next-sub-tab" onclick="switchSubTab('sub-tab-nine-windows')">Next: 9 Windows
                            <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- Sub-tab 4: 9 Windows -->
                <div id="sub-tab-nine-windows" class="sub-tab-content">
                    <div class="solver-step">
                        <h3><i class="fas fa-window-restore"></i> 4. 9 Windows Analysis</h3>
                        <p>Analyze the system in three time dimensions (past, present, future) and three system levels
                            (sub-system, system, super-system).</p>

                        <div class="nine-windows-container">
                            <!-- Tabla de 9 Windows -->
                            <table class="nine-windows-table">
                                <tr>
                                    <td style="width: 80px; border: none;"></td>
                                    <td
                                        style="text-align: center; font-weight: bold; padding: 10px; background: #f0f7ff;">
                                        Past</td>
                                    <td
                                        style="text-align: center; font-weight: bold; padding: 10px; background: #f0f7ff;">
                                        Present</td>
                                    <td
                                        style="text-align: center; font-weight: bold; padding: 10px; background: #f0f7ff;">
                                        Future</td>
                                </tr>
                                <tr>
                                    <td
                                        style="text-align: right; font-weight: bold; padding: 10px; background: #fff0f0; vertical-align: middle;">
                                        Super-System
                                    </td>
                                    <td style="padding: 5px;">
                                        <textarea id="nine-windows-super-past" rows="3"
                                            placeholder="e.g., Manufacturing plant, Raw materials"
                                            style="width: 100%; height: 100px; background: #f0f7ff; border: 1px solid #a0c8ff;"></textarea>
                                    </td>
                                    <td style="padding: 5px;">
                                        <textarea id="nine-windows-super-present" rows="3"
                                            placeholder="e.g., Road, Gravity, Weather"
                                            style="width: 100%; height: 100px; background: #f0f7ff; border: 1px solid #a0c8ff;"></textarea>
                                    </td>
                                    <td style="padding: 5px;">
                                        <textarea id="nine-windows-super-future" rows="3"
                                            placeholder="e.g., Recycling center, Scrap yard"
                                            style="width: 100%; height: 100px; background: #f0f7ff; border: 1px solid #a0c8ff;"></textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td
                                        style="text-align: right; font-weight: bold; padding: 10px; background: #f0fff0; vertical-align: middle;">
                                        System
                                    </td>
                                    <td style="padding: 5px;">
                                        <textarea id="nine-windows-system-past" rows="3"
                                            placeholder="e.g., Metal tubes, Welding process"
                                            style="width: 100%; height: 100px; background: #f0fff0; border: 1px solid #a0d0a0;"></textarea>
                                    </td>
                                    <td style="padding: 5px;">
                                        <textarea id="nine-windows-system-present" rows="3"
                                            placeholder="e.g., Bicycle Frame"
                                            style="width: 100%; height: 100px; background: #f0fff0; border: 1px solid #a0d0a0;"></textarea>
                                    </td>
                                    <td style="padding: 5px;">
                                        <textarea id="nine-windows-system-future" rows="3"
                                            placeholder="e.g., Rusted frame, Broken frame"
                                            style="width: 100%; height: 100px; background: #f0fff0; border: 1px solid #a0d0a0;"></textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td
                                        style="text-align: right; font-weight: bold; padding: 10px; background: #fff0f0; vertical-align: middle;">
                                        Sub-System
                                    </td>
                                    <td style="padding: 5px;">
                                        <textarea id="nine-windows-sub-past" rows="3"
                                            placeholder="e.g., Molten metal, Ore"
                                            style="width: 100%; height: 100px; background: #fff0f0; border: 1px solid #ffa0a0;"></textarea>
                                    </td>
                                    <td style="padding: 5px;">
                                        <textarea id="nine-windows-sub-present" rows="3"
                                            placeholder="e.g., Tubes, Welds, Paint"
                                            style="width: 100%; height: 100px; background: #fff0f0; border: 1px solid #ffa0a0;"></textarea>
                                    </td>
                                    <td style="padding: 5px;">
                                        <textarea id="nine-windows-sub-future" rows="3"
                                            placeholder="e.g., Corroded metal, Flaking paint"
                                            style="width: 100%; height: 100px; background: #fff0f0; border: 1px solid #ffa0a0;"></textarea>
                                    </td>
                                </tr>
                            </table>

                            <div style="margin-top: 20px; font-size: 0.9rem; color: #666; text-align: center;">
                                <strong>Color Guide:</strong>
                                <span style="color: #0066cc;">Super-System (Blue)</span> |
                                <span style="color: #009900;">System (Green)</span> |
                                <span style="color: #cc0000;">Sub-System (Red)</span>
                            </div>
                        </div>
                    </div>

                    <div class="sub-tab-nav-buttons">
                        <button class="btn-prev-sub-tab" onclick="switchSubTab('sub-tab-ifr')"><i
                                class="fas fa-arrow-left"></i> Previous: Formulate IFR</button>
                        <button class="btn-next-sub-tab" onclick="switchSubTab('sub-tab-fee')">Next: Function Analysis
                            <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- Sub-tab 5: Function Analysis -->
                <div id="sub-tab-fee" class="sub-tab-content">
                    <div class="solver-step">
                        <h3><i class="fas fa-project-diagram"></i> 5. Function Analysis</h3>
                        <p>Analyze the system through 5 systematic steps: Define main function, identify components,
                            analyze interactions, create function table, and visualize the model.</p>

                        <!-- Step 1: Main Function -->
                        <div class="calculation-block" style="margin-top: 20px;">
                            <div class="calculation-title">Step 1: Main Function</div>
                            <div class="form-group">
                                <label for="main-function">What is the main function?</label>
                                <input type="text" id="main-function" placeholder="e.g., To hold hot liquid"
                                    onchange="updateFunctionAnalysis()">
                            </div>
                            <div class="form-group">
                                <label for="target-component">What is the target component?</label>
                                <input type="text" id="target-component" placeholder="e.g., Liquid"
                                    onchange="updateFunctionAnalysis()">
                            </div>
                        </div>

                        <!-- Step 2: Component Analysis -->
                        <div class="calculation-block" style="margin-top: 20px;">
                            <div class="calculation-title">Step 2: Component Analysis</div>

                            <div style="margin-bottom: 15px; padding: 10px; background: #f0f7ff; border-radius: 5px;">
                                <p><strong>Target Component:</strong> <span id="target-component-display">Not
                                        defined</span></p>
                                <p><strong>Main Function:</strong> <span id="main-function-display">Not defined</span>
                                </p>
                            </div>

                            <div class="panels-container" style="display: flex; flex-wrap: wrap; gap: 1.25rem;">
                                <!-- System Components -->
                                <div class="panel-half" style="flex: 1; min-width: 300px;">
                                    <h4>System Components:</h4>
                                    <p class="small-note">Components are parts with mass and fields.</p>
                                    <div class="form-group" style="display: flex; gap: 10px;">
                                        <input type="text" id="system-component-input" placeholder="e.g., Handle, Wall"
                                            style="flex: 1;">
                                        <button class="btn-success" onclick="addSystemComponent()">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                    <div class="item-list" id="system-components-list"></div>
                                </div>

                                <!-- Supersystem Components -->
                                <div class="panel-half" style="flex: 1; min-width: 300px;">
                                    <h4>Supersystem Components:</h4>
                                    <p class="small-note">Components are parts with mass and fields.</p>
                                    <div class="form-group" style="display: flex; gap: 10px;">
                                        <input type="text" id="supersystem-component-input"
                                            placeholder="e.g., Air, Hand, Table" style="flex: 1;">
                                        <button class="btn-success" onclick="addSupersystemComponent()">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                    <div class="item-list" id="supersystem-components-list"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Interaction Analysis -->
                        <div class="calculation-block" style="margin-top: 20px;">
                            <div class="calculation-title">Step 3: Interaction Analysis</div>
                            <p>Which components are in contact with the others, touch each other?</p>

                            <div id="interaction-matrix-container" style="overflow-x: auto; margin-top: 15px;">
                                <p><em>Define components in Step 2 first to see the interaction matrix.</em></p>
                            </div>
                        </div>

                        <!-- Step 4: Functional Analysis (Tabular) -->
                        <div class="calculation-block" style="margin-top: 20px;">
                            <div class="calculation-title">Step 4: Functional Analysis (Tabular)</div>

                            <div class="form-group" style="margin-bottom: 15px;">
                                <button class="btn-success" onclick="addFunctionRow()">
                                    <i class="fas fa-plus"></i> Add Function Row
                                </button>
                            </div>

                            <div style="overflow-x: auto;">
                                <table class="trends-table" id="function-table">
                                    <thead>
                                        <tr>
                                            <th>Component (function carrier)</th>
                                            <th>Action (Verb)</th>
                                            <th>Target (Object of the Function)</th>
                                            <th>Category<br>(U=useful, H=harmful)</th>
                                            <th>Perform. level<br>(I=insufficient, E=excessive, N=normal)</th>
                                            <th>Comment</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="function-table-body">
                                        <!-- Rows will be added dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Step 5: Function Model Diagram -->
                        <div class="calculation-block" style="margin-top: 20px;">
                            <div class="calculation-title">Step 5: Function Model Diagram</div>

                            <div class="mermaid-container" id="faMermaidPreview">
                                <div class="mermaid">
                                    graph LR;
                                    A[Define Components] --> B[Define Functions] --> C[Diagram will appear here]
                                </div>
                            </div>

                            <!-- Legend for the diagram -->
                            <div class="diagram-legend">
                                <h5 class="legend-title">Diagram Legend</h5>
                                <div class="legend-grid">
                                    <div class="legend-item">
                                        <div class="legend-color-box"
                                            style="background: #dceeff; border: 2px solid #82b6ff;"></div>
                                        <span>System Component</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color-box"
                                            style="background: #ffe6cc; border: 2px solid #d79b00; clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);">
                                        </div>
                                        <span>Supersystem Component (Hexagon)</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color-box"
                                            style="background: #ffffcc; border: 2px solid #d6b656; border-radius: 10px;">
                                        </div>
                                        <span>Target Component (Rounded)</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-line-sample" style="background: #000; height: 2px;"></div>
                                        <span>Useful Function (Normal)</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-line-sample" style="border: 1px dashed #000; height: 2px;">
                                        </div>
                                        <span>Useful Function (Insufficient)</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-line-sample" style="background: #000; height: 3px;"></div>
                                        <span>Useful Function (Excessive)</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-line-sample" style="background: #e74c3c; height: 3px;"></div>
                                        <span>Harmful Function</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-line-sample" style="border: 1px dashed #999; height: 2px;">
                                        </div>
                                        <span>Neutral Function</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sub-tab-nav-buttons">
                        <button class="btn-prev-sub-tab" onclick="switchSubTab('sub-tab-nine-windows')"><i
                                class="fas fa-arrow-left"></i> Previous: 9 Windows</button>
                        <button class="btn-next-sub-tab" onclick="switchSubTab('sub-tab-technical')">Next: Technical
                            Contradiction
                            <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- Sub-tab 6: Technical Contradiction -->
                <div id="sub-tab-technical" class="sub-tab-content">
                    <div class="solver-step">
                        <h3><i class="fas fa-exchange-alt"></i> 6. Technical Contradiction</h3>
                        <p>Improving one feature makes another worse. Use the contradiction matrix to find inventive
                            principles.</p>

                        <div class="matrix-version-selector">
                            <div class="form-group">
                                <label for="matrix-version">TRIZ Matrix Version:</label>
                                <div class="radio-group" style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <label>
                                        <input type="radio" name="matrix-version" value="classic" checked
                                            onchange="changeMatrixVersion();">
                                        <strong>Classic Matrix</strong> (39 parameters, 40 principles)
                                    </label>
                                    <label>
                                        <input type="radio" name="matrix-version" value="2003"
                                            onchange="changeMatrixVersion();">
                                        <strong>2003 Matrix</strong> (48 parameters, 40 principles)
                                    </label>
                                </div>
                                <div class="matrix-version-info" id="matrix-version-info">
                                    Using Classic TRIZ Matrix - The original 39x39 matrix. Altshuller, G. S.
                                    (1950-1980). 40
                                    Principles: TRIZ Keys to Technical Innovation o The Innovation Algorithm: TRIZ,
                                    Systematic
                                    Innovation and Technical Creativity.
                                </div>
                            </div>
                        </div>

                        <div id="technical-solver-block">
                            <div class="matrix-toggle">
                                <button class="btn-success" onclick="toggleMatrixView()"><i class="fas fa-table"></i>
                                    Show/Hide
                                    Contradiction Matrix</button>
                            </div>

                            <div id="dropdown-view">
                                <div class="form-group"><label for="improving-feature">Feature to
                                        Improve:</label><select id="improving-feature"></select></div>
                                <div class="form-group"><label for="worsening-feature">Feature that
                                        Worsens:</label><select id="worsening-feature"></select></div>
                            </div>

                            <div id="matrix-view" class="hidden">
                                <p><strong>Click on a cell to select improving (row) and worsening (column) features.
                                        Hover
                                        your
                                        cursor over the cell to see more information</strong></p>
                                <div class="matrix-container">
                                    <table class="matrix-table" id="contradiction-matrix">
                                    </table>
                                </div>
                                <div style="margin-top: 10px;">
                                    <strong>Selected:</strong>
                                    <span id="selected-improving">None</span> 
                                    <span id="selected-worsening">None</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sub-tab-nav-buttons">
                        <button class="btn-prev-sub-tab" onclick="switchSubTab('sub-tab-fee')"><i
                                class="fas fa-arrow-left"></i>
                            Previous: Function Analysis</button>
                        <button class="btn-next-sub-tab" onclick="switchSubTab('sub-tab-physical')">Next: Physical
                            Contradiction <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- Sub-tab 7: Physical Contradiction (NUEVO ALGORITMO) -->
                <div id="sub-tab-physical" class="sub-tab-content">
                    <div class="solver-step">
                        <h3><i class="fas fa-exchange-alt"></i> 7. Physical Contradiction</h3>
                        <p>One feature needs opposite properties. Use the intersection test algorithm to determine the
                            best resolution strategy.</p>

                        <div id="physical-solver-block">
                            <div class="form-group">
                                <label for="conflicting-parameter">Parameter with conflicting requirements?</label>
                                <input type="text" id="conflicting-parameter"
                                    placeholder="e.g., Temperature, Size, Visibility">
                            </div>

                            <!-- Paso 1: Test de Intersecci칩n -->
                            <div class="solver-step" id="physical-step-1">
                                <h4><i class="fas fa-cogs"></i> Step 1: Intersection Test (Space and Time)</h4>
                                <p>Analyze the Operational Zones (OZ) and Operational Times (OT) where the two opposite
                                    demands (A and Anti-A) occur.</p>
                                <div class="form-group">
                                    <label>Do the Operational Zones (OZ) and Operational Times (OT) of the two opposite
                                        demands (A and Anti-A) intersect?</label>
                                    <div class="radio-group">
                                        <label><input type="radio" name="intersection-test" value="no-intersection"
                                                onchange="updatePhysicalStrategy();"> <strong>No, they do NOT
                                                intersect</strong> (different place or time)</label>
                                        <label><input type="radio" name="intersection-test" value="contiguous"
                                                onchange="updatePhysicalStrategy();"> <strong>They are
                                                contiguous</strong> (touch at a boundary)</label>
                                        <label><input type="radio" name="intersection-test" value="total-intersection"
                                                onchange="updatePhysicalStrategy();"> <strong>Yes, they totally
                                                intersect</strong> (overlap completely)</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Paso 2: Para intersecci칩n total, separaci칩n por condici칩n o sistema -->
                            <div class="solver-step hidden" id="physical-step-2">
                                <h4><i class="fas fa-exchange-alt"></i> Step 2: For Total Intersection, try Separation
                                    by Condition or System Level</h4>
                                <p>When demands completely overlap, try separating them by different perspectives or
                                    system hierarchy levels.</p>
                                <div class="form-group">
                                    <label>Can the opposite demands be separated by condition (different systems or
                                        users) or by system level (whole vs parts)?</label>
                                    <div class="radio-group">
                                        <label><input type="radio" name="separation-type" value="condition"
                                                onchange="updatePhysicalStrategy();"> <strong>Yes, by condition</strong>
                                            (different perspectives)</label>
                                        <label><input type="radio" name="separation-type" value="system-level"
                                                onchange="updatePhysicalStrategy();"> <strong>Yes, by system
                                                level</strong> (whole vs parts)</label>
                                        <label><input type="radio" name="separation-type" value="neither"
                                                onchange="updatePhysicalStrategy();"> <strong>No, neither condition nor
                                                system level separation works</strong></label>
                                    </div>
                                </div>
                            </div>

                            <!-- Bot칩n para mostrar/ocultar la tabla de referencia -->
                            <div class="form-group" id="principles-toggle-container"
                                style="text-align: center; margin: 1rem 0;">
                                <button type="button" class="btn-success" onclick="togglePrinciplesTable()">
                                    <i class="fas fa-table"></i> Show/Hide Physical Contradiction Principles Reference
                                </button>
                            </div>

                            <div class="hidden" id="principles-table-container">
                                <div class="content-block">
                                    <h4><i class="fas fa-lightbulb"></i> Complete Physical Contradiction Principles
                                        Reference</h4>
                                    <div id="principles-table-content">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sub-tab-nav-buttons">
                        <button class="btn-prev-sub-tab" onclick="switchSubTab('sub-tab-technical')"><i
                                class="fas fa-arrow-left"></i>
                            Previous: Technical Contradiction</button>
                        <button class="btn-next-sub-tab" onclick="switchSubTab('sub-tab-sufield')">Next: Su-Field
                            Analysis <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- Sub-tab 8: Su-Field Analysis -->
                <div id="sub-tab-sufield" class="sub-tab-content">
                    <div class="solver-step">
                        <h3><i class="fas fa-atom"></i> 8. Su-Field Analysis</h3>
                        <p>Model your problem as interactions between substances (S1, S2) and fields (F). Each system
                            can
                            have
                            its own problem type.</p>

                        <div id="sufield-systems-container">
                        </div>

                        <div class="form-group" style="margin-top: 10px;">
                            <button type="button" class="btn-success" onclick="addSuFieldSystem()"><i
                                    class="fas fa-plus"></i>
                                Add Su-Field System</button>
                        </div>

                        <div class="form-group" style="margin-top: 20px; text-align: center;">
                            <button type="button" class="btn-success" onclick="toggleSolutionsMatrix()">
                                <i class="fas fa-table"></i> Show/Hide 76 Standard Solutions Matrix
                            </button>
                        </div>

                        <div id="solutions-matrix-container" class="hidden">
                            <div id="solutions-matrix-content">
                            </div>
                        </div>
                    </div>

                    <div class="sub-tab-nav-buttons">
                        <button class="btn-prev-sub-tab" onclick="switchSubTab('sub-tab-physical')"><i
                                class="fas fa-arrow-left"></i>
                            Previous: Physical Contradiction</button>
                        <div></div> <!-- Empty div for spacing -->
                    </div>
                </div>
            </div>

            <div class="tab-nav-buttons">
                <button class="btn-next-tab btn-prev" onclick="switchMainTab('tab-start')"><i
                        class="fas fa-arrow-left"></i>
                    Previous:
                    Info</button>
                <button class="btn-next-tab" onclick="switchMainTab('tab-solve')">Next: Solve & Report <i
                        class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div id="tab-solve" class="tab-content">
            <div class="solver-step" style="text-align: center; padding: 30px;">
                <h2 style="color: var(--secondary-color);">Ready to Generate Solution?</h2>
                <p>This will gather all data from Define, LDST, IFR, 9 Windows, Function Analysis, Technical
                    Contradiction, Physical Contradiction, and
                    Su-Field
                    analysis.</p>
                <button id="solve-button" onclick="solveProblem()"
                    style="max-width: 400px; margin: 0 auto; display: inline-block;">
                    <i class="fas fa-calculator"></i> Solve Problem & Generate Report
                </button>
            </div>

            <div id="results-container" class="hidden"></div>

            <div class="tab-nav-buttons">
                <button class="btn-next-tab" onclick="switchMainTab('tab-start')">Back to Start & Info <i
                        class="fas fa-arrow-left"></i></button>
            </div>
        </div>

    </main>

    <footer>
        <div class="disclaimer-note">
            <p><strong>Disclaimer:</strong> This tool is an educational implementation of the TRIZ (Theory of Inventive
                Problem Solving) methodology, originally developed by Genrich Altshuller. It is not affiliated with,
                sponsored by, or endorsed by any official TRIZ organizations. The principles and solutions suggested are
                for informational purposes only. We make no warranties regarding the effectiveness or novelty of any
                ideas generated. The user assumes full responsibility for the application and validation of concepts
                derived from this tool. Sigma Exacta and its creators are not liable for any damages or losses resulting
                from its use.</p>
        </div>
    </footer>

    <script src="trizcontradiction.js"></script>
    <script src="trizcontradiction2003.js"></script>
    <script src="physicalcontradictionprinciples1993.js"></script>
    <script src="76principlestriz.js"></script>
    <script src="sufield-diagrams.js"></script>
    <script src="ldst.js"></script>
    <script src="trizconstants.js"></script>

    <script>
        // ===== VARIABLES GLOBALES =====
        let problemData = {};
        let exampleIndex = 0;
        let improvingFeatureIndex = null;
        let worseningFeatureIndex = null;
        let currentMatrixVersion = 'classic';
        let currentRecommendedLaws = ['law4'];
        let globalSuFieldCounter = 0; // Added global counter to avoid duplicate IDs

        // Variables para el nuevo flujo de contradicciones f칤sicas (ALGORITMO NUEVO)
        let physicalStrategyFlow = {
            step1: false,
            step2: false,
            selectedIntersection: null,
            selectedSeparation: null,
            strategy: null,
            principles: []
        };

        // ===== FUNCIONES DE NAVEGACI칍N =====
        function switchMainTab(tabId) {
            // Quitar clase active de todos los botones y contenidos principales
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Activar el contenido seleccionado
            document.getElementById(tabId).classList.add('active');

            // Activar bot칩n correspondiente
            const activeBtn = document.querySelector(`button[onclick="switchMainTab('${tabId}')"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Si estamos en la pesta침a de herramientas, asegurar que se muestra la primera subtab
            if (tabId === 'tab-tools') {
                switchSubTab('sub-tab-define');
            }

            // Scroll al top suavemente
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // NUEVA FUNCI칍N: Para cambiar entre sub-tabs
        function switchSubTab(subTabId) {
            // Quitar clase active de todos los botones de sub-tabs
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));

            // Activar el bot칩n correspondiente
            const activeBtn = document.querySelector(`button[onclick="switchSubTab('${subTabId}')"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Activar el contenido correspondiente
            const subTabContent = document.getElementById(subTabId);
            if (subTabContent) {
                subTabContent.classList.add('active');

                // Si estamos en la sub-tab de Function Analysis, actualizar el diagrama Mermaid
                if (subTabId === 'sub-tab-fee') {
                    setTimeout(() => {
                        updateFunctionDiagram();
                    }, 100);
                }
            }

            // Scroll al top de la sub-tab
            const subTabsNav = document.querySelector('.sub-tabs-nav');
            if (subTabsNav) {
                window.scrollTo({ top: subTabsNav.offsetTop - 20, behavior: 'smooth' });
            }
        }

        // ===== CARGAR HEADER DIN츼MICAMENTE =====
        document.addEventListener('DOMContentLoaded', function () {
            // Cargar el header desde header.html
            fetch('header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                    initNavigationMenu();
                })
                .catch(error => console.error('Error loading header:', error));

            init(); // Inicializar tool

            // Asignar eventos a los botones globales
            document.getElementById('globalLoadExampleBtn').addEventListener('click', loadExampleAndGo);
            document.getElementById('globalResetBtn').addEventListener('click', resetTool);

            // Inicializar Mermaid para Function Analysis
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: false, // Cambiado a false para control manual
                    theme: 'default',
                    securityLevel: 'loose',
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true,
                        curve: 'basis'
                    },
                    gantt: {
                        useMaxWidth: true,
                        barHeight: 20,
                        fontSize: 12
                    },
                    sequence: {
                        useMaxWidth: true,
                        diagramMarginX: 50,
                        diagramMarginY: 10,
                        boxTextMargin: 5
                    }
                });
            }

            // Verificar que todos los archivos JS se hayan cargado correctamente
            setTimeout(() => {
                console.log('TRIZ files loaded:');
                console.log('- trizcontradiction.js:', typeof trizContradictionMatrix !== 'undefined');
                console.log('- trizcontradiction2003.js:', typeof trizContradictionMatrix2003 !== 'undefined');
                console.log('- physicalcontradictionprinciples1993.js:', typeof physicalContradictionPrinciples !== 'undefined');
                console.log('- 76principlestriz.js:', typeof trizStandardSolutions !== 'undefined');
                console.log('- sufield-diagrams.js:', typeof updateSuFieldDiagram !== 'undefined');
                console.log('- ldst.js:', typeof lifecycleToLdstMapping !== 'undefined');
                console.log('- trizconstants.js:', typeof examples !== 'undefined');
            }, 500);

            // Inicializar Function Analysis
            initFunctionAnalysis();
        });

        // ===== INICIALIZAR EL MEN칔 DE NAVEGACI칍N =====
        function initNavigationMenu() {
            const navToggle = document.getElementById('nav-toggle');
            const navMenu = document.getElementById('nav-menu');
            const toolsDropdownToggle = document.getElementById('tools-dropdown-toggle');
            const toolsDropdownMenu = document.getElementById('tools-dropdown-menu');
            const toolsDropdownContainer = document.getElementById('tools-dropdown-container');

            if (navToggle) {
                navToggle.addEventListener('click', () => {
                    navMenu.classList.toggle('show-menu');
                    const icon = navToggle.querySelector('i');
                    icon.classList.toggle('fa-bars');
                    icon.classList.toggle('fa-times');
                    if (!navMenu.classList.contains('show-menu')) {
                        toolsDropdownMenu.classList.remove('show-submenu');
                        toolsDropdownContainer.classList.remove('active');
                    }
                });
            }

            if (toolsDropdownToggle) {
                toolsDropdownToggle.addEventListener('click', (event) => {
                    if (window.innerWidth <= 992) {
                        event.preventDefault();
                        toolsDropdownMenu.classList.toggle('show-submenu');
                        toolsDropdownContainer.classList.toggle('active');
                    }
                });
            }
        }

        // ===== FUNCIONES DE INICIALIZACI칍N =====
        function init() {
            populateDropdowns();
            createContradictionMatrix();

            // Inicializar LDST
            setTimeout(() => {
                updateLDSTRecommendations();
            }, 100);

            // Agregar sistema Su-Field con un peque침o delay para asegurar que el DOM est칠 listo
            setTimeout(() => {
                addSuFieldSystem();
            }, 150);
        }

        // ===== FUNCIONES DE EJEMPLO Y RESET =====
        function loadExampleAndGo() {
            loadExample();
            switchMainTab('tab-tools');
            switchSubTab('sub-tab-define');
        }

        function resetTool() {
            problemData = {};
            document.querySelectorAll('input[type="text"], textarea, select').forEach(el => {
                if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
            });
            document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);

            // Reset specific elements
            document.getElementById('technical-solver-block').classList.add('hidden');
            document.getElementById('matrix-version-selector-container').classList.add('hidden');
            document.getElementById('lifecycle-stage').value = 'birth';
            document.querySelector('input[name="matrix-version"][value="classic"]').checked = true;

            // Reset physical strategy flow (NUEVO ALGORITMO)
            physicalStrategyFlow = {
                step1: false,
                step2: false,
                selectedIntersection: null,
                selectedSeparation: null,
                strategy: null,
                principles: []
            };

            // Reset physical steps UI (NUEVO ALGORITMO)
            document.getElementById('physical-step-2').classList.add('hidden');
            document.getElementById('principles-toggle-container').style.display = 'block';

            // Reset 9 Windows fields
            document.getElementById('nine-windows-super-past').value = '';
            document.getElementById('nine-windows-super-present').value = '';
            document.getElementById('nine-windows-super-future').value = '';
            document.getElementById('nine-windows-system-past').value = '';
            document.getElementById('nine-windows-system-present').value = '';
            document.getElementById('nine-windows-system-future').value = '';
            document.getElementById('nine-windows-sub-past').value = '';
            document.getElementById('nine-windows-sub-present').value = '';
            document.getElementById('nine-windows-sub-future').value = '';

            clearResults();

            // Reset matrix selection
            improvingFeatureIndex = null;
            worseningFeatureIndex = null;
            document.getElementById('selected-improving').textContent = 'None';
            document.getElementById('selected-worsening').textContent = 'None';
            updateMatrixDisplay();

            // Reset Su-Field systems
            document.getElementById('sufield-systems-container').innerHTML = '';
            globalSuFieldCounter = 0;

            // Reset solutions matrix
            document.getElementById('solutions-matrix-container').classList.add('hidden');

            // Reset LDST
            updateLDSTRecommendations();

            // Reset Function Analysis
            resetFunctionAnalysis();

            // Usar setTimeout para agregar el sistema despu칠s de limpiar
            setTimeout(() => {
                addSuFieldSystem();
            }, 50);

            // Volver a la pesta침a inicial
            switchMainTab('tab-start');
            switchSubTab('sub-tab-define');
        }

        // ===== FUNCIONES DE LDST =====
        function updateLDSTRecommendations() {
            const lifecycleStage = document.getElementById('lifecycle-stage').value;
            currentRecommendedLaws = lifecycleToLdstMapping[lifecycleStage] || ["law4"];
            const recommendationText = lifecycleRecommendations[lifecycleStage] || "";

            let recommendationElement = document.getElementById('ldst-recommendation-info');
            if (!recommendationElement) {
                const lifecycleSelect = document.getElementById('lifecycle-stage');
                recommendationElement = document.createElement('div');
                recommendationElement.id = 'ldst-recommendation-info';
                recommendationElement.style.marginTop = '10px';
                recommendationElement.style.fontStyle = 'italic';
                recommendationElement.style.color = '#666';
                lifecycleSelect.parentNode.appendChild(recommendationElement);
            }

            recommendationElement.textContent =
                `Selected for ${document.getElementById('lifecycle-stage').options[document.getElementById('lifecycle-stage').selectedIndex].text}: ${recommendationText}`;

            updateLawsTable();
        }

        function updateLawsTable() {
            for (let i = 1; i <= 8; i++) {
                const lawElement = document.getElementById(`law-${i}`);
                if (lawElement) {
                    lawElement.classList.remove('recommended-trend');
                }
            }

            currentRecommendedLaws.forEach(lawId => {
                const lawNumber = lawId.replace('law', '');
                const selectedLawElement = document.getElementById(`law-${lawNumber}`);
                if (selectedLawElement) {
                    selectedLawElement.classList.add('recommended-trend');
                }
            });
        }

        function toggleLawsTable() {
            const container = document.getElementById('laws-table-container');
            container.classList.toggle('hidden');
        }

        // ===== FUNCIONES DE MATRIZ TRIZ =====
        function changeMatrixVersion() {
            const selectedVersion = document.querySelector('input[name="matrix-version"]:checked').value;
            currentMatrixVersion = selectedVersion;

            populateDropdowns();
            createContradictionMatrix();

            improvingFeatureIndex = null;
            worseningFeatureIndex = null;
            updateMatrixDisplay();
            updateSelectedFeatures();
            clearResults();

            const versionInfo = document.getElementById('matrix-version-info');
            if (currentMatrixVersion === 'classic') {
                versionInfo.textContent = "Using Classic TRIZ Matrix - The original 39x39 matrix with 40 inventive principles. Altshuller, G. S. (1950-1980). 40 Principles: TRIZ Keys to Technical Innovation o The Innovation Algorithm: TRIZ, Systematic Innovation and Technical Creativity.";
            } else {
                versionInfo.textContent = "Using 2003 TRIZ Matrix 48x48 matrix- Mann, D., & Dewulf, S. (2003). Matrix 2003: Updating the TRIZ Contradiction Matrix. CREAX Press.";
            }
        }

        function getCurrentMatrix() {
            return currentMatrixVersion === 'classic' ? trizContradictionMatrix : trizContradictionMatrix2003;
        }

        function getCurrentFeatures() {
            return getCurrentMatrix().features;
        }

        function getCurrentPrinciples() {
            return getCurrentMatrix().principles;
        }

        function getContradictionPrinciples(improvingFeature, worseningFeature) {
            const matrix = getCurrentMatrix().matrix;
            if (matrix[improvingFeature] && matrix[improvingFeature][worseningFeature]) {
                return matrix[improvingFeature][worseningFeature];
            }
            return [];
        }

        function getPrincipleName(principleNumber) {
            const principles = getCurrentPrinciples();
            if (principleNumber >= 1 && principleNumber <= principles.length) {
                return principles[principleNumber - 1];
            }
            return "Unknown Principle";
        }

        function getFeatureName(featureNumber) {
            const features = getCurrentFeatures();
            if (featureNumber >= 1 && featureNumber <= features.length) {
                return features[featureNumber - 1];
            }
            return "Unknown Feature";
        }

        // ===== FUNCIONES DE INTERFAZ =====
        function clearResults() {
            const resultsDiv = document.getElementById('results-container');
            if (resultsDiv && !resultsDiv.classList.contains('hidden')) {
                resultsDiv.innerHTML = '';
                resultsDiv.classList.add('hidden');
            }
        }

        function loadExample() {
            clearResults();
            document.getElementById('problem-system').value = '';
            document.getElementById('problem-function').value = '';
            document.getElementById('problem-harm').value = '';
            document.getElementById('ifr-formulation').value = '';
            document.getElementById('conflicting-parameter').value = '';

            // Reset physical contradiction radio buttons (NUEVO ALGORITMO)
            const physicalRadios = document.querySelectorAll('#physical-solver-block input[type="radio"]');
            physicalRadios.forEach(radio => {
                radio.checked = false;
            });

            // Reset physical strategy flow (NUEVO ALGORITMO)
            physicalStrategyFlow = {
                step1: false,
                step2: false,
                selectedIntersection: null,
                selectedSeparation: null,
                strategy: null,
                principles: []
            };

            // Reset physical steps UI (NUEVO ALGORITMO)
            document.getElementById('physical-step-2').classList.add('hidden');

            const currentExample = examples[exampleIndex];

            document.getElementById('problem-system').value = currentExample.system;
            document.getElementById('problem-function').value = currentExample.function;
            document.getElementById('problem-harm').value = currentExample.harm;
            document.getElementById('ifr-formulation').value = currentExample.ifr;

            // Cargar ambos tipos de contradicci칩n
            // Technical Contradiction
            if (currentExample.technicalContradiction) {
                const improvingIndex = currentExample.technicalContradiction.improvingFeature - 1;
                const worseningIndex = currentExample.technicalContradiction.worseningFeature - 1;

                document.getElementById('improving-feature').value = improvingIndex;
                document.getElementById('worsening-feature').value = worseningIndex;

                improvingFeatureIndex = improvingIndex;
                worseningFeatureIndex = worseningIndex;
                updateMatrixDisplay();
                updateSelectedFeatures();
            }

            // Physical Contradiction (NUEVO ALGORITMO)
            if (currentExample.physicalContradiction) {
                document.getElementById('conflicting-parameter').value = currentExample.physicalContradiction.conflictingParameter;

                if (currentExample.physicalContradiction.intersectionTest) {
                    const intersectionRadio = document.querySelector(`input[name="intersection-test"][value="${currentExample.physicalContradiction.intersectionTest}"]`);
                    if (intersectionRadio) {
                        intersectionRadio.checked = true;
                        updatePhysicalStrategy();
                    }
                }

                if (currentExample.physicalContradiction.separationType) {
                    const separationRadio = document.querySelector(`input[name="separation-type"][value="${currentExample.physicalContradiction.separationType}"]`);
                    if (separationRadio) {
                        separationRadio.checked = true;
                        updatePhysicalStrategy();
                    }
                }
            }

            // Load 9 Windows data
            if (currentExample.nineWindows) {
                document.getElementById('nine-windows-super-past').value = currentExample.nineWindows.superPast || '';
                document.getElementById('nine-windows-super-present').value = currentExample.nineWindows.superPresent || '';
                document.getElementById('nine-windows-super-future').value = currentExample.nineWindows.superFuture || '';
                document.getElementById('nine-windows-system-past').value = currentExample.nineWindows.systemPast || '';
                document.getElementById('nine-windows-system-present').value = currentExample.nineWindows.systemPresent || '';
                document.getElementById('nine-windows-system-future').value = currentExample.nineWindows.systemFuture || '';
                document.getElementById('nine-windows-sub-past').value = currentExample.nineWindows.subPast || '';
                document.getElementById('nine-windows-sub-present').value = currentExample.nineWindows.subPresent || '';
                document.getElementById('nine-windows-sub-future').value = currentExample.nineWindows.subFuture || '';
            }

            // Load Function Analysis data
            if (currentExample.functionAnalysis) {
                // Load Function Analysis from the example data
                loadFunctionAnalysisExample(currentExample.functionAnalysis);
            }

            // Load classification data if available
            if (currentExample.classifications) {
                // Store for later use if needed
                problemData.classifications = currentExample.classifications;
            }

            if (currentExample.sufield && currentExample.sufield.systems) {
                document.getElementById('sufield-systems-container').innerHTML = '';
                globalSuFieldCounter = 0; // Reset counter

                // Agregar sistemas con delays escalonados
                currentExample.sufield.systems.forEach((system, index) => {
                    addSuFieldSystem();

                    setTimeout(() => {
                        const systemContainer = document.getElementById('sufield-systems-container').children[index];
                        if (systemContainer) {
                            systemContainer.querySelector('.sufield-object').value = system.object || '';
                            systemContainer.querySelector('.sufield-tool').value = system.tool || '';
                            systemContainer.querySelector('.sufield-field').value = system.field || '';
                            systemContainer.querySelector('.sufield-type').value = system.type || 'insufficient';

                            updateSuFieldDiagram(systemContainer);
                        }
                    }, 50 * (index + 1)); // Delay escalonado para cada sistema
                });
            }

            if (currentExample.lifecycleStage) {
                document.getElementById('lifecycle-stage').value = currentExample.lifecycleStage;
                updateLDSTRecommendations();
            }

            exampleIndex = (exampleIndex + 1) % examples.length;
        }

        // ===== NUEVAS FUNCIONES PARA CONTRADICCI칍N F칈SICA (ALGORITMO NUEVO) =====
        function updatePhysicalStrategy() {
            clearResults();

            // Obtener la selecci칩n del paso 1
            const intersectionTest = document.querySelector('input[name="intersection-test"]:checked');
            const step2Div = document.getElementById('physical-step-2');

            // Resetear el paso 2
            step2Div.classList.add('hidden');

            if (!intersectionTest) {
                physicalStrategyFlow.step1 = false;
                physicalStrategyFlow.step2 = false;
                physicalStrategyFlow.selectedIntersection = null;
                physicalStrategyFlow.selectedSeparation = null;
                physicalStrategyFlow.strategy = null;
                physicalStrategyFlow.principles = [];
                return;
            }

            physicalStrategyFlow.step1 = true;
            physicalStrategyFlow.selectedIntersection = intersectionTest.value;

            // Mostrar el paso 2 solo si hay intersecci칩n total
            if (intersectionTest.value === 'total-intersection') {
                step2Div.classList.remove('hidden');
                const separationType = document.querySelector('input[name="separation-type"]:checked');
                if (separationType) {
                    physicalStrategyFlow.step2 = true;
                    physicalStrategyFlow.selectedSeparation = separationType.value;
                    updatePhysicalStrategyFlow();
                } else {
                    physicalStrategyFlow.step2 = false;
                    physicalStrategyFlow.selectedSeparation = null;
                    physicalStrategyFlow.strategy = null;
                    physicalStrategyFlow.principles = [];
                }
            } else {
                // Para no intersecci칩n o contiguo, determinar la estrategia directamente
                physicalStrategyFlow.step2 = false;
                physicalStrategyFlow.selectedSeparation = null;
                updatePhysicalStrategyFlow();
            }
        }

        function updatePhysicalStrategyFlow() {
            // Determinar la estrategia y los principios basados en el flujo
            let strategy = "";
            let principles = [];

            switch (physicalStrategyFlow.selectedIntersection) {
                case 'no-intersection':
                    strategy = "Separation in Space or Time";
                    principles = [
                        physicalContradictionPrinciples.separationInSpace,
                        physicalContradictionPrinciples.separationInTime
                    ];
                    break;
                case 'contiguous':
                    strategy = "Satisfy through physical-chemical changes";
                    principles = [
                        physicalContradictionPrinciples.satisfyContradictoryDemands
                    ];
                    break;
                case 'total-intersection':
                    if (physicalStrategyFlow.selectedSeparation === 'condition') {
                        strategy = "Separation in Relation (Condition)";
                        principles = [
                            physicalContradictionPrinciples.separationInRelation
                        ];
                    } else if (physicalStrategyFlow.selectedSeparation === 'system-level') {
                        strategy = "Separation in System Level";
                        principles = [
                            physicalContradictionPrinciples.separationInSystemLevel
                        ];
                    } else if (physicalStrategyFlow.selectedSeparation === 'neither') {
                        strategy = "Bypass contradictory demands (System Transition)";
                        principles = [
                            physicalContradictionPrinciples.bypassContradictoryDemands
                        ];
                    } else {
                        // No selection yet
                        physicalStrategyFlow.strategy = null;
                        physicalStrategyFlow.principles = [];
                        return;
                    }
                    break;
                default:
                    physicalStrategyFlow.strategy = null;
                    physicalStrategyFlow.principles = [];
                    return;
            }

            // Update the physicalStrategyFlow object
            physicalStrategyFlow.strategy = strategy;
            physicalStrategyFlow.principles = principles;
        }

        function generatePrinciplesTable() {
            const container = document.getElementById('principles-table-content');

            let html = `
                <p style="margin-bottom: 0.5rem; font-style: italic;">
                    This table shows all physical contradiction resolution strategies and their associated inventive principles.
                </p>
                <p style="margin-bottom: 1.5rem; font-style: italic; font-weight: bold;">
                    Source: 1. Litvin, S. (1993). The TRIZ Contradiction Matrix: Principles for Solving Physical Contradictions. 2. Altshuller, G. S. (1984). Creativity as an Exact Science: The Theory of the Solution of Inventive Problems.
                </p>
            `;

            for (const [method, strategy] of Object.entries(physicalContradictionPrinciples)) {
                // Determinar si esta estrategia es la actualmente seleccionada
                const isCurrentStrategy = physicalStrategyFlow.strategy === strategy.strategy;

                html += `
                    <div class="physical-strategy-guide" style="${isCurrentStrategy ? 'border-left: 5px solid #27ae60; background: linear-gradient(135deg, #e8f5e9, #c8e6c9);' : ''}">
                        <div class="strategy-title">${strategy.strategy}</div>
                        <div class="strategy-description">${strategy.description}</div>
                        <div class="strategy-example">
                            <strong>Example:</strong> ${getPhysicalContradictionExample(method)}
                        </div>
                    </div>
                    <table class="trends-table" style="margin-top: 1rem; margin-bottom: 2rem;">
                        <thead>
                            <tr>
                                <th>Principle #</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                strategy.principles.forEach(principle => {
                    const isCurrentPrinciple = isCurrentStrategy;
                    html += `
                        <tr ${isCurrentPrinciple ? 'class="recommended-trend"' : ''}>
                            <td><strong>${principle.number}</strong></td>
                            <td>${principle.name}</td>
                            <td>${principle.description}</td>
                            <td><em>${principle.example}</em></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;
            }

            container.innerHTML = html;
        }

        function togglePrinciplesTable() {
            const tableContainer = document.getElementById('principles-table-container');
            const isVisible = !tableContainer.classList.contains('hidden');

            if (!isVisible) {
                generatePrinciplesTable();
                tableContainer.classList.remove('hidden');
            } else {
                tableContainer.classList.add('hidden');
            }
        }

        function toggleSolutionsMatrix() {
            const matrixContainer = document.getElementById('solutions-matrix-container');
            const isVisible = !matrixContainer.classList.contains('hidden');

            if (!isVisible) {
                renderSolutionsMatrix();
                matrixContainer.classList.remove('hidden');
            } else {
                matrixContainer.classList.add('hidden');
            }
        }

        function renderSolutionsMatrix() {
            const container = document.getElementById('solutions-matrix-content');

            let html = `
                <div class="content-block">
                    <h4><i class="fas fa-th-list"></i> Classic 76 Standard Solutions Matrix</h4>
                    <p style="margin-bottom: 0.5rem;">This matrix shows all 76 Standard Solutions and their applicability to different Su-Field problem types.</p>
                    <p style="margin-bottom: 1.5rem; font-style: italic; font-weight: bold;">
                        Source: Domb, E., Terninko, J., Miller, J., & MacGran, E. (Classification of the 76 Standard Solutions).
                    </p>
                    <div style="overflow-x: auto;">
                        <table class="matrix-table solutions-matrix">
                            <thead>
                                <tr>
                                    <th>Solution ID</th>
                                    <th>Title</th>
                                    <th>Class</th>
                                    <th>Insufficient</th>
                                    <th>Harmful</th>
                                    <th>Difficult</th>
                                    <th>Missing</th>
                                    <th>Excessive</th>
                                    <th>Inefficient</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            for (const className in trizStandardSolutions) {
                const solutionClass = trizStandardSolutions[className];

                for (const solutionId in solutionClass.solutions) {
                    const solution = solutionClass.solutions[solutionId];

                    const isInsufficient = solutionMap.insufficient.includes(solutionId);
                    const isHarmful = solutionMap.harmful.includes(solutionId);
                    const isDifficult = solutionMap.difficult.includes(solutionId);
                    const isMissing = solutionMap.missing.includes(solutionId);
                    const isExcessive = solutionMap.excessive.includes(solutionId);
                    const isInefficient = solutionMap.inefficient.includes(solutionId);

                    html += `
                            <tr>
                                <td><strong>${solutionId}</strong></td>
                                <td>${solution.title}</td>
                                <td>${className.split(':')[0]}</td>
                                <td class="${isInsufficient ? 'matrix-applicable' : ''}">${isInsufficient ? '九' : ''}</td>
                                <td class="${isHarmful ? 'matrix-applicable' : ''}">${isHarmful ? '九' : ''}</td>
                                <td class="${isDifficult ? 'matrix-applicable' : ''}">${isDifficult ? '九' : ''}</td>
                                <td class="${isMissing ? 'matrix-applicable' : ''}">${isMissing ? '九' : ''}</td>
                                <td class="${isExcessive ? 'matrix-applicable' : ''}">${isExcessive ? '九' : ''}</td>
                                <td class="${isInefficient ? 'matrix-applicable' : ''}">${isInefficient ? '九' : ''}</td>
                            </tr>
                        `;
                }
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    </div>
            `;

            container.innerHTML = html;
        }

        function toggleMatrixView() {
            const dropdownView = document.getElementById('dropdown-view');
            const matrixView = document.getElementById('matrix-view');

            if (matrixView.classList.contains('hidden')) {
                dropdownView.classList.add('hidden');
                matrixView.classList.remove('hidden');
            } else {
                dropdownView.classList.remove('hidden');
                matrixView.classList.add('hidden');
            }
        }

        function createContradictionMatrix() {
            const matrixTable = document.getElementById('contradiction-matrix');
            matrixTable.innerHTML = '';

            const features = getCurrentFeatures();

            let headerRow = '<tr><th class="matrix-corner">Worsening <br>Desired </th>';
            for (let i = 0; i < features.length; i++) {
                headerRow += `<th title="${features[i]}">${features[i].split(':')[0]}</th>`;
            }
            headerRow += '</tr>';
            matrixTable.innerHTML += headerRow;

            for (let i = 0; i < features.length; i++) {
                let row = `<tr><th title="${features[i]}">${i + 1}</th>`;
                for (let j = 0; j < features.length; j++) {
                    const cellClass = getCellClass(i, j);
                    const principles = getContradictionPrinciples((i + 1).toString(), (j + 1).toString());
                    const principleNumbers = principles && principles.length > 0 ? principles.join(', ') : '-';

                    const principleNames = principles && principles.length > 0
                        ? principles.map(p => getPrincipleName(p)).join(', ')
                        : 'No principles recommended';

                    row += `<td class="${cellClass}" onclick="selectMatrixCell(${i}, ${j})" 
                        title="Improving: ${features[i]}\nWorsening: ${features[j]}\nPrinciples: ${principleNames}">
                    <div class="principle-numbers">${principleNumbers}</div>
                </td>`;
                }
                row += '</tr>';
                matrixTable.innerHTML += row;
            }
        }

        function getCellClass(row, col) {
            if (row === improvingFeatureIndex && col === worseningFeatureIndex) {
                return 'selected';
            } else if (row === improvingFeatureIndex) {
                return 'improving';
            } else if (col === worseningFeatureIndex) {
                return 'worsening';
            }
            return '';
        }

        function selectMatrixCell(row, col) {
            clearResults();
            improvingFeatureIndex = row;
            worseningFeatureIndex = col;

            document.getElementById('improving-feature').value = row;
            document.getElementById('worsening-feature').value = col;

            updateMatrixDisplay();
            updateSelectedFeatures();
        }

        function updateMatrixDisplay() {
            const cells = document.querySelectorAll('#contradiction-matrix td');
            const features = getCurrentFeatures();
            cells.forEach((cell, index) => {
                const row = Math.floor(index / features.length);
                const col = index % features.length;
                cell.className = getCellClass(row, col);
            });
        }

        function populateDropdowns() {
            const improvingSelect = document.getElementById('improving-feature');
            const worseningSelect = document.getElementById('worsening-feature');

            improvingSelect.innerHTML = '<option value="-1">Select a feature</option>';
            worseningSelect.innerHTML = '<option value="-1">Select a feature</option>';

            const features = getCurrentFeatures();

            features.forEach((param, index) => {
                improvingSelect.innerHTML += `<option value="${index}" title="${param}">${param}</option>`;
                worseningSelect.innerHTML += `<option value="${index}" title="${param}">${param}</option>`;
            });

            improvingFeatureIndex = null;
            worseningFeatureIndex = null;
        }

        function updateSelectedFeatures() {
            const features = getCurrentFeatures();
            const improvingSpan = document.getElementById('selected-improving');
            const worseningSpan = document.getElementById('selected-worsening');

            if (improvingFeatureIndex !== null) {
                improvingSpan.textContent = features[improvingFeatureIndex];
                improvingSpan.title = features[improvingFeatureIndex];
            } else {
                improvingSpan.textContent = 'None';
            }

            if (worseningFeatureIndex !== null) {
                worseningSpan.textContent = features[worseningFeatureIndex];
                worseningSpan.title = features[worseningFeatureIndex];
            } else {
                worseningSpan.textContent = 'None';
            }
        }

        // ===== FUNCIONES DE SU-FIELD =====
        function addSuFieldSystem() {
            const container = document.getElementById('sufield-systems-container');
            // Use global counter to ensure unique IDs, avoiding the 'null' error on element removal
            globalSuFieldCounter++;
            const systemId = globalSuFieldCounter;

            // Note: The UI label will be sequential based on current DOM elements
            const uiLabelIndex = container.children.length + 1;

            const systemHTML = `
                <div class="sufield-system">
                    <div class="sufield-system-header">
                        <div class="sufield-system-title">System ${uiLabelIndex}</div>
                        <button type="button" class="btn-warning" onclick="removeSuFieldSystem(this)" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <div class="sufield-system-fields">
                        <div class="form-group">
                            <label for="sufield-object-${systemId}">Object (S1):</label>
                            <input type="text" class="sufield-object" id="sufield-object-${systemId}" placeholder="e.g., Coffee" oninput="updateSuFieldDiagram(this.closest('.sufield-system'))">
                        </div>
                        <div class="form-group">
                            <label for="sufield-tool-${systemId}">Tool (S2):</label>
                            <input type="text" class="sufield-tool" id="sufield-tool-${systemId}" placeholder="e.g., Cup" oninput="updateSuFieldDiagram(this.closest('.sufield-system'))">
                        </div>
                        <div class="form-group">
                            <label for="sufield-field-${systemId}">Field (F):</label>
                            <input type="text" class="sufield-field" id="sufield-field-${systemId}" placeholder="e.g., Thermal energy" oninput="updateSuFieldDiagram(this.closest('.sufield-system'))">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sufield-type-${systemId}">Problem Type:</label>
                        <select class="sufield-type" id="sufield-type-${systemId}" onchange="updateSuFieldDiagram(this.closest('.sufield-system'))">
                            <option value="insufficient">Insufficient interaction</option>
                            <option value="harmful">Harmful interaction</option>
                            <option value="difficult">Difficult to control</option>
                            <option value="missing">Missing interaction</option>
                            <option value="excessive">Excessive interaction</option>
                            <option value="inefficient">Inefficient interaction</option>
                        </select>
                    </div>
                    <div class="sufield-triangle-container sufield-system-diagram" id="sufield-diagram-${systemId}">
                        </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', systemHTML);

            // Usar setTimeout para asegurar que el DOM est칠 completamente renderizado
            setTimeout(() => {
                const newSystem = container.lastElementChild;
                if (newSystem) {
                    updateSuFieldDiagram(newSystem);
                }
            }, 50);
        }

        function removeSuFieldSystem(button) {
            const system = button.closest('.sufield-system');
            if (system && document.querySelectorAll('.sufield-system').length > 1) {
                system.remove();
                // Renumber remaining systems UI labels only
                const systems = document.querySelectorAll('.sufield-system');
                systems.forEach((sys, index) => {
                    sys.querySelector('.sufield-system-title').textContent = `System ${index + 1}`;
                });
            }
        }

        // ===== NUEVAS FUNCIONES PARA FUNCTION ANALYSIS =====

        // Variables para Function Analysis
        let functionAnalysisData = {
            mainFunction: '',
            targetComponent: '',
            systemComponents: [],
            supersystemComponents: [],
            interactions: {},
            functions: []
        };

        // Inicializar Function Analysis
        function initFunctionAnalysis() {
            updateFunctionAnalysis();
        }

        // Reset Function Analysis
        function resetFunctionAnalysis() {
            functionAnalysisData = {
                mainFunction: '',
                targetComponent: '',
                systemComponents: [],
                supersystemComponents: [],
                interactions: {},
                functions: []
            };

            document.getElementById('main-function').value = '';
            document.getElementById('target-component').value = '';
            document.getElementById('system-component-input').value = '';
            document.getElementById('supersystem-component-input').value = '';
            document.getElementById('function-table-body').innerHTML = '';

            updateFunctionAnalysis();
        }

        // Actualizar datos de Function Analysis
        function updateFunctionAnalysis() {
            // Actualizar main function y target component
            functionAnalysisData.mainFunction = document.getElementById('main-function').value;
            functionAnalysisData.targetComponent = document.getElementById('target-component').value;

            // Actualizar displays
            document.getElementById('target-component-display').textContent =
                functionAnalysisData.targetComponent || 'Not defined';
            document.getElementById('main-function-display').textContent =
                functionAnalysisData.mainFunction || 'Not defined';

            // Actualizar matriz de interacciones
            updateInteractionMatrix();

            // Actualizar diagrama
            updateFunctionDiagram();
        }

        // A침adir componente del sistema
        function addSystemComponent() {
            const input = document.getElementById('system-component-input');
            const component = input.value.trim();

            if (component && !functionAnalysisData.systemComponents.includes(component)) {
                functionAnalysisData.systemComponents.push(component);
                updateComponentLists();
                input.value = '';
                updateInteractionMatrix();
                updateFunctionDiagram();
            }
        }

        // A침adir componente del supersistema
        function addSupersystemComponent() {
            const input = document.getElementById('supersystem-component-input');
            const component = input.value.trim();

            if (component && !functionAnalysisData.supersystemComponents.includes(component)) {
                functionAnalysisData.supersystemComponents.push(component);
                updateComponentLists();
                input.value = '';
                updateInteractionMatrix();
                updateFunctionDiagram();
            }
        }

        // Eliminar componente del sistema
        function removeSystemComponent(component) {
            functionAnalysisData.systemComponents = functionAnalysisData.systemComponents.filter(c => c !== component);
            updateComponentLists();
            updateInteractionMatrix();
            updateFunctionDiagram();
        }

        // Eliminar componente del supersistema
        function removeSupersystemComponent(component) {
            functionAnalysisData.supersystemComponents = functionAnalysisData.supersystemComponents.filter(c => c !== component);
            updateComponentLists();
            updateInteractionMatrix();
            updateFunctionDiagram();
        }

        // Actualizar listas de componentes en la UI
        function updateComponentLists() {
            // Actualizar lista de componentes del sistema
            const systemList = document.getElementById('system-components-list');
            systemList.innerHTML = '';

            functionAnalysisData.systemComponents.forEach(component => {
                const div = document.createElement('div');
                div.className = 'item-entry';
                div.innerHTML = `
                    <span>${component}</span>
                    <button class="btn-warning" onclick="removeSystemComponent('${component}')" style="padding: 2px 5px; font-size: 0.8em;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                systemList.appendChild(div);
            });

            // Actualizar lista de componentes del supersistema
            const supersystemList = document.getElementById('supersystem-components-list');
            supersystemList.innerHTML = '';

            functionAnalysisData.supersystemComponents.forEach(component => {
                const div = document.createElement('div');
                div.className = 'item-entry';
                div.innerHTML = `
                    <span>${component}</span>
                    <button class="btn-warning" onclick="removeSupersystemComponent('${component}')" style="padding: 2px 5px; font-size: 0.8em;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                supersystemList.appendChild(div);
            });
        }

        // CORRECCI칍N DEL HOVER: Actualizar matriz de interacciones con hover que no permanece
        function updateInteractionMatrix() {
            const container = document.getElementById('interaction-matrix-container');

            // Combinar todos los componentes (target est치 en supersistema)
            const allComponents = [
                ...functionAnalysisData.systemComponents,
                ...functionAnalysisData.supersystemComponents,
                functionAnalysisData.targetComponent
            ].filter(c => c); // Filtrar componentes vac칤os

            if (allComponents.length < 2) {
                container.innerHTML = '<p><em>Define at least 2 components in Step 2 to see the interaction matrix.</em></p>';
                return;
            }

            // Crear tabla de interacciones con encabezados de color azul oscuro
            let html = `
                <table class="interaction-matrix" style="font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th>Components</th>
            `;

            // Encabezados de columnas con fondo azul oscuro
            allComponents.forEach(component => {
                html += `<th>${component}</th>`;
            });

            html += `</tr></thead><tbody>`;

            // Filas de la matriz
            allComponents.forEach(rowComponent => {
                html += `<tr><th>${rowComponent}</th>`;

                allComponents.forEach(colComponent => {
                    if (rowComponent === colComponent) {
                        html += `<td style="background: #f0f0f0; text-align: center;">-</td>`;
                    } else {
                        const interactionId = `${rowComponent}-${colComponent}`;
                        const reverseInteractionId = `${colComponent}-${rowComponent}`;
                        const isChecked = functionAnalysisData.interactions[interactionId] ||
                            functionAnalysisData.interactions[reverseInteractionId] || false;

                        html += `
                            <td style="text-align: center;">
                                <input type="checkbox" id="${interactionId}" 
                                       ${isChecked ? 'checked' : ''}
                                       onchange="toggleInteraction('${rowComponent}', '${colComponent}')"
                                       class="interaction-checkbox">
                            </td>
                        `;
                    }
                });

                html += `</tr>`;
            });

            html += `</tbody></table>`;
            html += `<p style="margin-top: 10px; font-style: italic;">Check boxes where components are in contact or touch each other.</p>`;

            container.innerHTML = html;

            // CORRECCI칍N DEL HOVER: Event listeners mejorados
            const table = container.querySelector('.interaction-matrix');
            if (table) {
                let currentRow = null;
                let currentCol = null;

                const clearHighlights = () => {
                    if (currentRow) {
                        currentRow.classList.remove('highlight-row');
                        currentRow = null;
                    }
                    if (currentCol) {
                        currentCol.forEach(cell => cell.classList.remove('highlight-col'));
                        currentCol = null;
                    }
                };

                const cells = table.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.addEventListener('mouseenter', function () {
                        clearHighlights();

                        const row = this.parentNode;
                        const cellIndex = Array.from(row.children).indexOf(this);

                        // Resaltar toda la fila
                        row.classList.add('highlight-row');
                        currentRow = row;

                        // Resaltar toda la columna
                        const colCells = [];
                        const allRows = table.querySelectorAll('tr');
                        allRows.forEach(r => {
                            if (r.children[cellIndex]) {
                                r.children[cellIndex].classList.add('highlight-col');
                                colCells.push(r.children[cellIndex]);
                            }
                        });
                        currentCol = colCells;
                    });

                    cell.addEventListener('mouseleave', clearHighlights);
                });
            }
        }

        // Alternar interacci칩n entre componentes
        function toggleInteraction(component1, component2) {
            const interactionId = `${component1}-${component2}`;
            const reverseInteractionId = `${component2}-${component1}`;
            const checkbox = document.getElementById(interactionId);

            if (checkbox) {
                functionAnalysisData.interactions[interactionId] = checkbox.checked;
                functionAnalysisData.interactions[reverseInteractionId] = checkbox.checked;

                // Tambi칠n actualizar el checkbox inverso si existe
                const reverseCheckbox = document.getElementById(reverseInteractionId);
                if (reverseCheckbox && reverseCheckbox.checked !== checkbox.checked) {
                    reverseCheckbox.checked = checkbox.checked;
                }

                updateFunctionDiagram();
            }
        }

        // A침adir fila a la tabla de funciones
        function addFunctionRow() {
            const tableBody = document.getElementById('function-table-body');

            // Obtener todos los componentes disponibles
            const allComponents = [
                ...functionAnalysisData.systemComponents,
                ...functionAnalysisData.supersystemComponents,
                functionAnalysisData.targetComponent
            ].filter(c => c);

            if (allComponents.length === 0) {
                alert('Please define components in Step 2 first.');
                return;
            }

            // Crear opciones para los selectores de componentes
            const componentOptions = allComponents.map(c => `<option value="${c}">${c}</option>`).join('');

            const rowId = 'function-row-' + Date.now();
            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td>
                    <select class="function-carrier" style="width: 100%;">
                        <option value="">Select...</option>
                        ${componentOptions}
                    </select>
                </td>
                <td><input type="text" class="function-action" placeholder="e.g., holds, heats" style="width: 100%;"></td>
                <td>
                    <select class="function-target" style="width: 100%;">
                        <option value="">Select...</option>
                        ${componentOptions}
                    </select>
                </td>
                <td>
                    <select class="function-category" style="width: 100%;">
                        <option value="U">Useful (U)</option>
                        <option value="H">Harmful (H)</option>
                    </select>
                </td>
                <td>
                    <select class="function-performance" style="width: 100%;">
                        <option value="N">Normal (N)</option>
                        <option value="I">Insufficient (I)</option>
                        <option value="E">Excessive (E)</option>
                    </select>
                </td>
                <td><input type="text" class="function-comment" placeholder="Optional comment" style="width: 100%;"></td>
                <td>
                    <button class="btn-warning" onclick="removeFunctionRow('${rowId}')" style="padding: 2px 5px; font-size: 0.8em;">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            tableBody.appendChild(row);

            // A침adir evento para actualizar el diagrama cuando se modifique la fila
            row.querySelectorAll('select, input').forEach(element => {
                element.addEventListener('change', updateFunctionDiagram);
                element.addEventListener('input', updateFunctionDiagram);
            });

            updateFunctionDiagram();
        }

        // Eliminar fila de funci칩n
        function removeFunctionRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateFunctionDiagram();
            }
        }

        // Actualizar diagrama de funciones
        function updateFunctionDiagram() {
            // Recopilar todas las funciones de la tabla
            const functionRows = document.querySelectorAll('#function-table-body tr');
            functionAnalysisData.functions = [];

            functionRows.forEach(row => {
                const carrier = row.querySelector('.function-carrier')?.value;
                const action = row.querySelector('.function-action')?.value;
                const target = row.querySelector('.function-target')?.value;
                const category = row.querySelector('.function-category')?.value;
                const performance = row.querySelector('.function-performance')?.value;
                const comment = row.querySelector('.function-comment')?.value;

                if (carrier && action && target) {
                    functionAnalysisData.functions.push({
                        carrier,
                        action,
                        target,
                        category: category === 'U' ? 'useful' : 'harmful',
                        performance: performance === 'N' ? 'normal' : (performance === 'I' ? 'insufficient' : 'excessive'),
                        comment
                    });
                }
            });

            // Generar c칩digo Mermaid
            const code = generateFunctionDiagramCode(functionAnalysisData.functions);
            const container = document.getElementById('faMermaidPreview');

            // Limpiar y renderizar nuevo diagrama
            container.innerHTML = `<div class="mermaid">${code}</div>`;

            // Re-inicializar Mermaid
            if (typeof mermaid !== 'undefined') {
                try {
                    if (window.mermaidTimeout) {
                        clearTimeout(window.mermaidTimeout);
                    }

                    window.mermaidTimeout = setTimeout(() => {
                        mermaid.init({
                            startOnLoad: false,
                            theme: 'default',
                            securityLevel: 'loose',
                            flowchart: {
                                useMaxWidth: true,
                                htmlLabels: true,
                                curve: 'basis'
                            }
                        }, container.querySelectorAll('.mermaid'));
                    }, 100);
                } catch (error) {
                    console.error('Mermaid rendering error:', error);
                    container.innerHTML = `
                        <div style="color: #666; padding: 20px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                            <p><i class="fas fa-project-diagram" style="font-size: 2rem; margin-bottom: 10px;"></i></p>
                            <p><strong>Function Analysis Diagram</strong></p>
                            <p>Add functions to the table to see the diagram</p>
                        </div>
                    `;
                }
            }
        }

        // Generar c칩digo Mermaid para el diagrama de funciones
        function generateFunctionDiagramCode(functions) {
            if (functions.length === 0) {
                return 'graph LR;\n    A[Define Functions] --> B[Diagram will appear here]';
            }

            let lines = [];

            // Definir estilos para nodos
            lines.push('    classDef system fill:#dceeff,stroke:#82b6ff,stroke-width:2px;');
            lines.push('    classDef supersystem fill:#ffe6cc,stroke:#d79b00,stroke-width:2px;');
            lines.push('    classDef target fill:#ffffcc,stroke:#d6b656,stroke-width:2px;');

            // Identificar todos los componentes 칰nicos
            const allComponents = new Set();
            functions.forEach(func => {
                allComponents.add(func.carrier);
                allComponents.add(func.target);
            });

            // Determinar tipo de cada componente
            const componentTypes = {};
            Array.from(allComponents).forEach(component => {
                if (component === functionAnalysisData.targetComponent) {
                    componentTypes[component] = 'target';
                } else if (functionAnalysisData.systemComponents.includes(component)) {
                    componentTypes[component] = 'system';
                } else {
                    componentTypes[component] = 'supersystem';
                }
            });

            // Crear nodos con formas apropiadas
            Object.entries(componentTypes).forEach(([component, type]) => {
                let shapeStart = '[';
                let shapeEnd = ']';
                let className = 'system';

                if (type === 'supersystem') {
                    shapeStart = '{{';
                    shapeEnd = '}}';
                    className = 'supersystem';
                } else if (type === 'target') {
                    shapeStart = '([';
                    shapeEnd = '])';
                    className = 'target';
                }

                const nodeId = component.replace(/[^a-zA-Z0-9]/g, '_');
                lines.push(`    ${nodeId}${shapeStart}"${component}"${shapeEnd}:::${className}`);
            });

            // Crear aristas (conexiones) con estilos basados en propiedades
            functions.forEach((func, index) => {
                const carrierId = func.carrier.replace(/[^a-zA-Z0-9]/g, '_');
                const targetId = func.target.replace(/[^a-zA-Z0-9]/g, '_');

                let arrow = '-->';
                let linkStyle = '';

                // Determinar estilo de flecha basado en categor칤a y rendimiento
                if (func.category === 'useful') {
                    if (func.performance === 'insufficient') {
                        arrow = '-.->';
                        linkStyle = `linkStyle ${index} stroke-dasharray: 5,5;`;
                    } else if (func.performance === 'excessive') {
                        arrow = '==>';
                        linkStyle = `linkStyle ${index} stroke-width:3px;`;
                    } else {
                        arrow = '-->';
                    }
                } else if (func.category === 'harmful') {
                    arrow = '==>';
                    linkStyle = `linkStyle ${index} stroke:#e74c3c,stroke-width:3px;`;
                }

                // A침adir la arista
                lines.push(`    ${carrierId} ${arrow}|${func.action}| ${targetId}`);

                // A침adir estilo de enlace si est치 especificado
                if (linkStyle) {
                    lines.push(`    ${linkStyle}`);
                }
            });

            return 'graph LR\n' + lines.join('\n');
        }

        // Cargar ejemplo en Function Analysis
        function loadFunctionAnalysisExample(exampleData) {
            // Limpiar tabla de funciones
            document.getElementById('function-table-body').innerHTML = '';

            // Resetear datos de Function Analysis
            functionAnalysisData = {
                mainFunction: '',
                targetComponent: '',
                systemComponents: [],
                supersystemComponents: [],
                interactions: {},
                functions: []
            };

            if (exampleData) {
                // Si se proporciona exampleData, usarlo
                document.getElementById('main-function').value = exampleData.mainFunction || '';
                document.getElementById('target-component').value = exampleData.targetComponent || '';

                // FILTRAR: Eliminar el targetComponent de las listas de componentes
                const targetComponent = exampleData.targetComponent || '';

                functionAnalysisData.systemComponents = (exampleData.systemComponents || [])
                    .filter(component => component !== targetComponent);

                functionAnalysisData.supersystemComponents = (exampleData.supersystemComponents || [])
                    .filter(component => component !== targetComponent);

                functionAnalysisData.interactions = exampleData.interactions || {};
                functionAnalysisData.functions = exampleData.functions || [];

                // Actualizar listas de componentes
                updateComponentLists();
                updateFunctionAnalysis();

                // Cargar funciones en la tabla
                if (exampleData.functions && exampleData.functions.length > 0) {
                    setTimeout(() => {
                        exampleData.functions.forEach(func => {
                            addFunctionRow();
                            const rows = document.querySelectorAll('#function-table-body tr');
                            const lastRow = rows[rows.length - 1];

                            if (lastRow) {
                                lastRow.querySelector('.function-carrier').value = func.carrier;
                                lastRow.querySelector('.function-action').value = func.action;
                                lastRow.querySelector('.function-target').value = func.target;
                                lastRow.querySelector('.function-category').value = func.category === 'useful' ? 'U' : 'H';
                                lastRow.querySelector('.function-performance').value =
                                    func.performance === 'normal' ? 'N' :
                                        (func.performance === 'insufficient' ? 'I' : 'E');
                                lastRow.querySelector('.function-comment').value = func.comment || '';
                            }
                        });
                        updateFunctionDiagram();
                    }, 100);
                }
            } else {
                // Ejemplo por defecto: Sistema de taza de caf칠
                // ... (c칩digo existente) ...
            }
        }

        // ===== FUNCIONES DE SOLUCI칍N =====
        function solveProblem() {
            clearResults();
            console.log("Generating report...");

            problemData = {};
            problemData.system = document.getElementById('problem-system').value || "Not specified";
            problemData.function = document.getElementById('problem-function').value || "Not specified";
            problemData.harm = document.getElementById('problem-harm').value || "Not specified";
            problemData.ifr = document.getElementById('ifr-formulation').value || "Not specified";

            // LDST data
            const lifecycleStage = document.getElementById('lifecycle-stage').value;
            const recommendedLaws = lifecycleToLdstMapping[lifecycleStage] || ["law4"];

            problemData.ldst = {
                lifecycleStage: lifecycleStage,
                recommendedLaws: recommendedLaws.map(lawId => {
                    const law = getLdstData(lawId);
                    return {
                        id: lawId,
                        name: law.name,
                        principles: law.principles,
                        examples: law.examples
                    };
                })
            };

            // 9 Windows data
            problemData.nineWindows = {
                superPast: document.getElementById('nine-windows-super-past').value,
                superPresent: document.getElementById('nine-windows-super-present').value,
                superFuture: document.getElementById('nine-windows-super-future').value,
                systemPast: document.getElementById('nine-windows-system-past').value,
                systemPresent: document.getElementById('nine-windows-system-present').value,
                systemFuture: document.getElementById('nine-windows-system-future').value,
                subPast: document.getElementById('nine-windows-sub-past').value,
                subPresent: document.getElementById('nine-windows-sub-present').value,
                subFuture: document.getElementById('nine-windows-sub-future').value
            };

            // Function Analysis data
            problemData.functionAnalysis = {
                mainFunction: functionAnalysisData.mainFunction,
                targetComponent: functionAnalysisData.targetComponent,
                systemComponents: functionAnalysisData.systemComponents,
                supersystemComponents: functionAnalysisData.supersystemComponents,
                interactions: functionAnalysisData.interactions,
                functions: functionAnalysisData.functions
            };

            // Technical Contradiction data
            let improvingIndex = parseInt(document.getElementById('improving-feature').value);
            let worseningIndex = parseInt(document.getElementById('worsening-feature').value);

            if (isNaN(improvingIndex) || improvingIndex < 0) improvingIndex = improvingFeatureIndex;
            if (isNaN(worseningIndex) || worseningIndex < 0) worseningIndex = worseningFeatureIndex;

            problemData.technicalContradiction = {
                improvingFeature: "Not selected",
                worseningFeature: "Not selected",
                recommendedPrinciples: []
            };

            if (improvingIndex !== null && worseningIndex !== null && improvingIndex >= 0 && worseningIndex >= 0) {
                improvingFeatureIndex = improvingIndex;
                worseningFeatureIndex = worseningIndex;

                const features = getCurrentFeatures();
                problemData.technicalContradiction.improvingFeature = features[improvingIndex];
                problemData.technicalContradiction.worseningFeature = features[worseningIndex];

                const improvingKey = (improvingIndex + 1).toString();
                const worseningKey = (worseningIndex + 1).toString();
                const principlesList = getContradictionPrinciples(improvingKey, worseningKey);

                problemData.technicalContradiction.recommendedPrinciples = (principlesList || []).map(id => {
                    return principles[id] ? { ...principles[id], id } : null;
                }).filter(p => p !== null);
            }

            // Physical Contradiction data (NUEVO ALGORITMO)
            const parameter = document.getElementById('conflicting-parameter').value;
            problemData.physicalContradiction = {
                conflictingParameter: parameter || "Not specified",
                intersectionTest: physicalStrategyFlow.selectedIntersection,
                separationType: physicalStrategyFlow.selectedSeparation,
                strategy: physicalStrategyFlow.strategy,
                recommendedPrinciples: []
            };

            if (physicalStrategyFlow.strategy && physicalStrategyFlow.principles) {
                // Collect all principles from the strategy groups
                physicalStrategyFlow.principles.forEach(principleGroup => {
                    principleGroup.principles.forEach(principle => {
                        problemData.physicalContradiction.recommendedPrinciples.push({
                            id: principle.number,
                            name: principle.name,
                            desc: principle.description,
                            example: principle.example
                        });
                    });
                });
            }

            // Collect Su-Field systems - CON LA CORRECCI칍N PARA VALORES POR DEFECTO
            problemData.sufield = { systems: [] };
            const systemElements = document.getElementsByClassName('sufield-system');

            if (systemElements.length > 0) {
                for (let systemElement of systemElements) {
                    const object = systemElement.querySelector('.sufield-object').value;
                    const tool = systemElement.querySelector('.sufield-tool').value;
                    const field = systemElement.querySelector('.sufield-field').value;
                    const type = systemElement.querySelector('.sufield-type').value;

                    const standardSolutions = (typeof getRecommendedStandardSolutions === 'function')
                        ? getRecommendedStandardSolutions(type)
                        : [];

                    problemData.sufield.systems.push({
                        object: object || 'S1',  // VALOR POR DEFECTO
                        tool: tool || 'S2',      // VALOR POR DEFECTO
                        field: field || 'Field', // VALOR POR DEFECTO
                        type: type || 'insufficient', // VALOR POR DEFECTO
                        suggestion: sufieldSolutions[type] || "No specific suggestion available.",
                        standardSolutions: standardSolutions
                    });
                }
            }

            displayResults();
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results-container');
            let html = '<h3><i class="fas fa-check-circle"></i> Solution Path Report</h3>';

            // PROBLEM DEFINITION (New Section)
            html += `<div class="solver-step">
                <h4><i class="fas fa-tasks"></i> Problem Definition</h4>
                <p><strong>System:</strong> ${problemData.system}</p>
                <p><strong>Primary Function:</strong> ${problemData.function}</p>
                <p><strong>Main Drawback:</strong> ${problemData.harm}</p>
            </div>`;

            // IDEAL FINAL RESULT (New Section)
            html += `<div class="solver-step">
                <h4><i class="fas fa-rocket"></i> Ideal Final Result (IFR)</h4>
                <p><strong>Formulation:</strong> ${problemData.ifr}</p>
            </div>`;

            // LDST Analysis
            html += `<div class="solver-step"><h4><i class="fas fa-project-diagram"></i> LDST Analysis</h4>
                <p><strong>Life Cycle Stage:</strong> ${document.getElementById('lifecycle-stage').options[document.getElementById('lifecycle-stage').selectedIndex].text}</p>
                <p><strong>Recommended Laws of Technical Systems Development:</strong></p>`;

            problemData.ldst.recommendedLaws.forEach(law => {
                html += `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <h5>${law.name}</h5>
                        <p><strong>Related Principles:</strong> ${law.principles.join(', ')}</p>
                        <div>${law.examples}</div>
                    </div>
                `;
            });

            html += `
                <div class="tese-trends-icons">`;

            problemData.ldst.recommendedLaws.forEach(law => {
                law.principles.forEach(principle => {
                    html += `
                        <div class="tese-trend-item">
                            <div class="tese-trend-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div class="tese-trend-name">${principle}</div>
                        </div>
                    `;
                });
            });

            html += `</div>
                <p style="margin-top: 1rem; font-style: italic; text-align: center;">
                    Apply these principles according to the fundamental laws of technical systems development
                </p>
            </div>`;

            // 9 Windows Analysis
            html += `<div class="solver-step"><h4><i class="fas fa-window-restore"></i> 9 Windows Analysis</h4>
                <div class="nine-windows-container" style="margin-top: 20px;">
                    <table class="nine-windows-table" style="border-collapse: collapse; width: 100%;">
                        <tr>
                            <td style="width: 80px; border: none;"></td>
                            <td style="text-align: center; font-weight: bold; padding: 10px; background: #f0f7ff;">Past</td>
                            <td style="text-align: center; font-weight: bold; padding: 10px; background: #f0f7ff;">Present</td>
                            <td style="text-align: center; font-weight: bold; padding: 10px; background: #f0f7ff;">Future</td>
                        </tr>
                        <tr>
                            <td style="text-align: right; font-weight: bold; padding: 10px; background: #fff0f0; vertical-align: middle;">
                                Super-System
                            </td>
                            <td style="padding: 5px; background: #f0f7ff;">
                                <div style="padding: 10px; min-height: 80px; border: 1px solid #a0c8ff; border-radius: 4px;">
                                    ${problemData.nineWindows.superPast || 'Not specified'}
                                </div>
                            </td>
                            <td style="padding: 5px; background: #f0f7ff;">
                                <div style="padding: 10px; min-height: 80px; border: 1px solid #a0c8ff; border-radius: 4px;">
                                    ${problemData.nineWindows.superPresent || 'Not specified'}
                                </div>
                            </td>
                            <td style="padding: 5px; background: #f0f7ff;">
                                <div style="padding: 10px; min-height: 80px; border: 1px solid #a0c8ff; border-radius: 4px;">
                                    ${problemData.nineWindows.superFuture || 'Not specified'}
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align: right; font-weight: bold; padding: 10px; background: #f0fff0; vertical-align: middle;">
                                System
                            </td>
                            <td style="padding: 5px; background: #f0fff0;">
                                <div style="padding: 10px; min-height: 80px; border: 1px solid #a0d0a0; border-radius: 4px;">
                                    ${problemData.nineWindows.systemPast || 'Not specified'}
                                </div>
                            </td>
                            <td style="padding: 5px; background: #f0fff0;">
                                <div style="padding: 10px; min-height: 80px; border: 1px solid #a0d0a0; border-radius: 4px;">
                                    ${problemData.nineWindows.systemPresent || 'Not specified'}
                                </div>
                            </td>
                            <td style="padding: 5px; background: #f0fff0;">
                                <div style="padding: 10px; min-height: 80px; border: 1px solid #a0d0a0; border-radius: 4px;">
                                    ${problemData.nineWindows.systemFuture || 'Not specified'}
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align: right; font-weight: bold; padding: 10px; background: #fff0f0; vertical-align: middle;">
                                Sub-System
                            </td>
                            <td style="padding: 5px; background: #fff0f0;">
                                <div style="padding: 10px; min-height: 80px; border: 1px solid #ffa0a0; border-radius: 4px;">
                                    ${problemData.nineWindows.subPast || 'Not specified'}
                                </div>
                            </td>
                            <td style="padding: 5px; background: #fff0f0;">
                                <div style="padding: 10px; min-height: 80px; border: 1px solid #ffa0a0; border-radius: 4px;">
                                    ${problemData.nineWindows.subPresent || 'Not specified'}
                                </div>
                            </td>
                            <td style="padding: 5px; background: #fff0f0;">
                                <div style="padding: 10px; min-height: 80px; border: 1px solid #ffa0a0; border-radius: 4px;">
                                    ${problemData.nineWindows.subFuture || 'Not specified'}
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="margin-top: 20px; font-size: 0.9rem; color: #666; text-align: center;">
                        <strong>Color Guide:</strong> 
                        <span style="color: #0066cc;">Super-System (Blue)</span> | 
                        <span style="color: #009900;">System (Green)</span> | 
                        <span style="color: #cc0000;">Sub-System (Red)</span>
                    </div>
                </div>
                <p style="margin-top: 15px; font-style: italic; text-align: center;">
                    Use this 9-windows analysis to identify innovation opportunities in different timeframes and system levels.
                </p>
            </div>`;

            // Function Analysis
            if (problemData.functionAnalysis) {
                html += `<div class="solver-step"><h4><i class="fas fa-project-diagram"></i> Function Analysis</h4>`;

                // Step 1: Main Function
                html += `<div class="calculation-block" style="margin-bottom: 1rem;">
                    <h5>Step 1: Main Function</h5>
                    <p><strong>Main Function:</strong> ${problemData.functionAnalysis.mainFunction || 'Not defined'}</p>
                    <p><strong>Target Component:</strong> ${problemData.functionAnalysis.targetComponent || 'Not defined'}</p>
                </div>`;

                // Step 2: Component Analysis
                html += `<div class="calculation-block" style="margin-bottom: 1rem;">
                    <h5>Step 2: Component Analysis</h5>
                    <div class="panels-container" style="display: flex; flex-wrap: wrap; gap: 1.25rem;">
                        <div class="panel-half" style="flex: 1; min-width: 300px;">
                            <h6>System Components:</h6>
                            <ul>`;

                if (problemData.functionAnalysis.systemComponents && problemData.functionAnalysis.systemComponents.length > 0) {
                    problemData.functionAnalysis.systemComponents.forEach(component => {
                        html += `<li>${component}</li>`;
                    });
                } else {
                    html += `<li><em>No system components defined</em></li>`;
                }

                html += `</ul></div><div class="panel-half" style="flex: 1; min-width: 300px;">
                            <h6>Supersystem Components:</h6>
                            <ul>`;

                if (problemData.functionAnalysis.supersystemComponents && problemData.functionAnalysis.supersystemComponents.length > 0) {
                    problemData.functionAnalysis.supersystemComponents.forEach(component => {
                        html += `<li>${component}</li>`;
                    });
                } else {
                    html += `<li><em>No supersystem components defined</em></li>`;
                }

                html += `</ul></div></div></div>`;

                // Step 3: Interaction Analysis
                html += `<div class="calculation-block" style="margin-bottom: 1rem;">
                    <h5>Step 3: Interaction Analysis</h5>`;

                if (Object.keys(problemData.functionAnalysis.interactions).length > 0) {
                    html += `<p>Components in contact/interaction:</p><ul>`;

                    for (const [interactionId, isChecked] of Object.entries(problemData.functionAnalysis.interactions)) {
                        if (isChecked) {
                            const [component1, component2] = interactionId.split('-');
                            html += `<li>${component1}  ${component2}</li>`;
                        }
                    }

                    html += `</ul>`;
                } else {
                    html += `<p><em>No interactions defined</em></p>`;
                }

                html += `</div>`;

                // Step 4: Functional Analysis (Tabular)
                html += `<div class="calculation-block" style="margin-bottom: 1rem;">
                    <h5>Step 4: Functional Analysis (Tabular)</h5>`;

                if (problemData.functionAnalysis.functions && problemData.functionAnalysis.functions.length > 0) {
                    html += `<div style="overflow-x: auto;">
                        <table class="trends-table">
                            <thead>
                                <tr>
                                    <th>Component (function carrier)</th>
                                    <th>Action (Verb)</th>
                                    <th>Target (Object of the Function)</th>
                                    <th>Category</th>
                                    <th>Performance level</th>
                                    <th>Comment</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    problemData.functionAnalysis.functions.forEach(func => {
                        html += `
                            <tr>
                                <td>${func.carrier}</td>
                                <td>${func.action}</td>
                                <td>${func.target}</td>
                                <td>${func.category === 'useful' ? 'Useful (U)' : 'Harmful (H)'}</td>
                                <td>${func.performance === 'normal' ? 'Normal (N)' : (func.performance === 'insufficient' ? 'Insufficient (I)' : 'Excessive (E)')}</td>
                                <td>${func.comment || ''}</td>
                            </tr>
                        `;
                    });

                    html += `</tbody></table></div>`;
                } else {
                    html += `<p><em>No functions defined</em></p>`;
                }

                html += `</div>`;

                // Step 5: Function Model Diagram
                html += `<div class="calculation-block">
                    <h5>Step 5: Function Model Diagram</h5>
                    <div class="mermaid-container" id="resultsMermaidDiagram">
                        <div class="mermaid">
                            ${generateFunctionDiagramCodeForResults(problemData.functionAnalysis.functions)}
                        </div>
                    </div>
                    
                    <div class="diagram-legend">
                        <h6 class="legend-title">Diagram Legend</h6>
                        <div class="legend-grid">
                            <div class="legend-item">
                                <div class="legend-color-box" style="background: #dceeff; border: 2px solid #82b6ff;"></div>
                                <span>System Component</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color-box" style="background: #ffe6cc; border: 2px solid #d79b00; clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);"></div>
                                <span>Supersystem Component (Hexagon)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color-box" style="background: #ffffcc; border: 2px solid #d6b656; border-radius: 10px;"></div>
                                <span>Target Component (Rounded)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line-sample" style="background: #000; height: 2px;"></div>
                                <span>Useful Function (Normal)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line-sample" style="border: 1px dashed #000; height: 2px;"></div>
                                <span>Useful Function (Insufficient)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line-sample" style="background: #000; height: 3px;"></div>
                                <span>Useful Function (Excessive)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line-sample" style="background: #e74c3c; height: 3px;"></div>
                                <span>Harmful Function</span>
                            </div>
                        </div>
                    </div>
                </div>`;

                html += `</div>`;
            }

            // Technical Contradiction
            if (problemData.technicalContradiction) {
                html += `<div class="solver-step"><h4><i class="fas fa-exchange-alt"></i> Technical Contradiction</h4>`;

                html += `<div class="contradiction-visual">
                    <div class="improving-side">
                        <i class="fas fa-arrow-up improving-icon feature-icon"></i>
                        <h4>Improving</h4>
                        <p>${problemData.technicalContradiction.improvingFeature}</p>
                    </div>
                    <div class="contradiction-arrow">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="worsening-side">
                        <i class="fas fa-arrow-down worsening-icon feature-icon"></i>
                        <h4>Worsening</h4>
                        <p>${problemData.technicalContradiction.worseningFeature}</p>
                    </div>
                </div>`;

                // Matrix Version
                html += `<div class="matrix-version-info" style="margin-bottom: 1rem; padding: 0.5rem; background: #e3f2fd; border-radius: 4px;">
                    <strong>Matrix Version:</strong> ${currentMatrixVersion === 'classic' ? 'Classic TRIZ Matrix (39 parameters)' : '2003 TRIZ Matrix (48 parameters)'}
                </div>`;

                // Recommended Principles
                if (problemData.technicalContradiction.recommendedPrinciples && problemData.technicalContradiction.recommendedPrinciples.length > 0) {
                    html += `<h5>Recommended Inventive Principles:</h5>`;
                    problemData.technicalContradiction.recommendedPrinciples.forEach(p => {
                        html += `
                            <div class="principle-card">
                                <div class="principle-header">
                                    <span class="physical-principle-icon"><i class="fas ${physicalPrincipleIcons[p.id] || 'fa-lightbulb'}"></i></span>
                                    <strong>Principle ${p.id}: ${p.name}</strong>
                                </div>
                                <p>${p.desc}</p>
                                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <strong>Example:</strong> ${p.example || 'Apply this principle to transform your system.'}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>No specific principles are recommended based on the current inputs.</p>';
                }
                html += `</div>`;
            }

            // Physical Contradiction (NUEVO ALGORITMO)
            if (problemData.physicalContradiction) {
                html += `<div class="solver-step"><h4><i class="fas fa-exchange-alt"></i> Physical Contradiction</h4>`;

                html += `<p><strong>Conflict:</strong> The parameter "<em>${problemData.physicalContradiction.conflictingParameter || 'N/A'}</em>" needs opposite states.</p>`;

                if (problemData.physicalContradiction.strategy) {
                    html += `<div class="physical-strategy-guide">
                        <div class="strategy-title">Recommended Strategy: ${problemData.physicalContradiction.strategy}</div>
                        <div class="strategy-description">${getStrategyDescription(problemData.physicalContradiction.strategy)}</div>
                    </div>`;
                }

                // Recommended Principles
                if (problemData.physicalContradiction.recommendedPrinciples && problemData.physicalContradiction.recommendedPrinciples.length > 0) {
                    html += `<h5>Recommended Inventive Principles:</h5>`;
                    problemData.physicalContradiction.recommendedPrinciples.forEach(p => {
                        html += `
                            <div class="principle-card">
                                <div class="principle-header">
                                    <span class="physical-principle-icon"><i class="fas fa-lightbulb"></i></span>
                                    <strong>Principle ${p.id}: ${p.name}</strong>
                                </div>
                                <p>${p.desc}</p>
                                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <strong>Example:</strong> ${p.example || 'Apply this principle to transform your system.'}
                                </div>
                            </div>
                        `;
                    });
                }
                html += `</div>`;
            }

            // Su-Field Analysis
            if (problemData.sufield && problemData.sufield.systems && problemData.sufield.systems.length > 0) {
                html += `<div class="solver-step"><h4><i class="fas fa-atom"></i> Su-Field Analysis & Standard Solutions</h4>`;

                problemData.sufield.systems.forEach((system, index) => {
                    if (system.object || system.tool || system.field) {
                        html += `<div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">`;

                        html += `<h5>System ${index + 1}: ${system.object || 'S1'}  ${system.field || 'F'}  ${system.tool || 'S2'}</h5>`;

                        const problemDiagramId = `problem-diagram-${index}`;
                        const solutionDiagramId = `solution-diagram-${index}`;

                        html += `
                            <div class="solution-transformation">
                                <div class="before-state">
                                    <div id="${problemDiagramId}" class="sufield-diagram-container"></div>
                                    <div class="state-label">Problem State</div>
                                </div>
                                
                                <div class="transition-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                
                                <div class="after-state">
                                    <div id="${solutionDiagramId}" class="sufield-diagram-container"></div>
                                    <div class="state-label">Solution State</div>
                                </div>
                            </div>
                        `;

                        html += `<div style="display: flex; align-items: center; margin-bottom: 1rem;">
                            <i class="fas ${problemTypeIcons[system.type]}" style="font-size: 1.5rem; color: ${problemTypeColors[system.type]}; margin-right: 10px;"></i>
                            <div>
                                <strong>Problem Type:</strong> ${system.type}
                                <p style="margin: 5px 0 0 0;">${system.suggestion}</p>
                            </div>
                        </div>`;

                        if (system.standardSolutions && system.standardSolutions.length > 0) {
                            const solutionsByClass = {};
                            system.standardSolutions.forEach(solution => {
                                if (!solutionsByClass[solution.class]) {
                                    solutionsByClass[solution.class] = [];
                                }
                                solutionsByClass[solution.class].push(solution);
                            });

                            for (const [className, solutions] of Object.entries(solutionsByClass)) {
                                const classIcon = classIcons[className] || 'fa-cube';
                                html += `<div class="standard-solution-visual">`;
                                html += `
                                    <div class="class-header">
                                        <span class="class-icon"><i class="fas ${classIcon}"></i></span>
                                        <h5>${className}</h5>
                                    </div>
                                `;
                                html += `<p>${standardSolutionClasses[className] || 'Standard solutions for this class of problems.'}</p>`;

                                html += `<div class="solution-description">`;
                                html += `<h6>Recommended Standard Solutions:</h6>`;

                                solutions.forEach(solution => {
                                    const solutionIcon = standardSolutionIcons[solution.id] || 'fa-cube';
                                    html += `
                                        <div class="solution-card">
                                            <div class="solution-header">
                                                <span class="standard-solution-icon"><i class="fas ${solutionIcon}"></i></span>
                                                <strong>${solution.id}: ${solution.title}</strong>
                                            </div>
                                            <p>${solution.description}</p>
                                        </div>
                                    `;
                                });

                                html += `</div></div>`;
                            }
                        } else if (typeof getRecommendedStandardSolutions !== 'function') {
                            html += `<p><em>Error: 76principlestriz.js not loaded. Cannot display standard solutions.</em></p>`;
                        } else {
                            html += `<p><em>No standard solutions found for "${system.type}".</em></p>`;
                        }

                        html += `</div>`;
                    }
                });
                html += `</div>`;
            }

            html += `<div class="results-actions"><button class="btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export to Excel</button></div>`;

            resultsDiv.innerHTML = html;
            resultsDiv.classList.remove('hidden');

            // Dibujar diagramas Su-Field - CON LA CORRECCI칍N PARA VALORES POR DEFECTO
            if (problemData.sufield && problemData.sufield.systems) {
                problemData.sufield.systems.forEach((system, index) => {
                    if (system.object || system.tool || system.field) {
                        const problemDiagramId = `problem-diagram-${index}`;
                        const solutionDiagramId = `solution-diagram-${index}`;

                        if (typeof updateProblemDiagramInSolution === 'function') {
                            updateProblemDiagramInSolution(problemDiagramId, {
                                objectText: system.object || 'S1',
                                toolText: system.tool || 'S2',
                                fieldType: system.field || 'Field',
                                problemType: system.type || 'insufficient'
                            });
                        }

                        if (typeof updateSolutionDiagram === 'function') {
                            updateSolutionDiagram(
                                solutionDiagramId,
                                system.object || 'S1',
                                system.tool || 'S2',
                                system.field || 'Field'
                            );
                        }
                    }
                });
            }

            // Renderizar el diagrama Mermaid en resultados
            setTimeout(() => {
                updateMermaidDiagramInResults();
            }, 500);

            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Funci칩n auxiliar para generar c칩digo Mermaid para resultados
        function generateFunctionDiagramCodeForResults(functions) {
            if (!functions || functions.length === 0) {
                return 'graph LR;\n    A[No functions defined]';
            }

            let lines = [];

            // Definir estilos para nodos
            lines.push('    classDef system fill:#dceeff,stroke:#82b6ff,stroke-width:2px;');
            lines.push('    classDef supersystem fill:#ffe6cc,stroke:#d79b00,stroke-width:2px;');
            lines.push('    classDef target fill:#ffffcc,stroke:#d6b656,stroke-width:2px;');

            // Identificar todos los componentes 칰nicos
            const allComponents = new Set();
            functions.forEach(func => {
                allComponents.add(func.carrier);
                allComponents.add(func.target);
            });

            // Determinar tipo de cada componente
            const componentTypes = {};
            const functionAnalysis = problemData.functionAnalysis;
            Array.from(allComponents).forEach(component => {
                if (component === functionAnalysis.targetComponent) {
                    componentTypes[component] = 'target';
                } else if (functionAnalysis.systemComponents && functionAnalysis.systemComponents.includes(component)) {
                    componentTypes[component] = 'system';
                } else {
                    componentTypes[component] = 'supersystem';
                }
            });

            // Crear nodos con formas apropiadas
            Object.entries(componentTypes).forEach(([component, type]) => {
                let shapeStart = '[';
                let shapeEnd = ']';
                let className = 'system';

                if (type === 'supersystem') {
                    shapeStart = '{{';
                    shapeEnd = '}}';
                    className = 'supersystem';
                } else if (type === 'target') {
                    shapeStart = '([';
                    shapeEnd = '])';
                    className = 'target';
                }

                const nodeId = component.replace(/[^a-zA-Z0-9]/g, '_');
                lines.push(`    ${nodeId}${shapeStart}"${component}"${shapeEnd}:::${className}`);
            });

            // Crear aristas (conexiones) con estilos basados en propiedades
            functions.forEach((func, index) => {
                const carrierId = func.carrier.replace(/[^a-zA-Z0-9]/g, '_');
                const targetId = func.target.replace(/[^a-zA-Z0-9]/g, '_');

                let arrow = '-->';
                let linkStyle = '';

                // Determinar estilo de flecha basado en categor칤a y rendimiento
                if (func.category === 'useful') {
                    if (func.performance === 'insufficient') {
                        arrow = '-.->';
                        linkStyle = `linkStyle ${index} stroke-dasharray: 5,5;`;
                    } else if (func.performance === 'excessive') {
                        arrow = '==>';
                        linkStyle = `linkStyle ${index} stroke-width:3px;`;
                    } else {
                        arrow = '-->';
                    }
                } else if (func.category === 'harmful') {
                    arrow = '==>';
                    linkStyle = `linkStyle ${index} stroke:#e74c3c,stroke-width:3px;`;
                }

                // A침adir la arista
                lines.push(`    ${carrierId} ${arrow}|${func.action}| ${targetId}`);

                // A침adir estilo de enlace si est치 especificado
                if (linkStyle) {
                    lines.push(`    ${linkStyle}`);
                }
            });

            return 'graph LR\n' + lines.join('\n');
        }

        function updateMermaidDiagramInResults() {
            if (!problemData.functionAnalysis || !problemData.functionAnalysis.functions || problemData.functionAnalysis.functions.length === 0) {
                return;
            }

            const code = generateFunctionDiagramCodeForResults(problemData.functionAnalysis.functions);
            const container = document.getElementById('resultsMermaidDiagram');

            if (!container) return;

            // Clear container and render new diagram
            container.innerHTML = `<div class="mermaid">${code}</div>`;

            // Reinitialize Mermaid with the new diagram
            if (typeof mermaid !== 'undefined') {
                try {
                    // Cancel any pending render
                    if (window.mermaidTimeout) {
                        clearTimeout(window.mermaidTimeout);
                    }

                    // Render with a small delay to asegurar que el DOM est칠 listo
                    window.mermaidTimeout = setTimeout(() => {
                        mermaid.init({
                            startOnLoad: false,
                            theme: 'default',
                            securityLevel: 'loose',
                            flowchart: {
                                useMaxWidth: true,
                                htmlLabels: true,
                                curve: 'basis'
                            }
                        }, container.querySelectorAll('.mermaid'));
                    }, 100);
                } catch (error) {
                    console.error('Mermaid rendering error in results:', error);
                }
            }
        }

        function exportToExcel() {
            if (Object.keys(problemData).length === 0) {
                alert("No data to export. Please solve a problem first.");
                return;
            }

            const wb = XLSX.utils.book_new();
            const ws_data = [];

            ws_data.push(["TRIZ Problem Solving Report"]);
            ws_data.push(["Company: Sigma Exacta"]);
            ws_data.push([`Date: ${new Date().toLocaleDateString()}`]);
            ws_data.push([`Matrix Version: ${currentMatrixVersion === 'classic' ? 'Classic (39 parameters)' : '2003 (48 parameters)'}`]);
            ws_data.push([]);

            // LDST
            ws_data.push(["Laws of Development of Technical Systems (LDST)"]);
            ws_data.push(["Life Cycle Stage", document.getElementById('lifecycle-stage').options[document.getElementById('lifecycle-stage').selectedIndex].text]);
            ws_data.push(["Recommended Laws"]);
            if (problemData.ldst && problemData.ldst.recommendedLaws) {
                problemData.ldst.recommendedLaws.forEach(law => {
                    ws_data.push(["", law.name]);
                    ws_data.push(["", "Related Principles", law.principles.join(', ')]);
                });
            }
            ws_data.push([]);

            ws_data.push(["Problem Definition"]);
            ws_data.push(["System/Object", problemData.system]);
            ws_data.push(["Primary Function", problemData.function]);
            ws_data.push(["Main Drawback", problemData.harm]);
            ws_data.push([]);
            ws_data.push(["Ideal Final Result (IFR)"]);
            ws_data.push([problemData.ifr]);
            ws_data.push([]);

            // 9 Windows
            ws_data.push(["9 Windows Analysis"]);
            ws_data.push(["Super-System Past", problemData.nineWindows.superPast]);
            ws_data.push(["Super-System Present", problemData.nineWindows.superPresent]);
            ws_data.push(["Super-System Future", problemData.nineWindows.superFuture]);
            ws_data.push(["System Past", problemData.nineWindows.systemPast]);
            ws_data.push(["System Present", problemData.nineWindows.systemPresent]);
            ws_data.push(["System Future", problemData.nineWindows.systemFuture]);
            ws_data.push(["Sub-System Past", problemData.nineWindows.subPast]);
            ws_data.push(["Sub-System Present", problemData.nineWindows.subPresent]);
            ws_data.push(["Sub-System Future", problemData.nineWindows.subFuture]);
            ws_data.push([]);

            // Function Analysis
            if (problemData.functionAnalysis) {
                ws_data.push(["Function Analysis"]);
                ws_data.push(["Main Function", problemData.functionAnalysis.mainFunction]);
                ws_data.push(["Target Component", problemData.functionAnalysis.targetComponent]);
                ws_data.push([]);

                ws_data.push(["System Components"]);
                problemData.functionAnalysis.systemComponents.forEach(component => {
                    ws_data.push(["", component]);
                });
                ws_data.push([]);

                ws_data.push(["Supersystem Components"]);
                problemData.functionAnalysis.supersystemComponents.forEach(component => {
                    ws_data.push(["", component]);
                });
                ws_data.push([]);

                ws_data.push(["Functions"]);
                ws_data.push(["Component", "Action", "Target", "Category", "Performance", "Comment"]);
                problemData.functionAnalysis.functions.forEach(func => {
                    ws_data.push([func.carrier, func.action, func.target, func.category === 'useful' ? 'Useful' : 'Harmful',
                    func.performance === 'normal' ? 'Normal' : (func.performance === 'insufficient' ? 'Insufficient' : 'Excessive'),
                    func.comment || '']);
                });
                ws_data.push([]);
            }

            // Technical Contradiction
            if (problemData.technicalContradiction) {
                ws_data.push(["Technical Contradiction"]);
                ws_data.push(["Type", "Technical Contradiction"]);
                ws_data.push(["Improving Feature", problemData.technicalContradiction.improvingFeature]);
                ws_data.push(["Worsening Feature", problemData.technicalContradiction.worseningFeature]);

                if (problemData.technicalContradiction.recommendedPrinciples && problemData.technicalContradiction.recommendedPrinciples.length > 0) {
                    ws_data.push(["Recommended Inventive Principles (from Technical Contradiction)"]);
                    ws_data.push(["Principle ID", "Name", "Description"]);
                    problemData.technicalContradiction.recommendedPrinciples.forEach(p => {
                        ws_data.push([`Principle ${p.id}`, p.name, p.desc]);
                    });
                }
                ws_data.push([]);
            }

            // Physical Contradiction (NUEVO ALGORITMO)
            if (problemData.physicalContradiction) {
                ws_data.push(["Physical Contradiction"]);
                ws_data.push(["Type", "Physical Contradiction"]);
                ws_data.push(["Conflicting Parameter", problemData.physicalContradiction.conflictingParameter]);
                ws_data.push(["Intersection Test", problemData.physicalContradiction.intersectionTest]);
                ws_data.push(["Separation Type", problemData.physicalContradiction.separationType]);
                ws_data.push(["Recommended Strategy", problemData.physicalContradiction.strategy]);

                if (problemData.physicalContradiction.recommendedPrinciples && problemData.physicalContradiction.recommendedPrinciples.length > 0) {
                    ws_data.push(["Recommended Inventive Principles (from Physical Contradiction)"]);
                    ws_data.push(["Principle ID", "Name", "Description"]);
                    problemData.physicalContradiction.recommendedPrinciples.forEach(p => {
                        ws_data.push([`Principle ${p.id}`, p.name, p.desc]);
                    });
                }
                ws_data.push([]);
            }

            // Su-Field Analysis
            ws_data.push(["Su-Field Analysis"]);

            if (problemData.sufield && problemData.sufield.systems && problemData.sufield.systems.length > 0) {
                problemData.sufield.systems.forEach((system, index) => {
                    if (system.object || system.tool || system.field) {
                        ws_data.push([]);
                        ws_data.push([`System ${index + 1}`]);
                        ws_data.push(["Object (S1)", system.object]);
                        ws_data.push(["Tool (S2)", system.tool]);
                        ws_data.push(["Field (F)", system.field]);
                        ws_data.push(["Problem Type", system.type]);
                        ws_data.push(["Suggestion", system.suggestion.replace(/<[^>]*>?/gm, '')]);

                        if (system.standardSolutions && system.standardSolutions.length > 0) {
                            ws_data.push(["Recommended Standard Solutions"]);
                            ws_data.push(["Solution ID", "Title", "Description"]);
                            system.standardSolutions.forEach(solution => {
                                ws_data.push([solution.id, solution.title, solution.description]);
                            });
                        }
                    }
                });
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [{ wch: 25 }, { wch: 60 }, { wch: 80 }];
            XLSX.utils.book_append_sheet(wb, ws, "TRIZ Report");
            const dateStr = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `TRIZ_Report_Sigma_Exacta_${dateStr}.xlsx`);
        }

        function getStrategyDescription(strategy) {
            const descriptions = {
                "Separation in Space or Time": "The two opposite demands occur in different places or at different times. Use separation in space or time principles.",
                "Satisfy through physical-chemical changes": "The demands are contiguous (touch at a boundary). Use physical or chemical changes to satisfy both demands.",
                "Separation in Relation (Condition)": "The demands are for different systems or users. Separate by condition or perspective.",
                "Separation in System Level": "The whole system has one property while its parts have the opposite. Separate by system hierarchy.",
                "Bypass contradictory demands (System Transition)": "The demands completely overlap and cannot be separated. Consider a system transition or bypass."
            };
            return descriptions[strategy] || "";
        }

        function getPhysicalContradictionExample(relationship) {
            const examples = {
                separationInSpace: "A surgical scalpel needs to be sharp to cut tissue but blunt to not damage surrounding organs. Solution: Use a retractable scalpel that is sharp when extended and protected when retracted.",
                separationInTime: "An airplane wing needs to be large for takeoff/landing but small for cruising efficiency. Solution: Use retractable flaps and slats.",
                separationInRelation: "A coffee cup needs to be hot to keep coffee warm but cool to hold. Solution: Use a handle made of insulating material.",
                separationInSystemLevel: "Traffic light with segmented pole elements for easy repair, separating maintenance requirements at different system levels.",
                satisfyContradictoryDemands: "Heat packs using phase transition of gel to provide warmth without external heat source, satisfying both heating and portability demands.",
                bypassContradictoryDemands: "Digital clocks replacing mechanical clockwork, bypassing the need for mechanical timekeeping altogether."
            };
            return examples[relationship] || "Apply separation principles to resolve the contradiction.";
        }
    </script>
</body>

</html>